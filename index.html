<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">






<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1">






<meta name="description" content="Why join the navy if you can be a pirate?">
<meta property="og:type" content="website">
<meta property="og:title" content="Cherry Blessing">
<meta property="og:url" content="https://blessingsoft.com/index.html">
<meta property="og:site_name" content="Cherry Blessing">
<meta property="og:description" content="Why join the navy if you can be a pirate?">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cherry Blessing">
<meta name="twitter:description" content="Why join the navy if you can be a pirate?">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blessingsoft.com/">





  <title>Cherry Blessing</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Cherry Blessing</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">A monad is a monoid in the category of endofunctors</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2022/07/16/silgen-name/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/07/16/silgen-name/" itemprop="url">_silgen_name</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-07-16T20:00:00+08:00">
                2022-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-swift/" itemprop="url" rel="index">
                    <span itemprop="name">advanced swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>åœ¨è®¾è®¡ <code>Router</code> ç»„ä»¶çš„æ—¶å€™ï¼Œå…¶ä¸­å¿…ä¸å¯å°‘çš„ä¸€æ­¥æ˜¯è·¯ç”±æ³¨å†Œï¼Œå°† <code>pattern</code> å’Œ <code>handler</code> å‡½æ•°è¿›è¡Œç»‘å®šã€‚</p>
</blockquote>
<h2 id="ä½¿ç”¨-silgen-name-æ¥è¿›è¡Œæ³¨å†Œ"><a href="#ä½¿ç”¨-silgen-name-æ¥è¿›è¡Œæ³¨å†Œ" class="headerlink" title="ä½¿ç”¨ @_silgen_name æ¥è¿›è¡Œæ³¨å†Œ"></a>ä½¿ç”¨ @_silgen_name æ¥è¿›è¡Œæ³¨å†Œ</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@_silgen_name(<span class="string">"/user"</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">user</span><span class="params">(context: Context)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><h3 id="ä»€ä¹ˆæ˜¯-silgen-name"><a href="#ä»€ä¹ˆæ˜¯-silgen-name" class="headerlink" title="ä»€ä¹ˆæ˜¯ @silgen_name"></a>ä»€ä¹ˆæ˜¯ @silgen_name</h3><p>æ ¹æ® Swift çš„å®˜æ–¹æ‰‹å†Œï¼Œ<code>@silgen_name</code> æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<blockquote>
<ol>
<li>To specify the symbol name of a Swift function so that it can be called from Swift-aware C. Such functions have bodies.</li>
<li><p>To provide a Swift declaration which really represents a C declaration. Such functions do not have bodies.</p>
<p><a href="https://github.com/apple/swift/blob/main/docs/StandardLibraryProgrammersManual.md#_silgen_name" target="_blank" rel="noopener">swift/StandardLibraryProgrammersManual.md at main Â· apple/swift Â· GitHub</a></p>
</li>
</ol>
</blockquote>
<p>æ‰€ä»¥å¯ä»¥åˆ©ç”¨ç¬¬2ä¸ªç‰¹æ€§ç»™ <code>handler</code> å‡½æ•°æŒ‡å®šä¸€ä¸ªå¯¼å‡ºå‡½æ•°ç¬¦å· <code>Exported Symbols</code>ï¼Œç„¶åé€šè¿‡å°† <code>pattern</code> ä½œä¸ºå¯¼å‡ºç¬¦å·å³å¯ç»‘å®šå¯¹åº”çš„ <code>handler</code> å‡½æ•°ã€‚</p>
<p>åŒæ—¶ä¸ºäº†é¿å…ä¸å…¶å®ƒå¯¼å‡ºç¬¦å·å†²çªå¹¶ä¸”æé«˜æŸ¥æ‰¾çš„æ•ˆç‡ï¼Œå¯ä»¥ç»™å¯¼å‡ºç¬¦å·åŠ ä¸€ä¸ªçº¦å®šçš„å‰ç¼€ï¼Œå¦‚ <code>ditto:</code>ã€‚</p>
<h3 id="æ³¨å†Œ"><a href="#æ³¨å†Œ" class="headerlink" title="æ³¨å†Œ"></a>æ³¨å†Œ</h3><p>è¿è¡Œæ—¶åˆ©ç”¨ <code>_dyld_register_func_for_add_image()</code> æ¥ç›‘å¬æ‰€æœ‰çš„ <code>image</code> åŠ è½½ï¼Œç„¶åéå†å¸¦ç‰¹å®šå‰ç¼€çš„å¯¼å‡ºå‡½æ•°ç¬¦å·ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_dyld_register_func_for_add_image &#123; image, slide <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> mhp = image?.withMemoryRebound(to: <span class="type">MachHeader</span>.<span class="keyword">self</span>, capacity: <span class="number">1</span>, &#123; $<span class="number">0</span> &#125;)</span><br><span class="line">    <span class="keyword">let</span> symbols = getDyldRouteSymbols(<span class="keyword">prefix</span>: <span class="string">"ditto:"</span>, image: mhp!, slide: slide)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åé€šè¿‡ <code>unsafeBitCast(_:to:)</code> å‡½æ•°å°†å‡½æ•°ç¬¦å·è½¬ä¸º <code>handler</code> å‡½æ•°è¿›è¡Œæ³¨å†Œã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> routes: [(<span class="type">String</span>, <span class="type">Route</span>&lt;<span class="type">Coordinator</span>&gt;.<span class="type">Handler</span>)] = symbols</span><br><span class="line">    .<span class="built_in">filter</span> &#123; $<span class="number">0</span>.key.hasPrefix(<span class="string">"ditto:"</span>) &#125;</span><br><span class="line">    .<span class="built_in">map</span> &#123; (<span class="type">String</span>($<span class="number">0</span>.key.<span class="built_in">dropFirst</span>(<span class="string">"ditto:"</span>.<span class="built_in">count</span>)), <span class="built_in">unsafeBitCast</span>($<span class="number">0</span>.value, to: <span class="type">Handler</span>.<span class="keyword">self</span>)) &#125;</span><br><span class="line"><span class="keyword">try</span>? register(routes)</span><br></pre></td></tr></table></figure>
<h2 id="è¿›é˜¶"><a href="#è¿›é˜¶" class="headerlink" title="è¿›é˜¶"></a>è¿›é˜¶</h2><p><a href="https://github.com/xspyhack/Ditto" target="_blank" rel="noopener">Ditto</a> åœ¨è®¾è®¡ä¹‹åˆä¾¿æ”¯æŒèŒƒå‹ï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ª <code>Router</code>ï¼ˆè™½ç„¶æ²¡å¤ªå¿…è¦ï¼‰ã€‚</p>
<h3 id="èŒƒå‹"><a href="#èŒƒå‹" class="headerlink" title="èŒƒå‹"></a>èŒƒå‹</h3><p><code>_dyld_register_func_for_add_image()</code> æ˜¯ä¸€ä¸ª <code>C</code> å‡½æ•°ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _dyld_register_func_for_add_image(<span class="keyword">void</span> (*func)(<span class="keyword">const</span> struct mach_header* mh, <span class="keyword">intptr_t</span> vmaddr_slide));</span><br></pre></td></tr></table></figure>
<p>å›è°ƒå‡½æ•°å¹¶ä¸åŒäºä¸€èˆ¬çš„ <code>closure</code>ï¼Œå®ƒä¸èƒ½æ•è·ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š<code>A C function pointer cannot be formed from a closure that captures context</code>ã€‚æ‰€ä»¥å¯¹äºæ”¯æŒèŒƒå‹çš„ <code>Router</code> æ¥è¯´ï¼Œå°±ä¸èƒ½ç›´æ¥çš„è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨è¿‡ä¸€äº›å…¶ä»–æ‰‹æ®µå…ˆæŠŠéå†åˆ°çš„å‡½æ•°ç¬¦å·å…ˆå­˜èµ·æ¥ï¼Œå†é‡æ–°è¯»å–å‡ºæ¥å³å¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SIL</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> symbols: [<span class="type">UnsafeMutableRawPointer?</span>] = []</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">SIL</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">install</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _dyld_register_func_for_add_image &#123; image, slide <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> mhp = image?.withMemoryRebound(to: <span class="type">MachHeader</span>.<span class="keyword">self</span>, capacity: <span class="number">1</span>, &#123; $<span class="number">0</span> &#125;)</span><br><span class="line">            <span class="keyword">let</span> symbols = getDyldRouteSymbols(image: mhp!, slide: slide)</span><br><span class="line">            <span class="type">SIL</span>.shared.symbols.append(contentsOf: symbols)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Router</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Handler</span> = <span class="meta">@convention</span>(thin) (<span class="type">Context</span>&lt;<span class="type">Coordinator</span>&gt;) -&gt; <span class="type">Bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">register</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">SIL</span>.install()</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="keyword">self</span>.register(symbols: <span class="type">SIL</span>.shared.symbols)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">register</span><span class="params">(symbols: [UnsafeMutableRawPointer?])</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> routes: [(<span class="type">String</span>, <span class="type">Route</span>&lt;<span class="type">Coordinator</span>&gt;.<span class="type">Handler</span>)] = symbols</span><br><span class="line">            .<span class="built_in">map</span> &#123; (<span class="type">String</span>($<span class="number">0</span>.key), <span class="built_in">unsafeBitCast</span>($<span class="number">0</span>.value, to: <span class="type">Handler</span>.<span class="keyword">self</span>)) &#125;</span><br><span class="line">        <span class="keyword">try</span>? register(routes)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¨¡å—åŒ–"><a href="#æ¨¡å—åŒ–" class="headerlink" title="æ¨¡å—åŒ–"></a>æ¨¡å—åŒ–</h3><p>å‡å¦‚åŒæ—¶å­˜åœ¨å¤šä¸ª <code>Router</code> çš„è¯ï¼Œé‚£ä¹ˆåªé  <code>pattern</code> æ— æ³•åŒºåˆ†è¦æ³¨å†Œåˆ°å“ªä¸€ä¸ªã€‚åŒæ—¶ç”±äº <code>_dyld_register_func_for_add_image()</code> å‡½æ•°æ— æ³•æ•è·ä¸Šä¸‹æ–‡ï¼Œä¹Ÿæ— æ³•ä¼ é€’æŒ‡å®šçš„ <code>silgen_name</code> å‰ç¼€æ¥è¿›è¡Œåˆ†å¼€éå†ã€‚</p>
<p>ä¸€ä¸ªå¯è¡Œä½†å¹¶ä¸ä¼˜é›…çš„æ–¹æ³•ä¾ç„¶æ˜¯åœ¨ <code>silgen_name</code> çš„å‘½åä¸­åšæ–‡ç« ï¼Œå¦‚çº¦å®šç‰¹æ®Šçš„å‰ç¼€æ¥è¿›è¡ŒåŒºåˆ†ã€‚</p>
<p>å¦‚æœä¸åŒçš„ <code>Router</code> æ˜¯åœ¨ä¸åŒçš„æ¨¡å—ä¸­ï¼ˆ<code>module</code>ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡éå†æŒ‡å®šçš„ <code>image</code> ï¼ˆé€šè¿‡ <code>_dyld_get_image_name()</code> æ–¹æ³•ï¼‰æ¥æ³¨å†Œå½“å‰æ¨¡å—çš„ç¬¦å·ã€‚</p>
<p><a href="https://github.com/apple/swift/blob/main/docs/StandardLibraryProgrammersManual.md#_silgen_name" target="_blank" rel="noopener">swift/StandardLibraryProgrammersManual.md</a><br><a href="https://forums.swift.org/t/should-anyone-be-using-silgen-name-outside-of-the-standard-library-developers/19396/23" target="_blank" rel="noopener">Should anyone be using @_silgen_name outside of the standard library developers?</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2022/01/01/some-any/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/01/01/some-any/" itemprop="url">some P and any P</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-01-01T20:00:00+08:00">
                2022-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-swift/" itemprop="url" rel="index">
                    <span itemprop="name">advanced swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li><code>some</code> æ˜¯å¦ä¸€ç§ç‰¹æ®Šçš„ <code>generic</code>ï¼ˆç¬¦åˆè¦æ±‚çš„æœªçŸ¥ä½†å…·ä½“çš„ç±»å‹ï¼‰ã€‚å®ƒçš„ç›®çš„æ˜¯ç”¨æ¥å¯¹å¤æ‚çš„ç±»å‹è¿›è¡ŒæŠ½è±¡ï¼Œç±»å‹çš„ä¿¡æ¯ä¸ä¼šè¢«æ“¦é™¤ã€‚</li>
<li><code>any</code> å…¶å®æ˜¯æ˜¾å¼çš„å£°æ˜ <code>existential</code>ã€‚å®ƒçš„ç›®çš„æ˜¯ç”¨æ¥å¯¹å€¼è¿›è¡ŒæŠ½è±¡ï¼Œç±»å‹ä¿¡æ¯ä¼šè¢« compiler æ“¦é™¤ã€‚</li>
</ul>
<h2 id="some-Protocol"><a href="#some-Protocol" class="headerlink" title="some Protocol"></a>some Protocol</h2><p>å†™è¿‡ SwiftUI çš„äººå¯¹äº <code>some</code> éƒ½ä¸é™Œç”Ÿï¼Œæ¯ä¸€ä¸ª <code>View</code> çš„ <code>body</code> çš„ç±»å‹éƒ½æ˜¯ <code>some View</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> body: some <span class="type">View</span> &#123;</span><br><span class="line">    <span class="type">Text</span>(<span class="string">"Hello World"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆéœ€è¦å¼•è¿›ä¸€ä¸ªæ–°çš„å…³é”®è¯ <code>some</code>ï¼Œä¸èƒ½ç›´æ¥å†™ <code>var body: View { ... }</code>ï¼ŸåŸå› æ˜¯ <code>View</code> è¿™ä¸ªåè®®æ˜¯ç»å…¸çš„ <em>PAT</em>ï¼Œå¯¹å°±æ˜¯é‚£ä¸ªä¸‡æ¶ä¹‹æº <a href="https://blessingsoft.com/2018/08/26/pats/">PAT</a> ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Body</span> : <span class="type">View</span></span><br><span class="line">    <span class="keyword">var</span> body: <span class="type">Self</span>.<span class="type">Body</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº <code>PAT</code> ä¸èƒ½ç›´æ¥çš„æŠŠ <code>View</code> å½“ä½œä¸€ä¸ªç±»å‹æ¥ä½¿ç”¨ï¼Œ<code>Protocol â€˜Viewâ€™ can only be used as generic constraint because it has Self or associated type requirements</code>ã€‚<code>View</code> è¿™ä¸ª <code>PAT</code> æ²¡æ³•è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <a href="https://blessingsoft.com/2019/06/05/existential/">Existential</a>ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å†™ <code>var body: View { ... }</code>ï¼Œå¿…é¡»æ˜ç¡®æŒ‡å®š <code>View</code> çš„å…·ä½“ç±»å‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>&#123;</span><br><span class="line">  <span class="comment">// typealias Body = Text</span></span><br><span class="line">  <span class="keyword">var</span> body: <span class="type">Text</span> &#123;</span><br><span class="line">    <span class="type">Text</span>(<span class="string">"Hello World"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜ç¡® <code>Body</code> çš„å…·ä½“ç±»å‹ï¼Œæœ‰åŠ©äºæ­ç¤º <code>ContentView</code> çš„éƒ¨åˆ†å®ç°ï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—å£°æ˜å˜å¾—è„†å¼±ã€‚å¦‚æœæƒ³æ”¹å˜ <code>body</code> çš„è¿”å›ç±»å‹ï¼Œå¿…é¡»åŒæ—¶ä¿®æ”¹å¯¹åº”çš„ç±»å‹ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œå…·ä½“çš„ <code>body</code> è¿”å›ç±»å‹å…¶å®å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å®ƒç¬¦åˆ <code>View</code> åè®®ï¼Œå®ƒæ˜¯ä¸€ä¸ª <code>View</code>ã€‚è¿™æ—¶å€™å¦‚æœæƒ³è¦æŠ½è±¡å‡ºå£°æ˜çš„è¿”å›å€¼ç±»å‹ï¼Œå°±å¿…é¡»è¦è€ƒè™‘ <code>existential</code> æˆ–è€… <code>type erasure</code>ã€‚</p>
<p>åŸºäºè¿™ä¸€ç‚¹ï¼ŒSwift 5.1 ä¸­å¼•å…¥äº† <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0244-opaque-result-types.md" target="_blank" rel="noopener">SE-0244 opaque result types</a> è¿™ä¸€ç‰¹æ€§ã€‚<code>some Protocol</code> è¡¨ç¤ºä¸€ä¸ªç¡®å®šçš„å®ç°äº† <code>Protocol</code> åè®®çš„ç±»å‹ã€‚åŒæ—¶å®ƒè¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼Œå°±æ˜¯ <code>some</code> ä¿®é¥° return type çš„æ—¶å€™ï¼Œè¦æ±‚æ‰€æœ‰çš„ return è¯­å¥è¿”å›ç›¸åŒçš„å…·ä½“ç±»å‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">P</span> </span>&#123; &#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span> : <span class="title">P</span> </span>&#123; &#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">String</span> : <span class="title">P</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(flip: Bool)</span></span> -&gt; some <span class="type">P</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> flip &#123; <span class="keyword">return</span> <span class="number">17</span> &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"a string"</span> <span class="comment">// error: different return types Int and String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸€ä¸ªæ”¯æŒèŒƒå‹çš„è¯­è¨€ä¸­ï¼Œæƒ³ä½¿ç”¨ <code>PAT</code> åˆä¸éœ€è¦æŒ‡å®šå…·ä½“çš„ç±»å‹å¯¹äºç¼–å†™ç®€æ´ä»£ç éå¸¸é‡è¦ã€‚è€ƒè™‘ä¸€ä¸‹åµŒå¥—çš„èŒƒå‹ï¼Œå¦‚ SwiftUI ä¸­é‚£äº› View çš„ body çš„çœŸå®ç±»å‹ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œ<code>some</code> åªæ˜¯åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™å¸®åŠ©æˆ‘ä»¬è¿›è¡Œäº†ç®€åŒ–ï¼Œç±»å‹ä¿¡æ¯ä¾ç„¶å­˜åœ¨ï¼Œ<code>SwiftUI</code> éå¸¸ä¾èµ–è¿™äº›ä¿¡æ¯è¿›è¡Œ View çš„æ›´æ–°ã€‚</p>
</blockquote>
<h2 id="any-Protocol"><a href="#any-Protocol" class="headerlink" title="any Protocol"></a>any Protocol</h2><p>Swift ä¸­æƒ³è¦æŠŠä¸€ä¸ª <code>Protocol</code> ä½œä¸ºä¸€ä¸ªç±»å‹æ¥ç”¨ï¼Œè¦æ±‚è¿™ä¸ª <code>Protocol</code> å¿…é¡»ä¸èƒ½æ˜¯ <code>PAT</code>ï¼Œå¦åˆ™çš„è¯å°±ä¼šæŠ¥é”™ <code>Protocol can only be used as generic constraint because it has Self or associated type requirements</code>ã€‚ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼ŒSwift å¼•å…¥äº† <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0309-unlock-existential-types-for-all-protocols.md" target="_blank" rel="noopener">SE-0309 unlock existential types for all protocols</a>ï¼Œcompiler å¸®å¿™è‡ªåŠ¨çš„è¿›è¡Œ <code>type erasure</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Logging</span>: <span class="title">Hashtable</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="comment">// -func add(_ logger: AnyLogger) &#123;</span></span><br><span class="line"><span class="comment">// after, ğŸ™‚ï¸ OK</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> logger: Logging)</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œ<code>PAT</code> çš„ä½¿ç”¨æˆæœ¬å¤§å¤§çš„é™ä½ï¼Œå®ç”¨æ€§å¤§å¤§æå‡ã€‚ç»ˆäºå¯ä»¥åƒä½¿ç”¨èŒƒå‹é‚£æ ·çš„ä½¿ç”¨ <code>PAT</code> äº†ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> logger: Logging)</span></span> &#123; ... &#125; <span class="comment">// existential type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span>&lt;T: Logging&gt;<span class="params">(<span class="number">_</span> logger: T)</span></span> &#123; ... &#125; <span class="comment">// generic type</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logger: <span class="type">MemoryLogger</span></span><br><span class="line">add(logger)</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ <code>generic type</code> å’Œ <code>existential type</code> å§‹ç»ˆæ˜¯ä¸åŒçš„ä¸œè¥¿ï¼Œå‰è€…æ˜¯ <code>type-level abstraction</code> è€Œåè€…æ˜¯ <code>value-level abstraction</code>ï¼Œå‰è€…å¼ºè°ƒçš„æ˜¯ç±»å‹ä»¥åŠç±»å‹ä¹‹é—´çš„å…³ç³»ï¼Œåè€…å…³å¿ƒçš„æ˜¯å€¼ï¼Œç±»å‹ä¿¡æ¯è¢« compiler å¸®å¿™æŠ¹é™¤æ‰ã€‚</p>
<p>ä¸ºäº†ä»è¯­æ³•ä¸ŠåŒºåˆ†å¼€ä¸¤è€…ï¼ŒSwift åˆå¼•å…¥äº† <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0335-existential-any.md" target="_blank" rel="noopener">SE-0335 existential any</a>ï¼Œ<code>existential type</code> å¿…é¡»é€šè¿‡ <code>any</code> å…³é”®è¯è¿›è¡Œæ˜¾å¼å£°æ˜ ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> logger: <span class="type">Logging</span> = <span class="type">MemoryLogger</span>() <span class="comment">// before</span></span><br><span class="line"><span class="keyword">let</span> logger: any <span class="type">Logging</span> = <span class="type">MemoryLogger</span>() <span class="comment">// after</span></span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œç»ˆäºå¯ä»¥ä¸€è‡´çš„å¯¹å¾… Swift ä¸­çš„æ‰€æœ‰ protocol äº†ï¼Œè€Œä¸éœ€è¦åŒºåˆ«å®ƒæ˜¯ä¸æ˜¯ PATã€‚</p>
<h2 id="Type-level-and-value-level-abstraction"><a href="#Type-level-and-value-level-abstraction" class="headerlink" title="Type-level and value-level abstraction"></a>Type-level and value-level abstraction</h2><p>è¦æ·±å…¥äº†è§£ <code>some</code> å’Œ <code>any</code>ï¼Œè¿˜æ˜¯è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯ <code>type-level abstraction</code> å’Œ <code>value-level abstraction</code> ã€‚</p>
<h3 id="Type-level-abstraction"><a href="#Type-level-abstraction" class="headerlink" title="Type-level abstraction"></a>Type-level abstraction</h3><p>Genericsï¼ˆèŒƒå‹ï¼‰æä¾›äº†ç±»å‹å±‚é¢ä¸Šçš„æŠ½è±¡ï¼ŒèŒƒå‹å…è®¸å‡½æ•°æˆ–è€…ç±»å‹ä¸ç¬¦åˆç»™å®šçº¦æŸé›†çš„ä»»ä½•ç±»å‹ç»Ÿä¸€ä½¿ç”¨ï¼ŒåŒæ—¶ä¿ç•™äº†åœ¨ä»»ä½•ç‰¹å®šå®ä¾‹ä¸­ä½¿ç”¨çš„ç‰¹å®šç±»å‹çš„æ ‡è¯†ã€‚æ³›å‹å‡½æ•°å¼•å…¥äº†ä»£è¡¨ç‰¹å®šç±»å‹çš„ç±»å‹å˜é‡ï¼ˆtype variablesï¼Œæ„Ÿè§‰æ›´å¤šæ—¶å€™è¢«å«åšç±»å‹å‚æ•°ï¼Ÿï¼‰ã€‚ è¿™å…è®¸å‡½æ•°å£°æ˜å®ƒæ¥å—ä»»ä½•ç¬¦åˆåè®®çš„å€¼ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">foo</span>&lt;T: Collection&gt;<span class="params">(x: T)</span></span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>ç±»å‹å˜é‡ <code>T</code> åœ¨ç±»å‹å±‚é¢ä¸ŠæŠ½è±¡å‡ºç‰¹å®šçš„ <code>Collection</code> ç±»å‹ã€‚å…·ä½“çš„ç±»å‹æ ‡è¯†ä»ç„¶ä¿ç•™ç€ï¼Œå› æ­¤ç±»å‹ç³»ç»Ÿå¯ä»¥ä¿ç•™ä¸åŒå€¼ä¹‹é—´çš„ç±»å‹å…³ç³»ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bar</span>&lt;T: Collection&gt;<span class="params">(x: T, y: T)</span></span> -&gt; [<span class="type">T</span>] &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Value-level-abstraction"><a href="#Value-level-abstraction" class="headerlink" title="Value-level abstraction"></a>Value-level abstraction</h3><p>Existential ç±»å‹æä¾›äº†å€¼å±‚é¢ä¸Šçš„æŠ½è±¡ã€‚ä¸ç»‘å®šä¸€äº›ç¬¦åˆçº¦æŸçš„ç°æœ‰ç±»å‹çš„æ³›å‹ç±»å‹å‚æ•°ç›¸æ¯”ï¼Œexistential ç±»å‹æ˜¯ä¸€ç§ä¸åŒçš„ç±»å‹ï¼Œå®ƒå¯ä»¥ä¿å­˜ç¬¦åˆä¸€ç»„çº¦æŸçš„ä»»ä½•ç±»å‹çš„ä»»ä½•å€¼ï¼Œåœ¨å€¼å±‚é¢ä¸ŠæŠ½è±¡åº•å±‚çš„å…·ä½“ç±»å‹ã€‚Existentials å…è®¸ä¸åŒçš„å…·ä½“ç±»å‹çš„å€¼ä½œä¸ºç›¸åŒçš„å­˜åœ¨ç±»å‹çš„å€¼äº’æ¢ä½¿ç”¨ï¼Œåœ¨å€¼å±‚é¢ä¸ŠæŠ½è±¡äº†åº•å±‚ç¬¦åˆç±»å‹ä¹‹é—´çš„å·®å¼‚ã€‚åŒä¸€ä¸ª existential ç±»å‹çš„ä¸åŒå®ä¾‹å¯ä»¥æŒæœ‰å®Œå…¨ä¸åŒçš„åº•å±‚ç±»å‹çš„å€¼ï¼Œå¹¶ä¸”æ”¹å˜ä¸€ä¸ª existential ç±»å‹å¯ä»¥æ”¹å˜è¯¥å€¼æ‰€æŒæœ‰çš„åº•å±‚ç±»å‹ã€‚</p>
<h3 id="Type-level-abstraction-is-missing-for-function-returns"><a href="#Type-level-abstraction-is-missing-for-function-returns" class="headerlink" title="Type-level abstraction is missing for function returns"></a>Type-level abstraction is missing for function returns</h3><p>æ³›å‹æ˜¯ Swift åœ¨å‡½æ•°æ¥å£ä¸­è¿›è¡Œç±»å‹å±‚é¢çš„æŠ½è±¡çš„å·¥å…·ï¼Œä½†å®ƒä»¬çš„å·¥ä½œæ–¹å¼åŸºæœ¬ä¸Šåœ¨è°ƒç”¨è€…çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œä¹Ÿå°±æ˜¯è¯´å…·ä½“ç±»å‹ç”±è°ƒç”¨æ–¹æ¥å†³å®šã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">zim</span>&lt;T: P&gt;<span class="params">()</span></span> -&gt; <span class="type">T</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº <code>zim</code> è¿™ä¸ªèŒƒå‹å‡½æ•°ï¼Œå…·ä½“è¿”å›çš„ç±»å‹ <code>T</code>ï¼Œæ˜¯ç”±è°ƒç”¨æ–¹æ¥å†³å®šï¼Œå®ç°æ–¹ï¼ˆcalleeï¼‰åªå£°æ˜äº†å®ƒå¿…é¡»è¦æ»¡è¶³ <code>P</code> çº¦æŸã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x: <span class="type">Int</span> = zim() <span class="comment">// T == Int chosen by caller</span></span><br><span class="line"><span class="keyword">let</span> y: <span class="type">String</span> = zim() <span class="comment">// T == String chosen by caller</span></span><br></pre></td></tr></table></figure>
<h3 id="â€œReverse-genericsâ€-for-return-type-abstraction"><a href="#â€œReverse-genericsâ€-for-return-type-abstraction" class="headerlink" title="â€œReverse genericsâ€ for return type abstraction"></a>â€œReverse genericsâ€ for return type abstraction</h3><p>ä½†æœ‰æ—¶å€™ï¼Œå®ç°æ–¹çœŸæ­£å¸Œæœ›çš„ <code>zim</code> å‡½æ•°æ˜¯å®ƒè¿”å›ä¸€ä¸ª <code>P</code> ç±»å‹ï¼Œä½†å…·ä½“æ˜¯ <code>Int</code> è¿˜æ˜¯ <code>String</code> ç”±å®ç°æ–¹æ¥å†³å®šã€‚è¿™ç‚¹ä¸æ™®é€šçš„èŒƒå‹åˆšåˆšç›¸åï¼Œå¯ä»¥è®¤ä¸ºæ˜¯åå‘çš„èŒƒå‹ï¼ˆ<code>reverse generics</code>ï¼‰ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">zim</span><span class="params">()</span></span> -&gt; <span class="type">P</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶çš„ <code>P</code> ä¸å†æ˜¯ç”¨æ¥ä½œä¸ºèŒƒå‹çº¦æŸï¼Œ<code>zim</code> å‡½æ•°è¿”å›çš„å€¼æ˜¯ä¸€ä¸ª existentialã€‚ </p>
<h3 id="Expressing-constraints-directly-on-arguments-and-returns"><a href="#Expressing-constraints-directly-on-arguments-and-returns" class="headerlink" title="Expressing constraints directly on arguments and returns"></a>Expressing constraints directly on arguments and returns</h3><p>ä¸ºäº†å®Œå–„ Swift çš„ç±»å‹æŠ½è±¡ç³»ç»Ÿï¼Œæå‡ºäº†ä½¿ç”¨ <code>some</code> è¿™ä¸ªä¿®é¥°ç¬¦æ¥å¯¹å‚æ•°å’Œè¿”å›å€¼è¡¨è¾¾çº¦æŸï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ <code>existential</code> ç±»å‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concatenate</span><span class="params">(a: some Collection, b: some Collection)</span></span> -&gt; some <span class="type">Collection</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>ç”šè‡³å¯ä»¥ä½¿ç”¨ <code>where</code> æ¥è¡¨è¾¾å®ƒä»¬ç›´æ¥çš„ç±»å‹å…³ç³»ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concatenate</span><span class="params">(a: some Collection, b: some Collection)</span></span> -&gt; some <span class="type">Collection</span></span><br><span class="line">  <span class="keyword">where</span> type(of: a).<span class="type">Element</span> == type(of: b).<span class="type">Element</span>,</span><br><span class="line">        type(of: <span class="keyword">return</span>).<span class="type">Element</span> == type(of: b).<span class="type">Element</span></span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><ul>
<li><code>some</code> æ˜¯å¦ä¸€ç§ç‰¹æ®Šçš„ <code>generic</code>ï¼ˆç¬¦åˆè¦æ±‚çš„æœªçŸ¥ä½†å…·ä½“çš„ç±»å‹ï¼‰ã€‚å®ƒçš„ç›®çš„æ˜¯ç”¨æ¥å¯¹å¤æ‚çš„ç±»å‹è¿›è¡ŒæŠ½è±¡ï¼Œç±»å‹çš„ä¿¡æ¯ä¸ä¼šè¢«æ“¦é™¤ã€‚</li>
<li><code>any</code> å…¶å®æ˜¯æ˜¾å¼çš„å£°æ˜ <code>existential</code>ã€‚å®ƒçš„ç›®çš„æ˜¯ç”¨æ¥å¯¹å€¼è¿›è¡ŒæŠ½è±¡ï¼Œç±»å‹ä¿¡æ¯ä¼šè¢« compiler æ“¦é™¤ã€‚</li>
</ul>
<p><code>some</code> å’Œ <code>any</code> æ˜¯å¯¹å¶çš„ï¼ˆ<code>duals</code>ï¼‰ä¸¤ä¸ªä¿®é¥°è¯ï¼Œå®ƒä»¬éƒ½è§£å†³äº† <code>PAT</code> æ‰€å¸¦æ¥çš„ä¸€äº›ä¸æ–¹ä¾¿çš„é—®é¢˜ã€‚ç›®å‰ Swift åªæ”¯æŒä½¿ç”¨ <code>some</code> æ¥ä¿®é¥°è¿”å›å€¼ï¼Œè€Œ <code>any</code> çš„ä½¿ç”¨åœºæ™¯åˆ™æ¯”è¾ƒå¤šã€‚</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0244-opaque-result-types.md" target="_blank" rel="noopener">swift-evolution/0244-opaque-result-types.md at master Â· apple/swift-evolution Â· GitHub</a><br><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0309-unlock-existential-types-for-all-protocols.md" target="_blank" rel="noopener">swift-evolution/0309-unlock-existential-types-for-all-protocols.md at main Â· apple/swift-evolution Â· GitHub</a><br><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0335-existential-any.md" target="_blank" rel="noopener">swift-evolution/0335-existential-any.md at main Â· apple/swift-evolution Â· GitHub</a><br><a href="https://forums.swift.org/t/improving-the-ui-of-generics/22814#heading--clarifying-existentials" target="_blank" rel="noopener">Improving the UI of generics - Discussion - Swift Forums</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2020/04/25/http-chunked-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/25/http-chunked-2/" itemprop="url">HTTP Streaming/Chunked 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-04-25T20:00:00+08:00">
                2020-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/networking/" itemprop="url" rel="index">
                    <span itemprop="name">networking</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>ä¸€ä¸ªéå¸¸æ‚²ä¼¤çš„æ¶ˆæ¯æ˜¯ï¼Œ<code>Azure</code> å’Œ <code>Cocoa</code> çš„é…åˆè¿˜æ˜¯å‡ºäº†é—®é¢˜ï¼ŒåŸå› å‡ºåœ¨ <code>chunk</code> çš„å®ç°ä¸Šã€‚è¿™ä¸ªé”…åº”è¯¥ç”± <code>Cocoa</code> æ¥èƒŒï¼Œ<code>HTTP/1.1</code> ç»™å‡ºçš„ <code>chunk</code> çš„æ ¼å¼ä¸­ï¼Œæ¯ä¸€ä¸ª <code>chunk</code> çš„ç»“å°¾åº”è¯¥æ˜¯ <code>CRLF</code>ï¼Œè€Œ <code>Cocoa</code> çš„å®ç°ï¼ˆå¯èƒ½æ˜¯ä¸ºäº†å®ç°ä¸Šçš„æ–¹ä¾¿ï¼‰æŠŠè¿™ä¸ª <code>CRLF</code> æ”¾åœ¨äº†ä¸‹ä¸€ä¸ª <code>chunk</code> çš„å¼€å¤´ã€‚å¯¹äºè¿ç»­çš„ <code>chunk</code> æ¥è¯´çœ‹èµ·å¥½åƒæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª <code>chunk</code> æ¥å»ºç«‹è¿æ¥ï¼Œå»ºç«‹å®Œæˆä¹‹åæ‰ä¼šå‘ä¿¡ä»¤çš„ <code>chunk</code>ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª <code>chunk</code> å’Œåç»­çš„ <code>chunk</code> ä¸ä¼šè¿ç»­ã€‚ç„¶è€Œ <code>Azure</code> åœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ª <code>chunk</code> åï¼Œå‘ç°ç»“å°¾è¿˜æ²¡æœ‰æ”¶åˆ° <code>CRLF</code>ï¼ˆè™½ç„¶æ­¤æ—¶å·²ç»æ”¶åˆ°äº†æ­£ç¡®é•¿åº¦çš„æ•°æ®ï¼‰ï¼Œç„¶åè¿›å…¥ç»§ç»­ç­‰å¾…çŠ¶æ€ï¼Œä¸ä¼šæŠŠæ•°æ®åŒ…è½¬å‘ç»™åå°æ•°æ®æœåŠ¡å™¨ï¼Œè¿™æ ·åå°æ•°æ®æœåŠ¡å™¨å°±æ²¡æ³•å’Œ <code>downlink</code> åŒ¹é…å¹¶ä¸”å»ºç«‹è¿æ¥ã€‚</p>
<h2 id="Chunked-Transfer-Encoding"><a href="#Chunked-Transfer-Encoding" class="headerlink" title="Chunked Transfer Encoding"></a>Chunked Transfer Encoding</h2><p>é¦–å…ˆæ ¹æ® <code>HTTP/1.1</code> çš„ <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html" target="_blank" rel="noopener">RFC</a> å¯¹äº <code>Chunked Transfer Encoding</code> è§„å®šã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Chunked-Body</span>   <span class="string">=</span> <span class="meta">*chunk</span></span><br><span class="line">                <span class="string">last-chunk</span></span><br><span class="line">                <span class="string">trailer</span></span><br><span class="line">                <span class="string">CRLF</span></span><br><span class="line"><span class="string">chunk</span>          <span class="string">=</span> <span class="string">chunk-size</span> <span class="string">[</span> <span class="string">chunk-extension</span> <span class="string">]</span> <span class="string">CRLF</span></span><br><span class="line">                <span class="string">chunk-data</span> <span class="string">CRLF</span></span><br><span class="line"><span class="string">chunk-size</span>     <span class="string">=</span> <span class="number">1</span><span class="meta">*HEX</span></span><br><span class="line"><span class="string">last-chunk</span>     <span class="string">=</span> <span class="number">1</span><span class="string">*("0")</span> <span class="string">[</span> <span class="string">chunk-extension</span> <span class="string">]</span> <span class="string">CRLF</span></span><br><span class="line"><span class="string">chunk-extension=</span> <span class="string">*(</span> <span class="string">";"</span> <span class="string">chunk-ext-name</span> <span class="string">[</span> <span class="string">"="</span> <span class="string">chunk-ext-val</span> <span class="string">]</span> <span class="string">)</span></span><br><span class="line"><span class="string">chunk-ext-name</span> <span class="string">=</span> <span class="string">token</span></span><br><span class="line"><span class="string">chunk-ext-val</span>  <span class="string">=</span> <span class="string">token</span> <span class="string">|</span> <span class="string">quoted-string</span></span><br><span class="line"><span class="string">chunk-data</span>     <span class="string">=</span> <span class="string">chunk-size(OCTET)</span></span><br><span class="line"><span class="string">trailer</span>        <span class="string">=</span> <span class="string">*(entity-header</span> <span class="string">CRLF)</span></span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹éƒ¨åˆ†ä¸º <code>chunk</code> çš„æ ¼å¼ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ª <code>chunk</code> åº”è¯¥ç”±ä¸€ä¸ª 16 è¿›åˆ¶çš„ <code>chunk-size</code> å¼€å§‹ï¼Œç„¶åæ¥ç€ä¸€ä¸ª <code>CRLF</code>ï¼Œç„¶åæ˜¯ <code>chunk-data</code>ï¼Œæœ«å°¾æ˜¯ä¸€ä¸ª <code>CRLF</code>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">chunk</span>          <span class="string">=</span> <span class="string">chunk-size</span> <span class="string">[</span> <span class="string">chunk-extension</span> <span class="string">]</span> <span class="string">CRLF</span></span><br><span class="line">                <span class="string">chunk-data</span> <span class="string">CRLF</span></span><br></pre></td></tr></table></figure>
<p>å†çœ‹ <code>Cocoa</code> çš„å®ç° <a href="https://opensource.apple.com/source/CFNetwork/CFNetwork-128.2/HTTP/CFHTTPFilter.c.auto.html" target="_blank" rel="noopener">CFHTTPFilter.c</a>ï¼Œè™½ç„¶å®ƒåœ¨æºç é‡Œé¢ä¹Ÿè´´äº†ä¸Šè¾¹ <code>RFC</code> ä¸­çš„ç»“æ„ï¼Œå¯æ˜¯å®ƒçš„å®ç°ä¸­å¹¶ä¸é‚£ä¹ˆå›äº‹ã€‚çœ‹ç¬¬ä¸€è¡Œæ³¨é‡Šå°±æš´éœ²äº†å®ƒçš„æ¯ä¸ª <code>chunk header</code> ä¸­é™¤äº† <code>first chunk</code> ä¹‹å¤–ï¼Œå…¶ä»–çš„éƒ½ä¼šå‡ºç°ä¸¤ä¸ª <code>CRLF</code>ï¼Œå…¶ä¸­ä¸€ä¸ªå«åš <code>leading CRLF</code>ï¼Œä¹Ÿå°±æ˜¯å¼€å¤´è¯´çš„ï¼Œå®ƒæ˜¯åœ¨ä¸‹ä¸€ä¸ª <code>chunk</code> çš„å¤´éƒ¨ï¼Œæ’å…¥ä¸€ä¸ª <code>CRLF</code>ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFIndex &lt;= uint64 so no more than 16 characters to encode + 2 for CRLF + 2 for leading CRLF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_CHUNK_HEADER_SIZE (20)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> sendChunkHeader(<span class="built_in">CFWriteStreamRef</span> stream, <span class="built_in">CFIndex</span> chunkLength, Boolean firstChunk, <span class="built_in">CFStreamError</span> *error) &#123;</span><br><span class="line">    <span class="comment">// hex representation of chunkLength, followed by CRLF</span></span><br><span class="line">    <span class="built_in">UInt8</span> writeBuffer[MAX_CHUNK_HEADER_SIZE];</span><br><span class="line">    <span class="built_in">UInt8</span> *writeBase;</span><br><span class="line">    <span class="built_in">CFIndex</span> bytesWritten;</span><br><span class="line">    error-&gt;error = <span class="number">0</span>;</span><br><span class="line">    writeBuffer[MAX_CHUNK_HEADER_SIZE - <span class="number">1</span>] = <span class="string">'\n'</span>;</span><br><span class="line">    writeBuffer[MAX_CHUNK_HEADER_SIZE - <span class="number">2</span>] = <span class="string">'\r'</span>;</span><br><span class="line">    writeBase = &amp;(writeBuffer[MAX_CHUNK_HEADER_SIZE<span class="number">-3</span>]); </span><br><span class="line">    <span class="keyword">while</span> (chunkLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextDigit = chunkLength &amp; <span class="number">0xF</span>;</span><br><span class="line">        *writeBase = nextDigit &lt; <span class="number">10</span> ? <span class="string">'0'</span> + nextDigit : <span class="string">'A'</span> + nextDigit - <span class="number">10</span>;</span><br><span class="line">        writeBase --;</span><br><span class="line">        chunkLength = chunkLength &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (firstChunk) &#123;</span><br><span class="line">        writeBase ++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *writeBase = <span class="string">'\n'</span>;</span><br><span class="line">        writeBase --;</span><br><span class="line">        *writeBase = <span class="string">'\r'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (writeBase &lt; writeBuffer + MAX_CHUNK_HEADER_SIZE) &#123;</span><br><span class="line">        bytesWritten = <span class="built_in">CFWriteStreamWrite</span>(stream, writeBase, writeBuffer + MAX_CHUNK_HEADER_SIZE - writeBase);</span><br><span class="line">        <span class="keyword">if</span> (bytesWritten &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            *error = <span class="built_in">CFWriteStreamGetError</span>(stream);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytesWritten == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Premature EOF; can we come up with a better error code?</span></span><br><span class="line">            error-&gt;domain = kCFStreamErrorDomainHTTP;</span><br><span class="line">            error-&gt;error = kCFStreamErrorHTTPParseFailure;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            writeBase += bytesWritten;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆç†çš„æ ·å­æ˜¯</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">7</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">Chunk_1\r\n</span></span><br><span class="line"><span class="number">7</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">Chunk_2\r\n</span></span><br></pre></td></tr></table></figure>
<p>è€Œ <code>Cocoa</code> æ˜¯è¿™æ ·å­çš„</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">7</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">Chunk_1</span></span><br><span class="line"><span class="string">\r\n</span></span><br><span class="line"><span class="number">7</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">Chunk_2</span></span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>æ—¢ç„¶ <code>Cocoa</code> çš„å®ç°ä¸ç¬¦åˆ <code>Azure</code> çš„è¦æ±‚ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•æ¥ <strong>ç»•è¿‡</strong> ä¸€ä¸‹å‘¢ï¼Ÿæ—¢èƒ½è®© <code>Azure</code> è½¬å‘ç¬¬ä¸€ä¸ª <code>chunk</code>ï¼Œä¹Ÿèƒ½è®©åç«¯æ•°æ®æœåŠ¡å™¨æ­£ç¡®è¯†åˆ«ã€‚</p>
<h3 id="è‡ªå·±æ·»åŠ ä¸€ä¸ª-CRLF"><a href="#è‡ªå·±æ·»åŠ ä¸€ä¸ª-CRLF" class="headerlink" title="è‡ªå·±æ·»åŠ ä¸€ä¸ª CRLF"></a>è‡ªå·±æ·»åŠ ä¸€ä¸ª CRLF</h3><p>æ—¢ç„¶ <code>Azure</code> ä¼šç­‰å¾… <code>CRLF</code>ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ª <code>chunk</code> ç»“å°¾å¤šåŠ ä¸€ä¸ª <code>CRLF</code> è¡Œä¸è¡Œï¼Ÿè‚¯å®šä¸è¡Œï¼Œå› ä¸º <code>CRLF</code> æ˜¯ä¸ç®—åœ¨ <code>chunk-size</code> é‡Œé¢çš„ã€‚å¹¶ä¸”ä¼šå¯¼è‡´ä¸‹ä¸€ä¸ª <code>chunk</code> åˆ°æ¥çš„æ—¶å€™ï¼Œå‡ºç°è¿ç»­çš„ <code>CRLFCRLF</code>ï¼Œè™½ç„¶æŒ‰è¦æ±‚æœ€åä¸€ä¸ª <code>chunk</code> æ˜¯ <code>0CRLFCRLF</code>ï¼Œä½†æœ‰äº›æœåŠ¡å™¨ä¼šå…¼å®¹åªæœ‰ <code>CRLFCRLF</code> çš„æƒ…å†µã€‚</p>
<h3 id="å¤šå‘ä¸€ä¸ª-chunk"><a href="#å¤šå‘ä¸€ä¸ª-chunk" class="headerlink" title="å¤šå‘ä¸€ä¸ª chunk"></a>å¤šå‘ä¸€ä¸ª chunk</h3><p>ä¸èƒ½å¤šåŠ ä¸€ä¸ª <code>CRLF</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å»ºç«‹ <code>name_channel</code> çš„æ—¶å€™ï¼Œå¤šå‘ä¸€ä¸ª <code>chunk</code>ï¼Œé‚£ä¹ˆ <code>Azure</code> æ”¶åˆ°çš„æ•°æ®å°†ä¼šæ˜¯è¿™æ ·çš„ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">C\r\n</span></span><br><span class="line"><span class="string">name_channel</span></span><br><span class="line"></span><br><span class="line"><span class="string">\r\n</span></span><br><span class="line"><span class="number">2</span><span class="string">\r\n</span></span><br><span class="line"><span class="string">OK</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ ¼å¼æ˜¯ä¸ºäº†æ–¹ä¾¿åŒºåˆ†ä¸¤ä¸ª <code>chunk</code>ï¼Œå…¶å®çœŸæ­£çš„æ•°æ®æ˜¯æ²¡æœ‰æ¢è¡Œçš„ï¼Œå› ä¸ºå·²ç»æŠŠ <code>\r\n</code> å†™å‡ºæ¥äº†ã€‚æ¢ä¸€ä¸ªå†™æ³•ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">C\r\nname_channel\r\n2\r\nOK</span></span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ <code>Azure</code> æ”¶åˆ°è¿™æ ·çš„æ•°æ®åŒ…ä¹‹åï¼Œå°±ä¼šè®¤ä¸ºç¬¬ä¸€ä¸ª <code>chunk</code> ï¼ˆ<code>C\r\nname_channel\r\n</code>ï¼‰å·²ç»å®Œæ•´æ”¶åˆ°äº†ï¼Œä½†ç¬¬äºŒä¸ª <code>chunk</code> è¿˜éœ€è¦ç­‰å¾…æœ€åçš„ <code>CRLF</code>ã€‚è¿™æ—¶ <code>Azure</code> å°±ä¼šå°† <code>name_channel</code> è¿™ä¸ª <code>chunk</code> è½¬å‘ç»™åå°æœåŠ¡å™¨ï¼Œç„¶åå°±èƒ½æ­£å¸¸çš„å»ºç«‹èµ·è¿æ¥äº†ã€‚å½“ç„¶åå¤©æœåŠ¡å™¨éœ€è¦å¤„ç†å¤šå‘çš„é‚£ä¸ªåŒ…ã€‚</p>
<p>åç»­ä¿¡ä»¤çš„ <code>chunk</code> è¿˜éœ€ä¸éœ€è¦æ¯æ¬¡éƒ½å¤šå‘ä¸€ä¸ª <code>chunk</code>ï¼Ÿåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ä¸éœ€è¦ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œå› ä¸ºåç»­çš„ä¿¡ä»¤ï¼Œæ˜¯æºæºä¸æ–­çš„å‘é€å‡ºå»çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°ç­‰å¾…ä¸‹ä¸€ä¸ªåŒ…çš„æƒ…å†µã€‚å³ä½¿æ˜¯ç”¨æˆ·æ²¡æœ‰æ“ä½œäº†ï¼Œé‚£ä¹ˆä¹Ÿä¼šæœ‰å¿ƒè·³åŒ…ï¼Œå’Œ <code>ack</code> çš„åŒ…ï¼Œå”¯ä¸€å½±å“çš„æ˜¯åå°æœåŠ¡å™¨æ”¶åˆ°æœ€åä¸€ä¸ª <code>ack</code> åŒ…çš„æ—¶é—´é—´éš”ä¼šé•¿ä¸€ç‚¹ã€‚</p>
<h3 id="libcurl"><a href="#libcurl" class="headerlink" title="libcurl"></a>libcurl</h3><p>è¿™ä¸ªæ–¹æ¡ˆå¾ˆç®€å•ï¼Œå› ä¸º <code>libcurl</code> çš„å®ç°ï¼Œæ˜¯è·Ÿæˆ‘ä»¬é¢„æƒ³ä¸­çš„é‚£æ ·çš„ï¼Œæ¯ä¸ª <code>chunk</code> ç»“å°¾éƒ½æ˜¯ä¸€ä¸ª <code>CRLF</code>ã€‚</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>A å’Œ B åœ¨ä¸€èµ·æ²¡é—®é¢˜ï¼ŒB å’Œ C åœ¨ä¸€èµ·æ²¡é—®é¢˜ï¼ŒC å’Œ A åœ¨ä¸€èµ·ä¹Ÿæ²¡é—®é¢˜ï¼Œä½†å½“ A å’Œ C åœ¨ä¸€èµ·çš„æ—¶å€™ï¼Œå‡ºç°äº†é—®é¢˜ï¼Œå¹¶ä¸èƒ½è¯´æ˜è¿™æ˜¯ A çš„é—®é¢˜æˆ–è€…è¯´æ˜¯ C çš„é—®é¢˜ã€‚</p>
<p>åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œä¸Šé¢å¤šå‘ä¸€ä¸ª <code>chunk</code> çš„æ–¹å¼æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚ä½†æ˜¯å½“éƒ¨ç½²åˆ°çº¿ä¸Šç¯å¢ƒæ—¶ï¼Œé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œåå°æœåŠ¡å™¨ä¾ç„¶æ”¶ä¸åˆ°è¯·æ±‚åŒ…ã€‚é™¤äº†ä¸€ä¸ªæ˜¯ <code>http</code> ä¸€ä¸ªæ˜¯ <code>https</code> ä¹‹å¤–ï¼Œå„ç§é…ç½®å®Œå…¨ä¸€æ ·ï¼Œ<code>Azure CDN</code> æ²¡æ³•è°ƒè¯•ä¹Ÿæ²¡æœ‰æ—¥å¿—å¯ä»¥æ‰“ï¼Œè¿™ä¸ªé—®é¢˜æš‚æ—¶æ²¡æœ‰åŠæ³•è§£å†³ã€‚</p>
<p>ç»æœ›ä¹‹ä½™ï¼Œæˆ‘çœ‹åˆ°äº†ä¸€ç§å«åš <a href="https://en.wikipedia.org/wiki/HTTP_request_smuggling" target="_blank" rel="noopener">HTTP request smuggling - Wikipedia</a> çš„æ”»å‡»æ‰‹æ®µï¼Œèƒ½ç»™ç»•è¿‡ <code>Azure</code> ä¸èƒ½è½¬å‘çš„é—®é¢˜ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2020/04/15/http-chunked/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/15/http-chunked/" itemprop="url">HTTP Streaming/Chunked</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-04-15T20:00:00+08:00">
                2020-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/networking/" itemprop="url" rel="index">
                    <span itemprop="name">networking</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>ä½¿ç”¨ <code>Cocoa Foundation</code> æ¡†æ¶æ¥å®ç° <code>HTTP Streaming/Chunked</code> çš„æ—¶å€™ï¼Œåº•å±‚ä¼šå°†è®¾ç½®çš„ <code>Transfer-Encoding: chunked</code> çš„å€¼æ”¹æˆå¤§å†™çš„ <code>Chunked</code> å‘å‡ºå»ï¼Œå¦‚æœåç«¯ä¸æ”¯æŒï¼Œé‚£ä¹ˆå¿…é¡»é€šè¿‡æ¯”å¦‚ <code>hook</code> çš„æ–¹å¼ä¸è®©åº•å±‚å¯¹è¿™ä¸ªå€¼è¿›è¡Œä¿®æ”¹å¹¶å‘é€å‡ºå»ã€‚å…¶æ¬¡å°±æ˜¯å¦‚æœæœåŠ¡å™¨å·²ç»è¿”å›äº†æ•°æ®ä½†æ˜¯æ¡†æ¶æ²¡æœ‰ç»™ä»»ä½•å›è°ƒï¼Œå¯èƒ½æ˜¯å› ä¸ºæœåŠ¡å™¨è¿”å›çš„ <code>Content-Type</code> ä¸º <code>text/html</code>ï¼Œå¯¼è‡´æ¡†æ¶ç­‰å¾… <code>first 512 bytes</code> æ•°æ®ï¼Œæ”¹ç”¨å…¶ä»–çš„ç±»å‹å³å¯ã€‚</p>
<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æä¾›å…¨çƒæœåŠ¡çš„èƒ½éŸ³è§†é¢‘é€šè¯çš„ IM äº§å“ï¼Œå¤§å¤šæ•°éƒ½æ˜¯ä»¥ <strong>è‡ªå®šä¹‰ä¿¡ä»¤</strong> ä¸ºåŸºç¡€æ¥æå‡ç½‘ç»œæ€§é€šä¿¡èƒ½ä»¥åŠé˜²æ­¢è¢«å°ç¦ã€‚</p>
<p>å¸¸è§çš„å‡ ç§é€šä¿¡æ–¹å¼æœ‰ï¼š</p>
<ul>
<li>IP/Port (TCP)</li>
<li>TLS (TLS Resumption or TLS Verify)</li>
<li>GCM (FCM)</li>
<li>WebSocket</li>
<li>HTTP Persistent Connection</li>
</ul>
<p>å‰é¢å‡ ç§éƒ½æ˜¯å…¶å®éƒ½æ˜¯é€šè¿‡ <code>IP/Port</code> çš„æ–¹å¼æ¥å»ºç«‹è¿æ¥ï¼Œé‚£ä¹ˆä¸€æ—¦ IP è¢«å°ç¦äº†ï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡å…¶ä»–æ‰‹æ®µä¸‹å‘ IP åœ°å€ç„¶åä¸æ–­çš„æ›´æ¢ IP æ¥ç»•è¿‡ã€‚ <code>GCM</code>(<a href="https://firebase.google.com/docs/cloud-messaging/" target="_blank" rel="noopener">FCM</a>) æ˜¯è°·æ­Œæä¾›çš„ä¿¡ä»¤é€šé“ã€‚<code>WebSocket</code> éœ€è¦æœåŠ¡å™¨çš„æ”¯æŒï¼Œ<code>Nginx</code> å’Œ <code>Amazon Cloudfront</code> æ˜¯æ”¯æŒçš„ï¼Œä½†æ˜¯ <code>Azure</code> å’Œ <code>Azure Domain Fronting</code> ä¸æ”¯æŒã€‚æ‰€ä»¥æœ€è¿‘ä¸ºäº†è¿›ä¸€æ­¥å®Œå–„ç½‘ç»œé€šä¿¡çš„å»ºè®¾ï¼Œå†³å®šå¢åŠ  HTTP é•¿é“¾æ¥çš„é€šé“ä½œä¸ºå€™è¡¥ã€‚</p>
<h2 id="HTTP-Persistent-Connection"><a href="#HTTP-Persistent-Connection" class="headerlink" title="HTTP Persistent Connection"></a>HTTP Persistent Connection</h2><p>HTTP Persistent Connection ä¹Ÿå« HTTP Connection Reuse æˆ–è€…å…¶ä»–çš„ Keep Alive ç­‰ã€‚åƒ IM ç±»å‹åº”ç”¨ï¼Œå¦‚æœæ¯ä¸€æ¬¡é€šä¿¡éƒ½ä½¿ç”¨æ™®é€šçš„ HTTP(s) çš„è¯ï¼Œé‚£ä¹ˆç”±äºæ¯æ¬¡å»ºç«‹ TCP éƒ½éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œå¤–åŠ ä¸Š SSL/TLS æ¡æ‰‹ï¼Œå¯èƒ½éœ€è¦ 10+ ä¸ª RTTï¼Œè¿™å¯¹äº IM æ¥è¯´æ˜¯éš¾ä»¥æ¥å—çš„ã€‚ä¼˜åŒ–çš„æ–¹å‘ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯å°½é‡é¿å… HTTPS å»ºç«‹å’Œå…³é—­æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œæœ€å¥½å°±æ˜¯æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œåªå»ºç«‹ä¸€æ¬¡å…³é—­ä¸€æ¬¡ã€‚</p>
<p>HTTP 1.1 ä¸­é»˜è®¤ä½¿ç”¨ <code>Keep-Alive</code> ï¼Œæ¥è¾¾åˆ°è¿æ¥å¤ç”¨ï¼Œä½†ä»…ä»…æ˜¯è¿™ä¸ªå¯¹äº IM åº”ç”¨æ¥è¯´ï¼Œè¿˜æ˜¯å¤ªæ‰è¥Ÿè§è‚˜äº†ã€‚ç„¶åå¯¹æ¯” <code>Long Poll</code> çš„æ–¹å¼ï¼Œæ˜¾ç„¶ <code>Streaming</code> çš„æ–¹å¼æ€§èƒ½ä¼šæ›´åŠ å¥½ã€‚</p>
<blockquote>
<p>HTTP 2.0 ä¹Ÿç”±äºæœåŠ¡å™¨ä¸æ”¯æŒçš„åŸå› ï¼Œæš‚æ—¶ä¸å¯è¡Œã€‚</p>
</blockquote>
<h2 id="Streaming-Chunked"><a href="#Streaming-Chunked" class="headerlink" title="Streaming/Chunked"></a>Streaming/Chunked</h2><p>HTTP 1.1 ä¸­æ”¯æŒäº† chunked message ï¼ˆè§ <a href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="noopener">Chunked transfer encoding - Wikipedia</a>ï¼‰ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ chunked çš„æ–¹å¼ï¼Œæ¥é¿å…é‡å¤å»ºç«‹è¿æ¥ã€‚</p>
<p>ç½‘ç»œè¯·æ±‚åŒ…å«äº†ä¸Šè¡Œå’Œä¸‹è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç ”äº†ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ol>
<li>åˆ©ç”¨ä¸€æ¡ URL åŒæ—¶ä¸Šä¸‹è¡Œ chunked æ•°æ®ï¼Œå‘ç° <code>cloudfront</code> æ˜¯æ”¯æŒçš„ï¼Œä½† <code>Azure</code> ä¸æ”¯æŒã€‚Azure cdn åœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ªä¸‹è¡ŒåŒ…æ—¶ï¼Œä¼šåœ¨ä¸Šè¡ŒåŒ…ä¸­æ’å…¥ chunked ç»“æŸç¬¦ï¼Œå¹¶ä¸å†è½¬å‘ä¸Šè¡ŒåŒ…ï¼Œä½†ä¸‹è¡ŒåŒ…ä»ç„¶ä¼šè¢«è½¬å‘åˆ°å®¢æˆ·ç«¯ã€‚âŒ</li>
<li>åˆ©ç”¨ä¸¤æ¡ URL æ¥å®ç°ï¼Œä¸€æ¡sç”¨äºå‘é€ä¿¡ä»¤ï¼Œä¸€æ¡ç”¨äºè¯»å–ä¿¡ä»¤ã€‚âœ…</li>
</ol>
<h3 id="How-to"><a href="#How-to" class="headerlink" title="How to"></a>How to</h3><p>æ—¢ç„¶æ˜¯ HTTP åè®®ï¼Œé‚£ä¹ˆé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨ <code>Foundation</code> ä¸­çš„ <code>URLSession</code> æ¥å®ç°ã€‚ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å…ˆæŠŠä¸Šè¡Œçš„ URL å«åš <code>uplink</code> ï¼Œä¸‹è¡Œä¸“ç”¨çš„ URL  å«åš <code>downlink</code>ã€‚</p>
<p>é¦–å…ˆæŒ‰ç…§ <code>HTTP 1.1</code> çš„æ ‡å‡†ï¼Œå°† <code>uplink</code> çš„è¯·æ±‚å¤´ <code>Transfer-Encoding</code> è®¾ä¸º <code>chunked</code>ã€‚ä¸ºäº†èƒ½ç»™å¼‚æ­¥æŒç»­çš„å°†ä¿¡ä»¤æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ï¼Œéœ€è¦åˆ©ç”¨ <code>Bound Pair Stream</code>ï¼Œå°† <code>InputStream</code> è¿ä¸Š <code>httpBody</code>ï¼Œç„¶åæŒæœ‰ <code>OutputStream</code>ï¼Œæ¯æ¬¡æœ‰æ•°æ®éœ€è¦å‘é€çš„æ—¶å€™ï¼Œå°±å°†æ•°æ®ä» <code>OutputStream</code> å†™å…¥ï¼Œç„¶åæ•°æ®å°±ä¼šæµåˆ° <code>InputStream</code> å»ï¼Œ<code>URLSession</code> å°±ä¼šä¸æ–­çš„è¯»å–æ•°æ®å¹¶å‘é€åˆ°æœåŠ¡å™¨ã€‚</p>
<p>è‡³äº <code>downlink</code>ï¼Œåªéœ€è¦æœåŠ¡å™¨åœ¨ response çš„æ—¶å€™ï¼Œå°† <code>Transfer-Encoding</code> è®¾ä¸º <code>chunked</code> å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>delegate</code> æ–¹æ³• <code>func urlSession(_:dataTask:didReceive:)</code> æºæºä¸æ–­çš„è¯»å–ä¸‹è¡Œæ•°æ®ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œåç«¯è¿˜éœ€è¦å¯¹ <code>uplink</code> å’Œ <code>downlink</code> è¿›è¡Œé…å¯¹ï¼Œè¿›è¡Œå¯†é’¥äº¤æ¢ç­‰æ­¥éª¤ã€‚æˆåŠŸä¹‹åæ‰èƒ½å¤Ÿå¼€å§‹å‘é€å’Œæ¥æ”¶æ™®é€šçš„ä¿¡ä»¤æ¶ˆæ¯ã€‚ä¸¾ä¾‹æ¯”å¦‚æˆ‘ä»¬é…å¯¹çš„æ­¥éª¤å«åš <code>name channel</code>ï¼Œé¦–å…ˆæ˜¯ <code>uplink</code> å‘é€ç¬¬ä¸€ä¸ª <code>name channel</code> çš„åŒ…ï¼Œå°†åŠ å¯†æ–¹å¼ã€å¯†é’¥å’Œ <code>Connection ID</code> ç­‰å‘é€ç»™æœåŠ¡å™¨ï¼Œç„¶åè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ç„¶å <code>downlink</code> å‘èµ·è¯·æ±‚ï¼Œå°† <code>name channel</code> çš„æ•°æ®å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨é€šè¿‡å¯¹æ¯” <code>Connection ID</code> é…å¯¹æˆåŠŸåï¼Œé€šè¿‡ <code>downlink</code> è¿”å›ç¬¬ä¸€ä¸ªåŒ…ï¼Œé€šçŸ¥å®¢æˆ·ç«¯å·²ç»è¿æ¥å»ºç«‹å®Œæˆï¼Œåç»­å¯ä»¥å¼€å§‹å‘é€æ™®é€šä¿¡ä»¤ã€‚</p>
<h3 id="But"><a href="#But" class="headerlink" title="But"></a>But</h3><p>ä½†å¾€å¾€ç†æƒ³å¾ˆä¸°æ»¡ï¼Œç°å®å´å¾ˆéª¨æ„Ÿã€‚</p>
<h4 id="é—®é¢˜-1"><a href="#é—®é¢˜-1" class="headerlink" title="é—®é¢˜ 1"></a>é—®é¢˜ 1</h4><p>æŒ‰ç…§å‰é¢çš„æµç¨‹å»ºç«‹è¿æ¥ï¼Œ<code>uplink</code> åœ¨å‘é€ç¬¬ä¸€ä¸ª chunk æ•°æ®çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯é©¬ä¸Šå°±è¿”å›äº† <code>Server 500</code> çš„é”™è¯¯ã€‚è¿™ä¸ªé”™è¯¯å’Œ <code>Transfer-Encoding</code> æœ‰å…³ï¼Œé€šè¿‡æŠ“åŒ…èƒ½çœ‹åˆ°è¯·æ±‚çš„ <code>header</code> å’Œ <code>body</code> éƒ½å¾ˆæ™®é€šã€‚ä¹‹å‰è°ƒç ”æ—¶ä½¿ç”¨ <code>python</code> å†™çš„æµ‹è¯•ä»£ç ï¼Œå·²ç»è¯æ˜äº†è¿™ä¸ªæ–¹æ¡ˆæ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†åˆ°äº† iOS è¿™ä¸€ç«¯ï¼ŒæœåŠ¡å™¨å´å‘ç”Ÿäº†é”™è¯¯ã€‚</p>
<p>é€šè¿‡è¿è°ƒï¼Œå‘ç° <code>uplink</code> èµ°åˆ°äº†æ™®é€š <code>Post</code> çš„æµç¨‹ï¼Œè€Œä¸æ˜¯åº”è¯¥çš„ <code>Stream</code> æµç¨‹ã€‚å¦‚æœå°† <code>Transfer-Encoding</code> å»æ‰ï¼Œå´ä¸ä¼š <code>Server 500</code>ï¼Œè¿æ¥æ­£å¸¸ç»“æŸäº†ã€‚å¾—å‡ºç»“è®ºæ˜¯å½“å­˜åœ¨ <code>Tranfer-Encoding</code> ä¸º <code>Chunked</code> æ—¶ï¼Œåç«¯èµ°åˆ°äº† <code>Post</code> æµç¨‹ï¼Œç„¶åç”¨ <code>Post</code> æµç¨‹çš„æ–¹å¼å»è·å– <code>body</code> çš„æ—¶å€™ï¼Œæ•°æ®å¼‚å¸¸å¯¼è‡´äº† <code>Server 500</code>ï¼Œç®€å•æ¥è¯´ä¹Ÿå°±æ˜¯ <code>Transfer-Encoding</code> å’Œ <code>body</code> ä¸åŒ¹é…ã€‚</p>
<p>æ ¹æ®æŠ“åŒ…çš„æ•°æ®å¯¹æ¯”ï¼ŒiOS ç«¯çš„åŒ…å’Œæ­£å¸¸çš„ python çš„åŒ…ï¼Œ<strong>å”¯ä¸€</strong> çš„åŒºåˆ«æ˜¯ <code>Chunked</code> å’Œ <code>chunked</code>ï¼Œä¸€ä¸ªå¤§å†™ä¸€ä¸ªå°å†™ã€‚å¹¶ä¸” <a href="https://www.wireshark.org" target="_blank" rel="noopener">Wireshark</a> ä¸­ä¹Ÿä¼šæç¤º <code>[Expert Info (Warning/Undecoded): Unknown transfer coding name in Transfer-Encoding header]</code>ã€‚è€Œæˆ‘ä»¬åœ¨è®¾ç½® <code>Transfer-Encoding</code> çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿæ˜¯ä½¿ç”¨å°å†™çš„ <code>chunked</code>ï¼Œä½†ç»è¿‡ <code>URLSession</code> åä¼šå˜æˆäº†å¤§å†™ã€‚HTTP RFC è§„å®š header field å¤§å°å†™ä¸æ•æ„Ÿï¼Œä½†æ²¡æœ‰å¯¹ value è¿›è¡Œè§„å®šã€‚å¯¹æ¯”ç”¨çš„ python çš„æ¡†æ¶ï¼Œåˆ™ä¼šå°† <code>Transfer-Encoding</code> å¤„ç†æˆå°å†™ã€‚è¿™ä¸ªé—®é¢˜å’Œè¿·å¹»ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç»“è®ºå°±æ˜¯åç«¯æ‰€ä½¿ç”¨çš„æœåŠ¡ï¼Œå¹¶ä¸æ”¯æŒå¤§å†™çš„ <code>Chunked</code>ã€‚</p>
<p>è§£å†³åŠæ³•å°±æ˜¯é€šè¿‡ Hook çš„æ–¹å¼ï¼Œç¦æ­¢åº•å±‚å°† <code>header</code> ä¸­çš„ <code>Transfer-Encoding</code> è¿›è¡Œæ›´æ”¹ã€‚</p>
<blockquote>
<p>å®é™…æ“ä½œä¸­å…¶å®è¿˜æœ‰æ›´å¤šé—®é¢˜ï¼Œæ¯”å¦‚ <code>URLSessionDataTask</code> è¿›è¡Œå¤„ç† <code>orignalRequest</code> çš„æ—¶å€™ï¼Œä¼šæŠŠ <code>currentRequest</code> çš„ <code>Transfer-Encoding</code> çš„å€¼è®¾ä¸º <code>nil</code>ã€‚</p>
</blockquote>
<h4 id="é—®é¢˜-2"><a href="#é—®é¢˜-2" class="headerlink" title="é—®é¢˜ 2"></a>é—®é¢˜ 2</h4><p>åœ¨ <code>downlink</code> å‘é€å®Œ <code>name channel</code> ä¹‹åï¼Œä¸€ç›´ç­‰å¾…ä¸åˆ°è¿”å›ï¼Œç›´åˆ°è¶…æ—¶åæ‰è¿”å›ç¬¬ä¸€ä¸ªåŒ…ï¼Œ<code>HTTP/1.1 200 OK</code>ï¼Œå¹¶é©¬ä¸Šç»“æŸè¿æ¥ã€‚ç”±äº <code>downlink</code> å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ <code>POST</code> è¯·æ±‚ï¼Œéœ€è¦çš„å‚æ•°ä¹Ÿæ¯”è¾ƒå°‘ï¼Œ<code>name channel</code> çš„æ•°æ®ä¹Ÿå¾ˆå®¹æ˜“ç¡®å®šæ˜¯å¦æ­£ç¡®ï¼Œå¹¶ä¸”è¿”å›çš„ç¬¬ä¸€ä¸ªåŒ… <code>header</code> å’Œ <code>body</code> é™¤äº† <code>Transfer-Encoding</code> ä¸º <code>Identity</code> å¤–å¹¶æ— å¼‚å¸¸ã€‚</p>
<p>é¦–å…ˆè¿˜æ˜¯è¿›è¡ŒæŠ“åŒ…ï¼Œå‘ç°å…¶å®åœ¨è¯·æ±‚åˆšå‘å‡ºå»ä¸ä¹…ï¼ŒæœåŠ¡å™¨å°±é©¬ä¸Šè¿”å›äº†ï¼Œå¹¶ä¸” <code>header</code> å’Œ <code>body</code> æ‰€æœ‰çš„æ•°æ®éƒ½å¾ˆæ­£å¸¸ï¼ŒåŒ…æ‹¬ <code>Transfer-Encoding</code> ä¸º <code>chunked</code>ã€‚é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆæœåŠ¡å™¨è¿”å›ç»™ <code>URLSession</code> äº†ï¼Œ<code>URLSession</code> å´æ²¡æœ‰é€šè¿‡ <code>delegate</code> å›è°ƒç»™æˆ‘ä»¬å‘¢ï¼Œå®ƒè¿ <code>func urlSession(_:dataTask:didReceive, completionHandler:</code>ï¼Œæ˜æ˜ <code>header</code> å’Œç¬¬ä¸€ä¸ª <code>chunk</code> çš„ <code>body</code> éƒ½å·²ç»è¿”å›äº†ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æ¯”é—®é¢˜ 1 è¿˜è¿·ï¼Œè™½ç„¶å®ƒæŠŠ <code>Transfer-Encoding</code> ä» <code>chunked</code> æ”¹ä¸ºäº† <code>Identity</code> è¿˜èƒ½æ¥å—ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŸ¥çœ‹ <code>header</code> ä¸­æ²¡æœ‰ <code>Content-Length</code> æ¥åˆ¤æ–­ï¼Œå®ƒå…¶å®å°±æ˜¯ <code>chunked</code> çš„æ–¹å¼ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜çš„è§£å†³è¿‡ç¨‹æ¯”è¾ƒæ›²æŠ˜ï¼Œé¦–å…ˆæˆ‘å‘ç°ä¸ç­‰å¾… <code>downlink</code> è¿”å› <code>name channel</code> æˆåŠŸï¼Œç»§ç»­é€šè¿‡ <code>uplink</code> å‘é€ä¿¡ä»¤æ—¶ï¼Œ<code>downlink</code> å°±èƒ½å¤Ÿè¿”å› <code>name channel</code> æˆåŠŸçš„ <code>chunk</code> ä»¥åŠåç»­ä¿¡ä»¤çš„ <code>chunk</code>ï¼Œ<code>downlink</code> ä¸ä¼šè¶…æ—¶æ–­å¼€ã€‚ä½†æ˜¯æˆ‘ä»¬çš„æ•´ä¸ªæµç¨‹æ˜¯å¿…é¡»è¦ç­‰ <code>name channel</code> æˆåŠŸä¹‹åæ‰èƒ½å‘ç”Ÿæ¶ˆæ¯ï¼Œä¸­é—´ç‰µæ‰¯ç€å¾ˆå¤š <code>seq</code> å’Œ <code>ack</code> çš„é—®é¢˜ã€‚ä¸èƒ½å‘é€æ™®é€šçš„ä¿¡ä»¤ï¼Œé‚£ä¹ˆå°±å°è¯•å¤šå‘é€ä¸€æ¬¡ <code>name channel</code> çš„æ—¶å€™ï¼Œå‘ç°ä¹Ÿè¿˜æ˜¯ä¸è¡Œã€‚</p>
<p>å‘é€æ™®é€šä¿¡ä»¤å¯ä»¥ï¼Œå‘é€ <code>name channel</code> å´ä¸è¡Œã€‚åæ¥å°è¯•äº†å…¶ä»–ä¿¡ä»¤ï¼Œçœ‹çœ‹æ˜¯å¦æ˜¯å¶ç„¶é—®é¢˜ï¼Œæœ€ç»ˆå‘ç°äº†ä¸»è¦çš„é—®é¢˜ï¼š<strong> <code>URLSession</code> ä¼šç­‰å¾…ç¬¬ä¸€ä¸ª 512 bytes æ•°æ®ï¼Œåªæœ‰å½“ buffer å¤§äº 512 bytes åæ‰ä¼šè¿”å› response å’Œ data</strong>ã€‚</p>
<p>é€šè¿‡ä»¥ <code>first 512 bytes</code> ä¸ºå…³é”®è¯æœç´¢æ—¶ï¼Œåœ¨ <a href="https://dev.w3.org/html5/cts/html5-type-sniffing.html" target="_blank" rel="noopener">HTML 5 rules for determining content types</a> å‘ç° H5 å¯¹ <code>first 512 bytes</code> æœ‰ä¸€å®šçš„è¦æ±‚ã€‚çŒœæƒ³åŸå› å’Œ <code>Content-Type</code> ä¸º <code>text/html</code> æœ‰å…³ï¼Œåæ¥éªŒè¯äº†è¿™ä¸ªçŒœæƒ³ã€‚</p>
<p>åè¿‡æ¥ä¸€æƒ³ï¼Œä¹Ÿå¾ˆéš¾è¯´ <code>URLSession</code> çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜ï¼Œä½†æ²¡æœ‰ä»»ä½•æ–‡æ¡£è¯´æ˜ç¡®è®¤ç»™äººå¸¦æ¥ä¸å°‘å›°æ‰°ã€‚å¯¹æ¯”èµ·æ¥ <code>Java</code> å’Œ <code>Python</code> éƒ½æ²¡æœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚è‡³äºä¸ºä»€ä¹ˆæœåŠ¡å™¨è¿”å›çš„æ˜¯ <code>text/html</code>ï¼Œè€Œä¸æ˜¯åšå®¢æˆ·ç«¯å¸¸ç”¨çš„ <code>application/json</code> ä¹‹ç±»çš„ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºåç«¯ç”¨çš„æœåŠ¡æ¡†æ¶æ˜¯ä¸€ä¸ªæ ‡å‡†å¯¹ <code>web</code> æ¡†æ¶å§ã€‚</p>
<p>åˆ°è¿™é‡Œè§£å†³æ–¹å¼å°±å¾ˆç®€å•äº†ï¼Œ<strong> æŠŠè¯¥æ­»çš„ <code>Content-Type</code> æ”¹ä¸ºç¬¦åˆåœºæ™¯çš„ <code>application/octet-stream</code> </strong>ã€‚</p>
<h4 id="é—®é¢˜-3"><a href="#é—®é¢˜-3" class="headerlink" title="é—®é¢˜ 3"></a>é—®é¢˜ 3</h4><p>å…¶å®æ˜¯æœ€åˆé‡åˆ°çš„é—®é¢˜ï¼Œå°±æ˜¯ <code>Proxy</code> çš„å½±å“ã€‚é¦–å…ˆ <code>Proxy</code> çœ‹åˆ°çš„æ•°æ®ï¼Œæ˜¯å¦å¯ä¿¡çš„é—®é¢˜ï¼Œå…¶æ¬¡å°±æ˜¯ <code>Proxy</code> å¯¹ <code>header</code> å¸¦æ¥çš„å½±å“ï¼Œæ¯”å¦‚ <code>End-to-end headers</code> å’Œ <code>Hop-by-hop headers</code>ã€‚(<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" target="_blank" rel="noopener">HTTP headers - HTTP | MDN</a>ï¼‰</p>
<p>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ—©æœŸä½¿ç”¨ <code>Charles</code> å’Œ <code>ProxyMan</code> æ¥æŠ“ <code>HTTPS</code> çš„åŒ…ï¼Œæ²¡æœ‰é‡åˆ°é—®é¢˜ 1 <code>Server 500</code> çš„é—®é¢˜ï¼ŒæŸä¸€æ¬¡é‡å¯ç”µè„‘åï¼Œæ²¡æœ‰æ‰“å¼€ <code>Proxy</code>ï¼Œç„¶åæ‰å‘ç°ä¼šç¨³å®šå‡ºç° <code>Server 500</code>ã€‚</p>
<p>è¿˜æœ‰å€¼å¾—ä¸€æçš„å°±æ˜¯ä»£ç æœåŠ¡å™¨çš„é—®é¢˜ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°è¿‡ç›´è¿å’Œé€šè¿‡ä»£ç†æœåŠ¡å™¨åå‡ºç°ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè™½ç„¶åç«¯è¯´ä»£ç†æœåŠ¡å™¨ä¸ä¼šåšä»»ä½•å¤„ç†ï¼Œåªæ˜¯å°†æ•°æ®è¿›è¡Œé€ä¼ ã€‚</p>
<h4 id="å…¶ä»–çš„æ–¹æ¡ˆ"><a href="#å…¶ä»–çš„æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–çš„æ–¹æ¡ˆ"></a>å…¶ä»–çš„æ–¹æ¡ˆ</h4><p>åœ¨è§£å†³ä¸Šé¢çš„å‡ ä¸ªé—®é¢˜æ—¶ï¼Œç”±äºæ–‡æ¡£å’Œç›¸å…³çš„è®¨è®ºéƒ½æ¯”è¾ƒå°‘ï¼Œå¹¶ä¸”æ²¡æœ‰çœ‹åˆ°æœ‰äººé‡åˆ°è¿™äº›é—®é¢˜ï¼Œåœ¨ç¡®å®šé—®é¢˜å‡ºåœ¨ <code>URLSession</code> åŠå…¶åº•å±‚å®ç°ä¸Šçš„æƒ…å†µä¸‹ï¼Œåœ¨æ²¡å¤´ç»ªçš„æ—¶å€™è¿˜å°è¯•è¿‡ <code>libcurl</code> çš„æ–¹æ¡ˆã€‚</p>
<p>ç”±äº apple ä¸ºäº†å»ºè®¾ Swift çš„ç”Ÿæ€ï¼Œæä¾›äº†ä¸€ä¸ªå¼€æºç‰ˆçš„ <a href="https://github.com/apple/swift-corelibs-foundation" target="_blank" rel="noopener">Foundation</a>ï¼Œå…¶ä¸­å°±åŒ…å«æœ‰ <a href="https://github.com/apple/swift-corelibs-foundation/tree/master/Sources/FoundationNetworking/URLSession" target="_blank" rel="noopener">URLSession</a> çš„å®ç°ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°å®ƒåœ¨å¤„ç† <code>body</code> çš„æ—¶å€™ï¼Œæ˜¯æœ‰é—®é¢˜çš„ï¼š <code>å½“ Body ä¸º Stream çš„æƒ…å†µä¸‹ï¼Œæ ¹æ® libcurl çš„ read function æ¥è¯»å– body æ•°æ®ï¼Œæ¯æ¬¡è¯»å–ä¸€ä¸ªæŒ‡å®šå¤§å°çš„ chunkï¼Œå½“è¯»å–çš„æ—¶å€™ï¼Œå‘ç° inputStream å·²ç»æ²¡æœ‰æ•°æ®äº†ï¼Œå°±è®¤ä¸ºæ˜¯è¯»å–å®Œæ‰€æœ‰æ•°æ®äº†ã€‚</code> è¿™æ˜¾ç„¶ä¸æˆ‘ä»¬çš„è¦æ±‚ï¼Œä»¥åŠ iOS ä¸Šçš„ <code>URLSession</code> çš„è¡Œä¸ºä¸ä¸€è‡´ï¼Œ<code>input stream</code> åœ¨è¯»çš„æ—¶å€™æ²¡è¯»åˆ°æ•°æ®ï¼Œæœ‰å¯èƒ½ <code>output stream</code> è¿˜åœ¨å†™æˆ–è€…å³å°†å†™ï¼Œå¹¶ä¸ä»£è¡¨æ•´ä¸ªæµå·²ç»å®Œæˆã€‚æœ€ç®€å•æ¥è¯´å°±æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œ<code>Output stream</code> å¹¶ä¸æ˜¯ç”¨å¾ªç¯çš„æ–¹å¼è¿›è¡Œå†™æ•°æ®çš„ï¼Œå®ƒæœ‰ä¸€ä¸ªæœ‰é™å¤§å°çš„ <code>buffer</code>ï¼Œå¿…é¡»è¦ç­‰åˆ°æœ‰è¶³å¤Ÿç©ºé—´çš„æ—¶å€™æ‰èƒ½æˆåŠŸå†™å…¥æ•°æ®ã€‚æ‰€ä»¥ä¸€èˆ¬çš„æ–¹å¼ä¹Ÿæ˜¯ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Streams/Streams.html#//apple_ref/doc/uid/10000188-SW1" target="_blank" rel="noopener">å®˜æ–¹æ¨è</a> çš„æ–¹å¼ï¼Œéƒ½æ˜¯ä½¿ç”¨ <code>RunLoop</code> ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™éƒ¨åˆ†çš„å®ç°æ”¹ä¸€ä¸‹ï¼Œæ”¹ä¸º <code>RunLoop</code> çš„æ–¹å¼ï¼Œå½“ <code>read function</code> è¦è¯»å–æ•°æ®æ—¶ï¼Œå‘ç° <code>input stream</code> è¿˜æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±è¿”å› <code>retryLater</code>ï¼Œå‘Šè¯‰ <code>libcurl</code> çš„ <code>read socket</code> æš‚åœå‘é€æ•°æ®ï¼Œå…ˆç­‰å¾…ã€‚å½“ <code>RunLoop</code> å‘Šè¯‰æˆ‘ä»¬æœ‰æ•°æ®äº† <code>hasBytesAvailable</code> çš„æ—¶å€™ï¼Œå†è®© <code>read socket</code> è¿›è¡Œ <code>resume</code>ã€‚å¯ä»¥å‚è€ƒ <code>File</code> ç±»å‹çš„ <code>Body</code> çš„å®ç°ã€‚</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>å¦‚æœæƒ³ç”¨ <code>Cocoa Foundation</code> å®ç° <code>Streaming/Chunked</code>ï¼Œå¯èƒ½å¹¶ä¸ä¼šé‚£ä¹ˆé¡ºåˆ©ã€‚æœ‰äº›é—®é¢˜åœ¨å…¶ä»–å¹³å°æ²¡æœ‰æš´éœ²å‡ºæ¥ï¼Œä¹Ÿä¸ä»£è¡¨ç€ä¸€å®šå°±æ˜¯ <code>Cocoa Foundation</code> çš„é”…ï¼Œè¦å–„äºç”¨å¯é çš„æ–¹å¼ä»ä¸€ä¸ªæ›´ low level çš„è§’åº¦æ‰¾åˆ°ä¸åŒå¹³å°ä¸åŒå®ç°ç›´æ¥çš„å·®å¼‚ã€‚å½“æ²¡æœ‰æ–‡æ¡£èµ„æ–™å¯¹é—®é¢˜æœ‰å¸®åŠ©çš„æ—¶å€™ï¼Œã€Œæ€è€ƒ -&gt; çŒœæµ‹ -&gt; éªŒè¯ã€ï¼Œå¯èƒ½æ˜¯æœ€ä½³çš„è§£å†³é—®é¢˜çš„æ–¹å¼ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2019/06/05/existential/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/05/existential/" itemprop="url">âˆƒ Existential</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-06-05T20:00:00+08:00">
                2019-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-swift/" itemprop="url" rel="index">
                    <span itemprop="name">advanced swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ€åˆçœ‹åˆ° <strong>existential</strong> è¿™ä¸ªè¯ï¼Œæ˜¯åœ¨ <a href="http://www.russbishop.net/swift-associated-types-cont" target="_blank" rel="noopener">Swift Associated Types, cont.</a> è¿™ç¯‡æ–‡ç« ä¸­ï¼ˆç¬¬ä¸€æ¬¡çŸ¥é“ <code>typealias Any = protocol&lt;&gt;</code> ä¹Ÿæ˜¯åœ¨è¿™ç¯‡æ–‡ç« ï¼‰ï¼Œä½†å½“æ—¶å¹¶æ²¡æœ‰å¯¹è¿™ä¸ªé™Œç”Ÿåç§°ç•™ä¸‹ä»€ä¹ˆæ·±åˆ»å°è±¡ã€‚</p>
<p>åæ¥é™†é™†ç»­ç»­åº”è¯¥ä¹Ÿçœ‹åˆ°è¿‡ä¸€äº›ï¼Œæ¯”å¦‚ <a href="https://developer.apple.com/videos/play/wwdc2016/416/" target="_blank" rel="noopener">Understanding Swift Performance - WWDC 2016</a>ã€‚</p>
<p>çœŸæ­£çš„æƒ³è¦å»äº†è§£å®ƒï¼Œæ˜¯ä¹‹å‰å†™ <a href="http://blessingsoft.com/2018/08/26/pats/">PATs</a> çš„æ—¶å€™ï¼Œé‚£æ—¶å€™ <strong>existential</strong> è¿™ä¸ªè¯å¾ˆé«˜é¢‘çš„å‡ºç°ï¼Œç”šè‡³æ˜¯å’Œ PATs æ¯æ¯ç›¸å…³ï¼Œæ‰€ä»¥è¿›è¡Œäº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ã€‚</p>
<p>ä½†æ˜¯å‘¢ï¼Œåªæ˜¯ç‰‡é¢çš„äº†è§£ï¼Œè€Œæ²¡æœ‰å»ºç«‹èµ·ç«‹ä½“çš„è®¤è¯†ï¼Œè®°å¿†å¾ˆå¿«å°±ä¼šå¼€å§‹æ¨¡ç³Šï¼Œç›´åˆ°æœ€åå¿˜è®°æ‰ã€‚æ‰€ä»¥æ‰æœ‰äº†è¿™æ¬¡çš„ <strong>existential</strong> è®¤çŸ¥ä¹‹æ—…ã€‚</p>
<blockquote>
<p>æ³¨ï¼šè¿™ç¯‡å¤§å¤šæ•°æ¦‚å¿µã€è§‚ç‚¹ã€ç‰‡æ®µéƒ½æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£æˆ–è€…å‚è€ƒæ–‡ç« ï¼Œå°éƒ¨åˆ†è‡ªå·±çš„è®¤çŸ¥ç†è§£ï¼Œå¹¶ä¸”ä¸ä¿è¯ç†è§£çš„æ­£ç¡®ã€‚</p>
</blockquote>
<h2 id="Existential-Type"><a href="#Existential-Type" class="headerlink" title="Existential Type"></a>Existential Type</h2><p>æƒ³ç†è§£ <strong>existential</strong>ï¼Œå¿…é¡»è¦å…ˆäº†è§£ <strong>existential values</strong>, <strong>existential containers</strong> å’Œ <strong>witness tables</strong> çš„æ¦‚å¿µã€‚</p>
<p>åœ¨ç±»å‹è®ºä¸­ï¼Œ <a href="https://en.wikipedia.org/wiki/Type_system#Existential_types" target="_blank" rel="noopener">existential type</a> æè¿°äº†æŠ½è±¡ç±»å‹çš„æ¥å£ã€‚å½“å¯¹è±¡çš„ç±»å‹æ˜¯ <code>protocol</code> æ—¶ï¼Œå°±ä¼šç”¨åˆ° <strong>existential type</strong>ï¼Œå› ä¸ºå­˜å‚¨æˆ–ä¼ é€’ä¸€ä¸ª <code>protocol</code> ç±»å‹çš„å¯¹è±¡æ„å‘³ç€å¯¹è±¡åœ¨è¿è¡Œæ—¶çš„çœŸå®ç±»å‹æ˜¯ä¸é€æ˜çš„ï¼ˆä¹Ÿå°±æ˜¯ç¼–è¯‘æœŸä¸å¯çŸ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿæ— æ³•ç¡®å®šè¿™ç±»å¯¹è±¡çš„å¸ƒå±€ï¼‰ã€‚</p>
<p>ä¸€ä¸ªéµä»äº†ç‰¹å®š <code>protocol</code> çš„ç±»å‹ä¸€å®šåŒ…å«å…¶çº¦å®šçš„æ‰€æœ‰æ–¹æ³•ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•çš„åœ°å€æ˜¯æ— æ³•åœ¨ç¼–è¯‘æœŸç¡®å®šçš„ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰åœ¨è¿è¡Œæ—¶ï¼Œæ‰èƒ½ç¡®å®šè¿™ä¸ª <code>protocol</code> å¯¹åº”çš„çœŸå®ç±»å‹ã€‚è¿™å’Œ <code>non-final class</code> å¼•ç”¨æ˜¯ç±»ä¼¼çš„ï¼ˆå› ä¸ºå¯èƒ½è¢« overrideï¼‰ï¼Œå› æ­¤ä¹Ÿä½¿ç”¨äº† <a href="https://github.com/apple/swift/blob/master/docs/ABIStabilityManifesto.md#method-dispatch" target="_blank" rel="noopener">ç±»ä¼¼çš„æŠ€æœ¯æ‰‹æ®µ</a> æ¥è§£å†³ã€‚<code>Protocol</code> ä¸­çº¦å®šçš„æ¯ä¸€ä¸ªè¢«å®ç°çš„æ–¹æ³•çš„åœ°å€ï¼Œéƒ½è¢«ä¿å­˜åœ¨ <strong>witness table</strong> ä¸­ã€‚</p>
<h3 id="Existential-Value"><a href="#Existential-Value" class="headerlink" title="Existential Value"></a>Existential Value</h3><p>æ˜¾ç„¶çš„ï¼Œ<strong>existential type</strong> çš„å€¼ï¼Œå°±æ˜¯ <strong>existential value</strong>ã€‚:P</p>
<h3 id="Existential-Container"><a href="#Existential-Container" class="headerlink" title="Existential Container"></a>Existential Container</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Foo</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">let</span> foos: [<span class="type">Foo</span>] = ... <span class="comment">// What's the memory storage looks like?</span></span><br></pre></td></tr></table></figure>
<p>ç®€å•æ¥è¯´ <strong>existential of a protocol</strong> å°±æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ç”Ÿæˆçš„ç›’å­ boxï¼Œç”¨æ¥å­˜æ”¾éµä»è¿™ä¸ª <code>protocol</code> çš„å€¼ï¼Œè¿™ä¸ªç›’å­ï¼Œä¹Ÿå«åš <strong>Existential Container</strong>ï¼Œç›’å­é‡Œé¢çš„ä¸œè¥¿ï¼Œå°±å«åš <strong>witness</strong>ã€‚</p>
<p>å…³äº <strong>existential container</strong> çš„å†…å­˜å¸ƒå±€ï¼Œè¿™äº›å€¼æ€ä¹ˆå­˜å‚¨ï¼Œè¦åˆ†å‡ ç§æƒ…å†µæ¥è¯´ã€‚å› ä¸ºå€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·ï¼Œå€¼æ¯”è¾ƒå°å’Œæ¯”è¾ƒå¤§ä¹Ÿå¯ä»¥ä¸ºäº†æ€§èƒ½ç”¨ä¸åŒçš„ç­–ç•¥ã€‚<a href="https://developer.apple.com/videos/play/wwdc2016/416/" target="_blank" rel="noopener">Understanding Swift Performance - WWDC 2016</a> å’Œ <a href="https://github.com/apple/swift/blob/master/docs/ABIStabilityManifesto.md" target="_blank" rel="noopener">ABIStabilityManifesto Â· GitHub</a> ä¸­éƒ½æœ‰è¯¦ç»†çš„æè¿°ã€‚</p>
<p>ç®€å•æ¥è¯´å°±æ˜¯ 5 ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œå‰ä¸‰ä¸ªè¿ç»­çš„å­—èŠ‚å«åš <em>value buffer</em>ï¼Œç”¨æ¥å­˜æ”¾å¯¹è±¡çš„å€¼æˆ–è€…æŒ‡é’ˆã€‚å€¼ç±»å‹å¦‚æœæ”¾å¾—ä¸‹ï¼Œå°±ç›´æ¥å†…è”æ”¾åœ¨ <em>value buffer</em> é‡Œé¢ï¼Œå¦‚æœæ”¾ä¸ä¸‹ï¼Œå°±åœ¨å­˜æ”¾åœ¨å †ä¸Šï¼ŒæŠŠæŒ‡é’ˆåœ°å€å­˜æ”¾åœ¨ <em>value buffer</em> é‡Œï¼›å¼•ç”¨ç±»å‹ç›´æ¥æ”¾æŒ‡é’ˆã€‚<br>ç¬¬å››ä¸ªå­—èŠ‚å­˜æ”¾ <code>vwt</code> (<em>value witness table</em>) æŒ‡é’ˆã€‚<br>ç¬¬äº”ä¸ªå­—èŠ‚å­˜æ”¾ <code>pwt</code> (<em>protocol witness table</em>) æŒ‡é’ˆã€‚</p>
<p>å¯¹äºé‚£äº›é™å®šäº†åªèƒ½æ˜¯ <code>class</code> å®ç°çš„ <code>protocol</code>ï¼Œ<code>containers</code> ä¸­åˆ™ä¼šå¿½ç•¥ <code>vwt</code> æŒ‡é’ˆï¼ˆå› ä¸ºå¯¹è±¡è‡ªèº«åŒ…å«æŒ‡å‘è‡ªå·±ç±»å‹ä¿¡æ¯çš„æŒ‡é’ˆï¼‰ä»¥åŠå¤šä½™çš„å†…è¿ bufferã€‚å¹¶ä¸”ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‰¹ä¾‹ <code>Any</code>ï¼Œç”±äºå®ƒæ²¡æœ‰éµä»ä»»ä½• <code>protocol</code>ï¼Œå› æ­¤ <code>Any</code> å¯¹è±¡çš„ <code>containers</code> ä¸­æ²¡æœ‰ <em>witness table</em> æŒ‡é’ˆã€‚ï¼ˆæ²¡é”™ï¼Œ<code>Any</code> ä¹Ÿæ˜¯ä¸€ä¸ª <strong>existential</strong> ï¼å³ä½¿ Swift 3 ä¹‹åæŠŠ <code>Any</code> å½“ä½œäº† keywordï¼Œä½†ä¼°è®¡å’Œä¹‹å‰çš„ <code>protocol &lt;&gt;</code> å·®ä¸å¤šçš„å®ç°ï¼Œæ‰€ä»¥ä¾ç„¶æ˜¯ <strong>existential</strong> ã€‚ï¼‰</p>
<h3 id="VWT"><a href="#VWT" class="headerlink" title="VWT"></a>VWT</h3><p>æ¯ä¸€ä¸ªå…·ä½“ç±»å‹ï¼ˆconcrete typeï¼‰éƒ½æœ‰ä¸€å¼  <em>value witness table</em>ï¼Œç”¨æ¥å­˜æ”¾è¿™ä¸ªç±»å‹çš„æœ‰å…³å†…å­˜å¸ƒå±€å’Œæ“ä½œå®ƒçš„å€¼çš„ä¿¡æ¯ã€‚å½“ä¸€ä¸ªå€¼ç±»å‹å…·æœ‰ä¸é€æ˜å¸ƒå±€çš„æ—¶å€™ï¼Œå› ä¸ºå€¼ç¼–è¯‘çš„æ—¶å€™æ²¡åŠæ³•çŸ¥é“å®é™…ç±»å‹ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡æŸ¥è¯¢è¿™ä¸ªè¡¨æ¥çŸ¥é“è¿™äº›æœ‰å…³ä¿¡æ¯ï¼ˆmetadataï¼‰ã€‚</p>
<h3 id="PWT"><a href="#PWT" class="headerlink" title="PWT"></a>PWT</h3><p><em>Protocol witness table</em> æ˜¯ <code>protocol</code> æ¥å£çš„ä¸€å¼ å‡½æ•°è¡¨ã€‚å¦‚æœæœ‰ associated typeï¼Œå®ƒè¿˜ä¼šå­˜å‚¨ associated type çš„ metadataã€‚</p>
<blockquote>
<p>æ‰€ä»¥ä»€ä¹ˆæ˜¯ <strong>existential</strong> æ˜¯ä»€ä¹ˆï¼Ÿå°±æ˜¯ä¸€ä¸ª <code>protocol</code> ç±»å‹çš„å€¼ã€‚</p>
</blockquote>
<h2 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h2><p>å½“ä¸€ä¸ª <code>protocol</code> ä½œä¸ºç±»å‹è€Œä¸æ˜¯å…·ä½“çš„ç±»å‹çº¦æŸçš„æ—¶å€™ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª <strong>existential</strong>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Foo</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bar</span>&lt;T: Foo&gt;<span class="params">(<span class="number">_</span> foo: T)</span></span> &#123;&#125; <span class="comment">// This requires a concrete T that conforms to Foo</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">baz</span><span class="params">(<span class="number">_</span> foo: Foo)</span></span> &#123;&#125; <span class="comment">// This requires a variable of type Foo (pedantically: "a Foo existential")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo: <span class="type">Foo</span> = ... <span class="comment">// existential of protocol `Foo`</span></span><br><span class="line">bar(foo) <span class="comment">// ğŸ˜¢ Protocol type 'Foo' cannot conform to 'Foo' because only concrete types can conform to protocols</span></span><br><span class="line">baz(foo) <span class="comment">// ğŸ˜Š</span></span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å½“çœ‹åˆ° â€œa protocol doesnâ€™t conform to itselfâ€ çš„æ—¶å€™ï¼Œå®ƒå®é™…ä¸Šæ˜¯æŒ‡ â€œthe existential of a protocol doesnâ€™t conform to that protocolâ€ã€‚ </p>
<h2 id="Generic"><a href="#Generic" class="headerlink" title="Generic"></a>Generic</h2><p><strong>Existentials</strong> ä¸æ˜¯çœŸæ­£çš„æ³›å‹ï¼ˆ<code>generic</code>ï¼‰ï¼Œä½†ç”±äºå®ƒä»¬ç›¸äº’ä¾èµ–äº <code>protocol</code>ï¼Œè¿™ä¸¤ä¸ªç³»ç»Ÿç´§å¯†åœ°äº¤ç»‡åœ¨ä¸€èµ·ã€‚</p>
<blockquote>
<p>While protocols create existential (â€œthere existsâ€) types, generics create universal (â€œfor allâ€) types. </p>
</blockquote>
<p>å…ˆå›é¡¾ä¸€ä¸‹æ³›å‹çš„ä¸€äº›å¸¸è§æ¦‚å¿µï¼š</p>
<ul>
<li>æ³›å‹å‡½æ•° <code>func swap&lt;T&gt;(_ a: inout T, _ b: inout T)</code></li>
<li>ç±»å‹å‚æ•° <code>&lt;T&gt;</code></li>
<li>æ³›å‹ç±»å‹ <code>Queue&lt;T&gt;</code></li>
<li>ç±»å‹çº¦æŸ <code>&lt;T: Protocol, U: Class&gt;</code></li>
<li>å…³è”ç±»å‹ <code>associatedtype T</code></li>
<li>æ³›å‹ä»å¥ <code>func foo&lt;T: P, U: P&gt;(_ a: T, _ b: T) where T: Equatable, T.Item == U.Item</code></li>
</ul>
<p>å½“ä½¿ç”¨æ³›å‹ä½œä¸ºç±»å‹çº¦æŸçš„æ—¶å€™ï¼Œä¼šæ¶‰åŠåˆ° <strong>existentials</strong>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bar</span>&lt;T: Foo&gt;<span class="params">(<span class="number">_</span> foo: T)</span></span> &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> foo: <span class="type">Foo</span> = ...</span><br><span class="line">bar(foo) <span class="comment">// Protocol type 'Foo' cannot conform to 'Foo' because only concrete types can conform to protocols</span></span><br></pre></td></tr></table></figure>
<h2 id="PATs"><a href="#PATs" class="headerlink" title="PATs"></a>PATs</h2><p>æ—¢ç„¶æœ‰ <strong>existentials</strong> äº†ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦ <strong>type eraser</strong> å‘¢ï¼Ÿ</p>
<p>å…ˆå›è¿‡å¤´æ¥çœ‹çœ‹ä¹‹å‰åœ¨ <a href="http://blessingsoft.com/2018/08/26/pats/">PATs</a> ä¸­é‡åˆ°çš„å‡ ä¸ªé—®é¢˜ã€‚</p>
<blockquote>
<p>Protocol â€˜Cachingâ€™ can only be used as generic constraint because it has Self or associated type requirements</p>
</blockquote>
<p>å®ƒçš„æ„æ€æ˜¯ï¼Œ<code>Caching</code>  è¿™ä¸ª PATs æ²¡æœ‰ï¼ˆæ— æ³•è‡ªåŠ¨ç”Ÿæˆï¼‰ä¸€ä¸ª <strong>existential</strong>.</p>
<blockquote>
<p>Using â€˜Loggingâ€™ as a concrete type conforming to protocol â€˜Hashableâ€™ is no supported</p>
</blockquote>
<p>å®ƒçš„æ„æ€æ˜¯ï¼Œè¿™ä¸ª <code>Logging</code> çš„ <strong>existential</strong> æ²¡æœ‰å®ç° <code>Hashable</code> è¿™ä¸ªåè®®ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ— æ³•ä¸º PATs ç”Ÿæˆä¸€ä¸ª <strong>existential</strong> å‘¢ï¼Ÿå®é™…ä¸Šæ˜¯å¯ä»¥çš„ï¼Œä½†å®ƒå¾ˆå¤æ‚ã€‚å®ƒå¯ä»¥é€šè¿‡ä¸€ç§å«åš <strong>generalized existentials</strong> çš„æŠ€æœ¯ï¼Œç”Ÿæˆä¸€ä¸ª <strong>implicit existential</strong>ã€‚å³ä½¿è¿™æ ·ï¼Œå®ƒè¿˜æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦è§£å†³ã€‚</p>
<p>å¯¹äº <strong>existential</strong> çš„è‡ªåŠ¨ç”Ÿæˆï¼Œé¦–å…ˆ <strong>existential</strong> æ˜¯è¿è¡Œæ—¶çš„ï¼ˆæ³›å‹ <code>generic</code> æ˜¯ç¼–è¯‘æ—¶çš„ï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡åœ¨è¿è¡Œæ—¶ï¼ŒæŠŠ <code>protocol</code> çš„ä¸€äº›ä¿¡æ¯å­˜æ”¾åœ¨ <strong>existential container</strong> é‡Œé¢ã€‚å½“ <code>protocol</code> é‡Œé¢å­˜åœ¨æœ‰ <em>associated types</em> æˆ–è€…æœ‰ <code>Self</code> çº¦æŸçš„æ—¶å€™ï¼Œå®ƒæ²¡åŠæ³•é’ˆå¯¹ä»»æ„ç±»å‹ï¼ˆAnyï¼‰è‡ªåŠ¨ç”Ÿæˆå¡«å……è¿™ä¸ª <strong>existential container</strong>ã€‚ï¼ˆSwift æ˜¯é™æ€è¯­è¨€ï¼Œå¯¹äºæ³›å‹éœ€è¦åœ¨ç¼–è¯‘æ—¶å°±è¿›è¡Œæ³›å‹ç‰¹åŒ–ï¼Œ<strong>generic specialization</strong>ï¼Œé™¤éæŠŠæ³›å‹å½“ä½œæ˜¯ <code>Any</code> æ¥å¤„ç†ã€‚è¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯å¯¹ PATs è¿›è¡Œçº¦æŸï¼Œ<code>let strings: Any&lt;Sequence where .Iterator.Element == String&gt; = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</code>ï¼Œä¹Ÿå°±æ˜¯ <code>AnySequence&lt;String&gt;</code> ï¼‰</p>
<p>ç†è§£è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹æ™•ï¼Œå†æ¥æ‹ä¸€ä¸‹ã€‚é¦–å…ˆç¼–è¯‘å™¨æŠŠå­˜å‚¨æˆ–è€…ä¼ é€’çš„  <code>protocol</code> ç±»å‹ï¼Œå…ˆæ›¿æ¢æˆ <code>existential container</code>ï¼ˆç”Ÿæˆä»£ç ï¼‰ï¼Œç„¶åå†ç¼–è¯‘æˆç›®æ ‡ä»£ç ã€‚å½“ç¼–è¯‘å™¨å‘ç°è¿™ä¸ª <code>protocol</code> æ˜¯ PATs æ—¶ï¼Œå®ƒå¦‚æœä¸é€šè¿‡ <em>generic specialization</em> çš„è¯ï¼Œæ— æ³•ç”Ÿæˆä¸å¸¦æ³›å‹çš„ä»£ç ã€‚é‚£ä¸ºä»€ä¹ˆè¯´ <strong>existential</strong> æ˜¯è¿è¡Œæ—¶çš„å‘¢ï¼Ÿå› ä¸ºå­˜å‚¨æˆ–ä¼ é€’ä¸€ä¸ª <code>protocol</code> ç±»å‹çš„å¯¹è±¡æ„å‘³ç€å¯¹è±¡åœ¨è¿è¡Œæ—¶çš„çœŸå®ç±»å‹æ˜¯ä¸é€æ˜çš„ï¼ˆä¹Ÿå°±æ˜¯ç¼–è¯‘æœŸä¸å¯çŸ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿæ— æ³•ç¡®å®šè¿™ç±»å¯¹è±¡çš„å¸ƒå±€ï¼‰ã€‚</p>
<p>è¿˜æœ‰ä¸€äº›ç±»å‹æ˜¯ä¸é€‚åˆè‡ªåŠ¨ç”Ÿæˆ <strong>existential</strong> çš„ï¼Œç¼–è¯‘å™¨æ²¡æ³•æ»¡è¶³æœ‰ <code>init</code> å’Œ <code>static</code> çš„è¦æ±‚ã€‚æ¯”å¦‚ <code>Decodable</code> è¿™æ ·çš„æ²¡æœ‰å®ä¾‹æ–¹æ³•çš„åè®®ï¼Œ<strong>existential</strong> æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Decodable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">init</span>(from decoder: <span class="type">Decoder</span>) <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Model</span>: <span class="title">Decodable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> x: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decode</span><span class="params">(<span class="number">_</span> decodable: Decodable)</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> decodable: <span class="type">Decodable</span> = <span class="type">Model</span>(x: <span class="string">"x"</span>)</span><br><span class="line">decode(decodable)</span><br><span class="line"><span class="comment">// ä¸Šé¢å¯¹ä»£ç ç¼–è¯‘èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯èƒ½è‡ªåŠ¨ç”Ÿæˆ *existential*</span></span><br><span class="line"><span class="comment">// ä½†å¯¹äº decode(_:) å‡½æ•°ï¼Œæ ¹æœ¬æ— ä»ä¸‹æ‰‹ï¼Œå› ä¸º Decoder éœ€è¦çš„æ˜¯ä¸€ä¸ªéµå®ˆ Decodable åè®®çš„ç±»å‹ï¼Œè€Œä¸æ˜¯å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decode</span><span class="params">(<span class="number">_</span> type: Decodable.<span class="keyword">Type</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> decodable = <span class="type">JSONDecoder</span>().decode(type, from: data)</span><br><span class="line">    <span class="comment">// let decodable = JSONDecoder().decode(Decodable.self, from: data)</span></span><br><span class="line">    <span class="comment">// Protocol type 'Decodable' cannot conform to 'Decodable' because only concrete types can conform to protocols</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æœ€ç»ˆè¿˜æ˜¯é‚£ä¸ª `Protocol type 'Decodable' cannot conform to 'Decodable' because only concrete types can conform to protocols`</span></span><br></pre></td></tr></table></figure>
<p>å…¶å® <strong>type eraser</strong> å’Œ <strong>existentials</strong> è¿™ä¸¤ç§æ˜¯å¯¹å¶çš„ï¼ˆ duals ï¼‰ï¼Œæ³›å‹ï¼ˆ generic ï¼‰çš„ <code>Any&lt;T&gt;</code> ç­‰åŒäº åè®®ï¼ˆ protocol ï¼‰çš„ä¸€ç§ <strong>explicit existential</strong>ã€‚</p>
<h2 id="Existential-in-Other-Language"><a href="#Existential-in-Other-Language" class="headerlink" title="Existential in Other Language"></a>Existential in Other Language</h2><h3 id="Existential-type-in-Java"><a href="#Existential-type-in-Java" class="headerlink" title="Existential type in Java"></a>Existential type in Java</h3><p>Java æ³›å‹ä¸­çš„ <strong>Wildcards</strong> å…¶å®å°±æ˜¯ä¸€ç§ existential typeï¼Œæ¯”å¦‚ <code>java.util.List&lt;?&gt;</code>ã€‚</p>
<p>åœ¨ Java ä¸­ç”±äºæœ‰<a href="h">ç±»å‹æ“¦é™¤</a> çš„å­˜åœ¨ï¼Œæ³›å‹çš„å‚æ•°ç±»å‹ä¿¡æ¯åœ¨è¿è¡Œæ—¶ä¼šä¸¢å¤±ï¼Œåœ¨è¿è¡Œæ—¶æ— æ³•æ ¹æ®å·²çŸ¥çš„ç±»å‹ä¿¡æ¯åŒºåˆ† <code>List[Int]</code> å’Œ <code>List[String]</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List foo = <span class="keyword">new</span> ArrayList();</span><br><span class="line">foo.add(<span class="string">"foo"</span>);</span><br><span class="line">foo.get(<span class="number">0</span>); <span class="comment">// "foo"</span></span><br></pre></td></tr></table></figure>
<p>å½“æ²¡æœ‰ç»™å‡ºç±»å‹å‚æ•°çš„æ—¶å€™ï¼Œé€šè¿‡ä½¿ç”¨ existential æ¥è§£å†³ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;?&gt;</span><br><span class="line">List&lt;? extends Number&gt;</span><br><span class="line">List&lt;? <span class="keyword">super</span> Integer&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Existential-type-in-Kotlin"><a href="#Existential-type-in-Kotlin" class="headerlink" title="Existential type in Kotlin"></a>Existential type in Kotlin</h3><p>Kotlin ä¸­æ²¡æœ‰ <strong>existential type</strong>ã€‚å®ƒæœ‰ä¸€ä¸ªæ¦‚å¿µå«ç€ <strong>The Existential</strong> çš„æ¦‚å¿µã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span></span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dogBar: Bar&lt;Dog&gt; = Bar()</span><br><span class="line"><span class="keyword">var</span> animalBar: Bar&lt;Animal&gt; = dogBar <span class="comment">// ğŸ˜¢</span></span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span>&lt;<span class="type">out T</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dogBar: Bar&lt;Dog&gt; = Bar()</span><br><span class="line"><span class="keyword">var</span> animalBar: Bar&lt;Animal&gt; = dogBar <span class="comment">// ğŸ˜Š</span></span><br></pre></td></tr></table></figure>
<h3 id="Existential-type-in-Scala"><a href="#Existential-type-in-Scala" class="headerlink" title="Existential type in Scala"></a>Existential type in Scala</h3><p><code>ArrayList() == List[]</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Trait</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span>(seq: <span class="type">Seq</span>[<span class="type">String</span>]): <span class="type">Seq</span>[<span class="type">String</span>]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span>(seq: <span class="type">Seq</span>[<span class="type">Int</span>]): <span class="type">Seq</span>[<span class="type">Int</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Error, have the same type after erasure</span></span><br><span class="line"></span><br><span class="line"><span class="type">List</span>[_] <span class="comment">// List[T] forSome &#123; type T &#125;</span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">List</span>[+<span class="type">T</span>]</span></span><br></pre></td></tr></table></figure>
<h3 id="Existential-type-in-Rust"><a href="#Existential-type-in-Rust" class="headerlink" title="Existential type in Rust"></a>Existential type in Rust</h3><p> <code>fn foo() -&gt; impl Trait</code></p>
<p>æ ¸å¿ƒåœ¨äº <code>impl Trait</code>ï¼Œå’Œ Swift 5.1 <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0244-opaque-result-types.md" target="_blank" rel="noopener">Opaque Result Types</a> ä¸­çš„ <code>func foo() -&gt; some P</code> ä¸€æ ·ã€‚</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><strong>Existential</strong> æ˜¯ä»€ä¹ˆï¼Ÿ<strong>Existential</strong> å°±æ˜¯ <code>protocol</code> ç±»å‹çš„å€¼ã€‚è¿™æ˜¯ç¼–è¯‘å±‚é¢ç›¸å…³çš„æ¦‚å¿µï¼Œå¹³æ—¶å†™ä»£ç ä¸éœ€è¦çŸ¥é“å®ƒæ„å‘³ç€ä»€ä¹ˆæˆ–è€…æ˜¯ä»€ä¹ˆï¼Œåªéœ€è¦çŸ¥é“å®ƒä¼šè·Ÿä½ æƒ³è±¡ä¸­ä¸€æ · work å°±è¡Œäº†ã€‚</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="http://www.russbishop.net/swift-associated-types-cont" target="_blank" rel="noopener">Swift Associated Types, cont. - Russ Bishop</a><br><a href="https://github.com/apple/swift/blob/master/docs/ABIStabilityManifesto.md" target="_blank" rel="noopener">ABIStabilityManifesto Â· GitHub</a><br><a href="https://github.com/apple/swift/blob/master/docs/GenericsManifesto.md" target="_blank" rel="noopener">GenericsManifesto Â· GitHub</a><br><a href="https://forums.swift.org/t/improving-the-ui-of-generics/22814" target="_blank" rel="noopener">Improving the UI of generics - Swift Forums</a><br><a href="http://robnapier.net/existential-spelling" target="_blank" rel="noopener">Protocols III: Existential Spelling - Cocoaphony</a><br><a href="https://en.wikipedia.org/wiki/Type_system#Existential_types" target="_blank" rel="noopener">Existential types - Wikipedia</a><br><a href="https://developer.apple.com/videos/play/wwdc2016/416/" target="_blank" rel="noopener">Understanding Swift Performance - WWDC 2016</a><br><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0244-opaque-result-types.md" target="_blank" rel="noopener">0244-opaque-result-types - GitHub</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2018/11/19/from-result-to-error-handling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/from-result-to-error-handling/" itemprop="url">From Result to Error Handling</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-11-19T20:00:00+08:00">
                2018-11-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-swift/" itemprop="url" rel="index">
                    <span itemprop="name">advanced swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>æœ€è¿‘å…³äº <a href="swift-evolution/0235-add-result.md at master Â· apple/swift-evolution Â· GitHub">Add Result to the Standard Library</a> çš„ææ¡ˆæ­£åœ¨æ¿€çƒˆçš„<a href="SE-0235 - Add Result to the Standard Library - Proposal Reviews - Swift Forums">è®¨è®ºä¸­</a>ï¼Œè®¨è®ºçš„å†…å®¹ä»å‘½ååˆ°å¼‚æ­¥é”™è¯¯å¤„ç†ï¼Œå†åˆ°æ˜¯å¦åº”è¯¥æœ‰ä¸€ä¸ª <code>Either</code> ç±»å‹ç­‰ç­‰ã€‚</p>
</blockquote>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>å¯¹äºåœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¿‡ Swift çš„äººæ¥è¯´ï¼Œ<code>Result</code> ç±»å‹åº”è¯¥å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œåœ¨ community ä¸­æœ‰ç€éå¸¸å¹¿æ³›çš„åº”ç”¨ã€‚æœ€æ—©çœ‹åˆ°å¯¹äº <code>Result</code> çš„åº”ç”¨æ˜¯åœ¨<a href="https://github.com/Alamofire/Alamofire" target="_blank" rel="noopener">Alamofire</a> ä¸­ï¼Œç„¶åæ˜¯æœ‰è®¢é˜…çš„åšå®¢å¼€å§‹ä»‹ç» <code>Result</code> æ˜¯å¦‚ä½•å¸®å¿™è§£å†³éå¿…è¦çš„é”™è¯¯å€¼/å¯é€‰å€¼æ£€æŸ¥ï¼Œæ˜ç¡®çš„åŒºåˆ†æˆåŠŸå’Œå¤±è´¥ã€‚å†åæ¥å°±æ˜¯å¤§å®¶éƒ½å¼€å§‹åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ <code>Result</code> ç±»å‹æ¥è¿›è¡Œ <strong>å¼‚æ­¥é”™è¯¯å¤„ç†</strong>ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¯´ <strong>å¼‚æ­¥é”™è¯¯å¤„ç†</strong> å‘¢ï¼Œå› ä¸ºæœ€æ—©æ¥è§¦åˆ° <code>Result</code> è¿™ä¸ªç±»å‹çš„ä½¿ç”¨æ¡ˆä¾‹ï¼Œå°±æ˜¯ç”¨æ¥å¤„ç†å¼‚æ­¥é”™è¯¯çš„ï¼Œå¹¶ä¸”å®ƒéå¸¸çš„é€‚åˆï¼Œå¦‚æœä¸ä»è¯­è¨€è®¾è®¡ä¸Šè€ƒè™‘çš„è¯ï¼Œå®ƒå¯ä»¥è¯´æ˜¯éå¸¸å®Œç¾ï¼Œå› ä¸ºå®ƒå’Œ <code>Optional</code> ä¸€æ ·æ˜¯ä¸ª Monadã€‚è™½ç„¶ <code>Result</code> åªæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ•°æ®ç»“æ„ï¼Œå®ƒå’ŒåŒæ­¥å¼‚æ­¥ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œå®ƒåªè·Ÿé”™è¯¯å¤„ç†æœ‰å…³ã€‚</p>
<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>é”™è¯¯å¤„ç†æŒ‰æ‰§è¡Œé¡ºåºä¸Šå¯ä»¥åˆ†ä¸ºåŒæ­¥ï¼ˆsynchronizationï¼‰å’Œå¼‚æ­¥ï¼ˆconcurrencyï¼‰ä¸¤ç§ã€‚</p>
<p>åŒæ­¥é”™è¯¯å¤„ç†åœ¨ Cocoa ä¸­æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ <code>throw</code> + <code>try catch</code>ï¼Œé‡åˆ°å¼‚å¸¸çš„æ—¶å€™å‡½æ•°å†…éƒ¨é€šè¿‡ <code>throw</code>/<code>raise</code>ç­‰å…³é”®è¯æŠŠå¼‚å¸¸ä¿¡æ¯æŠ›å‡ºï¼Œè°ƒç”¨æ–¹é€šè¿‡ <code>try catch</code> è¿›è¡Œæ•è·ã€‚å¦ä¸€ç§æ˜¯å¤è€çš„ C ä¸­çš„ Error æŒ‡é’ˆï¼Œè°ƒç”¨æ–¹é€šè¿‡æŠŠ Error æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ åˆ°å‡½æ•°å†…éƒ¨ï¼Œå½“é‡åˆ°é”™è¯¯æ—¶ï¼Œç»™ Error æŒ‡é’ˆèµ‹å€¼ï¼Œä»¥è¾¾åˆ°æŠŠé”™è¯¯ä¿¡æ¯å¾€å¤–ä¼ é€’çš„ç›®çš„ã€‚</p>
<p>å¼‚æ­¥é”™è¯¯å¤„ç†åœ¨ Cocoa ä¸­ä¸€èˆ¬æ˜¯é€šè¿‡ block, delegate æˆ–è€… notification ç­‰æ–¹å¼è¿›è¡Œä¼ é€’ï¼Œä½†å¤§å¤šæ•°æ¥å£é€šå¸¸ä¼šæŠŠæ­£å¸¸ç»“æœå›è°ƒå’Œå¼‚å¸¸ç»“æœå›è°ƒåˆå¹¶ä¸€èµ·è¿›è¡Œå›è°ƒï¼Œå¥½å¤„åœ¨äºä¸éœ€è¦ä¸¤ä¸ª block æˆ–è€…ä¸¤ä¸ª delegate å‡½æ•°æˆ–è€… notificationï¼Œç¼ºç‚¹ä¹Ÿå°±æ˜¯ä¸Šé¢çš„ <code>Result</code> è§£å†³çš„é—®é¢˜ã€‚é™¤æ­¤ä¹‹å¤–ä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒå°‘è§çš„æ–¹å¼ï¼Œæ¯”å¦‚ <a href="https://developer.apple.com/documentation/avfoundation/avassetexportsession" target="_blank" rel="noopener">AVAssetExportSession</a>ï¼Œå®ƒçš„ <code>completionHandler</code> æ˜¯ <code>@escaping () -&gt;  Void</code>ï¼Œå¹¶ä¸æºå¸¦ä»»ä½•æ­£å¸¸å’Œé”™è¯¯çš„ä¿¡æ¯ï¼Œè€Œæ˜¯é€šè¿‡ <code>var status: AVAssetExportSession.Status</code> å’Œ <code>var error: Error?</code> ç­‰å±æ€§æ¥æä¾›ã€‚</p>
<p>æŠ›å¼€é¥é¥æ— æœŸçš„ async/await ä¸è°ˆï¼Œå¯¹äºå¼‚æ­¥é”™è¯¯å¤„ç†æ¥è¯´ï¼Œå¯èƒ½ç”±äºç½‘ç»œåº“ä¹‹ç±»çš„æ¥è§¦çš„å¤ªå¤šï¼Œæ‰€ä»¥å¹³æ—¶å»è®¾è®¡ API çš„æ—¶å€™éƒ½éå¸¸çš„é¡ºæ‰‹çš„å°±å†™å‡ºæ¥äº†ï¼Œè¦ä¹ˆ <code>completionHandler: (Value?, Error?) -&gt; Void</code>ï¼Œè¦ä¹ˆ <code>completionHandler: (Result&lt;Value&gt;) -&gt; Void</code>ã€‚ä½†æ˜¯å¯¹äºåŒæ­¥é”™è¯¯å¤„ç†å´ä¸æ˜¯è¿™æ ·ã€‚</p>
<p>é¦–å…ˆåœ¨ Swift ä¸­æ¨èçš„é”™è¯¯å¤„ç†æ˜¯ <code>throw</code> + <code>try catch</code>ï¼Œæ‰€ä»¥ Error æŒ‡é’ˆæ˜¯ä¸éœ€è¦å†è®¨è®ºçš„ã€‚ä½†ä¸çŸ¥é“æ˜¯å› ä¸º <code>throw</code> + <code>try catch</code> éš¾ç”¨ï¼Œè¿˜æ˜¯å› ä¸ºæ‡’ï¼Œä¸€èˆ¬çš„é¡¹ç›®ä¸­å…¶å®å¾ˆå°‘è§åˆ° <code>throw/throws/rethrows</code> è¿™æ ·çš„å…³é”®è¯ï¼ˆObjC ä¸­å¾ˆå°‘è§åˆ° throw/raise åŒç†ï¼‰ã€‚</p>
<p>æ³¨ï¼šå¼‚æ­¥ä¸­æ˜¯æ— æ³•ç›´æ¥ä½¿ç”¨ <code>throw</code> + <code>try catch</code>ï¼Œä¸‹é¢çš„ä¸¤ç§å†™æ³•éƒ½æ˜¯ä¸åˆæ³•çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(forKey key: StoreKey)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    queue.async &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="keyword">try</span> disk.url(atPath: path(forKey: key), <span class="keyword">in</span>: directory)</span><br><span class="line">        <span class="keyword">try</span> disk.remove(at: url)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(forKey key: StoreKey)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> queue.async &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="keyword">try</span> disk.url(atPath: path(forKey: key), <span class="keyword">in</span>: directory)</span><br><span class="line">        <span class="keyword">try</span> disk.remove(at: url)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‡æ¶çš„-return"><a href="#ä¸‡æ¶çš„-return" class="headerlink" title="ä¸‡æ¶çš„ return"></a>ä¸‡æ¶çš„ return</h3><p>ä¸€ä¸ªå½“å‰åœ¨åšçš„ Alligator é¡¹ç›®ä¸­çš„ä»£ç ç‰‡æ®µï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// è§†é¢‘å¯¼å‡º</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter asset: è¦å¯¼å‡ºçš„è§†é¢‘èµ„æº</span></span><br><span class="line"><span class="comment">/// - Parameter outputURL: æŒ‡å®šçš„å¯¼å‡ºåœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">export</span><span class="params">(asset: AVAsset, to outputURL: URL)</span></span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> outputURL.isFileURL <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">"output url must be file url."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> exportSession = <span class="type">AVAssetExportSession</span>(asset: asset, presetName: <span class="type">AVAssetExportPresetHighestQuality</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    exportSession.outputURL = outputURL</span><br><span class="line">    exportSession.outputFileType = .mp4</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°çš„å¤§æ¦‚åŠŸèƒ½æ˜¯è¿›è¡Œé…ç½®å’Œå¯¼å‡ºè§†é¢‘åˆ°æ–‡ä»¶ï¼Œçœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿæœ‰å‚èµ›åˆæ³•æ€§çš„åˆ¤æ–­ï¼Œæä¾›å¼€å‘è°ƒè¯•å¸®åŠ©çš„ assertionï¼Œ<code>guard</code> çš„ä½¿ç”¨ä¹Ÿå¾ˆåˆç†ã€‚</p>
<p>å†çœ‹ä¸€æ®µï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VideoProcessor.swift</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> videoWriterInput = </span><br><span class="line">    <span class="keyword">let</span> audioWriterInput = </span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> videoWriter = <span class="keyword">try</span>? <span class="type">AVAssetWriter</span>(outputURL: outputURL, fileType: .mp4) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> videoWriter.canAdd(videoWriterInput) &#123;</span><br><span class="line">        videoWriter.add(videoWriterInput)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">"can't add video writer input"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> videoWriter.canAdd(audioWriterInput) &#123;</span><br><span class="line">        videoWriter.add(audioWriterInput)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">assertionFailure</span>(<span class="string">"can't add audio writer input"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼è¿™æ ·çš„ä»£ç åœ¨ project ä¸­åº”è¯¥éå¸¸å¸¸è§ï¼Œä½†æ˜¯å´æœ‰ç€éå¸¸å¤§çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ <strong>æ•…æ„çš„å¿½ç•¥å¼‚å¸¸</strong>ã€‚åªå¤„ç†äº†ä¸€åˆ‡æ­£å¸¸æ‰§è¡Œçš„åˆ†æ”¯ï¼Œå½“é‡åˆ°å¼‚å¸¸çš„æ—¶å€™ï¼Œç›´æ¥ return æˆ–æ˜¯åŠ ä¸Š assertion ä¿¡æ¯ã€‚è¿™æ ·å†™å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼ŒåŠŸèƒ½ä¹Ÿæ­£å¸¸ï¼Œå³ä½¿æ˜¯é‡åˆ°äº†å¼‚å¸¸æƒ…å†µï¼Œä¹Ÿä¸ä¼šå¼•èµ· crashï¼Œä½†å´æœ‰ç€å¾ˆå¤§çš„ç¼ºé™·ã€‚ï¼ˆç”šè‡³æœ‰å¾ˆå¤šäººè¿ assertion éƒ½ä¸ç”¨ï¼Œæ›¿è€Œä»£ä¹‹çš„æ˜¯ <code>print</code> :P</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­è¿™äº›è§†é¢‘å¤„ç†çš„é€»è¾‘å®é™…ä¸Šæ˜¯ç›¸å¯¹æ¯”è¾ƒç‹¬ç«‹çš„ï¼ŒåŠŸèƒ½ä¹Ÿæ¯”è¾ƒâ€å•ä¸€â€ï¼Œè¿™äº›å¼‚å¸¸ä¸€æ—¦å‡ºç°ï¼Œåç»­çš„é€»è¾‘åŸºæœ¬éƒ½æ˜¯ä¸å¯ç”¨ï¼Œå¹¶ä¸”å¤§å¤šæ•°çš„å¼‚å¸¸åœ¨å®é™…åº”ç”¨ä¸­æ˜¯éœ€è¦è¢«è°ƒç”¨æ–¹çŸ¥é“å¹¶å¤„ç†çš„ï¼Œæ¯”å¦‚ä½“ç°åœ¨ UI ä¸Šã€‚</p>
<p>ä¸€ä¸ªå¸¦å¼‚å¸¸å¤„ç†ï¼ˆæ»‘ç¨½ï¼‰çš„è§†é¢‘å¤„ç†çš„ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AVAsset+Processor.swift</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Alligator</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">AVAsset</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Merge the given video asset and audio asset</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - videoAsset: the given video asset</span></span><br><span class="line">    <span class="comment">///   - audioAsset: the given audio asset</span></span><br><span class="line">    <span class="comment">/// - Returns: the merged asset</span></span><br><span class="line">    <span class="comment">/// - Throws: throws error when the given asset is invalid. e.g. video asset without video tracks.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(videoAsset: AVAsset, audioAsset: AVAsset)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">AVAsset</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> mixComposition = <span class="type">AVMutableComposition</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> mixComposition.agt.add(.video, from: videoAsset)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> videoDuration = mixComposition.duration</span><br><span class="line">        <span class="keyword">try</span> mixComposition.agt.add(.audio, from: audioAsset, maxBounds: videoDuration)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mixComposition</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Merge the given assets one by one</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameters:</span></span><br><span class="line">    <span class="comment">///   - segments: given assets, it can't be empty</span></span><br><span class="line">    <span class="comment">///   - isMuted: if true, it will passthrough audio tracks</span></span><br><span class="line">    <span class="comment">/// - Returns: merged asset</span></span><br><span class="line">    <span class="comment">/// - Throws: throws error when segments is empry, or some segment is invalid.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(segments: [AVAsset], isMuted: Bool)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">AVAsset</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> !segments.isEmpty <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">Error</span>.segmentsEmpty</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> segments.<span class="built_in">count</span> &gt; <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> mixComposition = <span class="type">AVMutableComposition</span>()</span><br><span class="line">            <span class="keyword">try</span> mixComposition.agt.add(segments, isMuted: isMuted)</span><br><span class="line">            <span class="keyword">return</span> mixComposition</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> segments[<span class="number">0</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ— è„‘çš„-Optional"><a href="#æ— è„‘çš„-Optional" class="headerlink" title="æ— è„‘çš„ Optional"></a>æ— è„‘çš„ Optional</h3><p>æ— è„‘çš„ Optional æŒ‡çš„æ˜¯ï¼Œå¯¹äºä¸€ä¸ªæœ‰æ˜ç¡®è¿”å›å€¼ç±»å‹ <code>T</code> çš„å‡½æ•°ï¼Œæœ‰å¯èƒ½å‡ºç°æŸä¸ªå…¥å‚ä¸ç¬¦åˆè¦æ±‚çš„æƒ…å†µï¼Œå°±æŠŠè¿”å›å€¼æ”¹æˆ <code>T?</code>ï¼Œç”¨ <code>return nil</code> æ¥å¤„ç†å¼‚å¸¸ã€‚å¦‚ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Format a string, replace invalid symbol with empty character</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter string: string needs to be format</span></span><br><span class="line">    <span class="comment">/// - Returns: formatted string</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">format</span><span class="params">(<span class="number">_</span> string: String)</span></span> -&gt; <span class="type">String?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> string.isEmpty <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> string.replacingOccurrences(of: <span class="string">"\n"</span>, with: <span class="string">""</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åº”è¯¥å¤§å¤šæ•°äººéƒ½è¯•è¿‡è¿™æ ·ï¼Œå¹¶ä¸”ç”šè‡³æœ‰äººä¸€ç›´éƒ½æ˜¯è¿™æ ·ï¼Œä¸ç»æ€ç´¢ã€‚æœ‰äººä¼šè§‰å¾—è¿™æ ·å†™å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚é‚£ä¹ˆå†çœ‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Format a string, replace invalid symbol with empty character. If it is empty or contains `@`, `#`, return nil.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter string: string needs to be format</span></span><br><span class="line">    <span class="comment">/// - Returns: formatted string</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">format</span><span class="params">(<span class="number">_</span> string: String)</span></span> -&gt; <span class="type">String?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> string.isEmpty <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> !string.<span class="built_in">contains</span>(<span class="string">"@"</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> !string.<span class="built_in">contains</span>(<span class="string">"#"</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> string.replacingOccurrences(of: <span class="string">"\n"</span>, with: <span class="string">""</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å†™æœ‰æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿæˆ–è€…è¯´æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Error</span>: <span class="title">Swift</span>.<span class="title">Error</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> emptyString</span><br><span class="line">        <span class="keyword">case</span> containsHashtag</span><br><span class="line">        <span class="keyword">case</span> containsMention</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Format a string, replace invalid symbol with empty character</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Parameter string: string needs to be format</span></span><br><span class="line">    <span class="comment">/// - Returns: formatted string</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">format</span><span class="params">(<span class="number">_</span> string: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> string.isEmpty <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">Error</span>.emptyString</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> !string.<span class="built_in">contains</span>(<span class="string">"@"</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">Error</span>.containsMention</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> !string.<span class="built_in">contains</span>(<span class="string">"#"</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">Error</span>.containsHashtag</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> string.replacingOccurrences(of: <span class="string">"\n"</span>, with: <span class="string">""</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®è¿™ä¸ªé—®é¢˜å¯ä»¥å½’ä¸ºï¼Œ<strong>å¯¹äºåŒæ­¥ API çš„å¼‚å¸¸å¤„ç†ï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨ throwï¼Ÿï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥è¿”å› nilï¼Ÿ</strong></p>
<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œå¹¶ä¸”å¤§å¤šæ•°æƒ…å†µä¸‹éœ€è¦æ ¹æ®åœºæ™¯æ¥é€‰æ‹©ã€‚é€šè¿‡å¯¹æ¯”è¿™ä¸¤ç§è®¾è®¡ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºå¦‚æœå¸Œæœ›ä½¿ç”¨æ–¹ä»¥æ›´åŠ åˆé€‚çš„æ–¹å¼æ¥å¤„ç†é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯åˆ†ç±»æ¸…æ™°è¯¦ç»†ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ <code>throw</code>ã€‚æ˜¯å¦éœ€è¦éšè—å¼‚å¸¸ï¼Œäº¤ç»™ä½¿ç”¨æ–¹æ¥å†³å®šã€‚å¦‚æœé”™è¯¯æ¯”è¾ƒå•ä¸€æ˜ç¡®ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>Optional</code>ã€‚</p>
<h3 id="æ··æ·†çš„äººä¸ºé”™è¯¯å’Œç¨‹åºé”™è¯¯"><a href="#æ··æ·†çš„äººä¸ºé”™è¯¯å’Œç¨‹åºé”™è¯¯" class="headerlink" title="æ··æ·†çš„äººä¸ºé”™è¯¯å’Œç¨‹åºé”™è¯¯"></a>æ··æ·†çš„äººä¸ºé”™è¯¯å’Œç¨‹åºé”™è¯¯</h3><p>ç®€å•æ¥è¯´å¯¹äºäººä¸ºé”™è¯¯ï¼Œåº”è¯¥é€šè¿‡ <code>assertion</code>, <code>precondition</code>, <code>fatalError</code> ç­‰æ¥å¸®åŠ©åœ¨å¼€å‘æµ‹è¯•é˜¶æ®µå‘ç°é—®é¢˜ã€‚è€Œå¯¹äºç¨‹åºé”™è¯¯ï¼Œåº”è¯¥æ ¹æ®åŒæ­¥æˆ–è€…å¼‚æ­¥æ¥åŒºåˆ†å¤„ç†ï¼Œä½¿å¾—ç¨‹åºèƒ½ç»§ç»­æ­£å¸¸çš„å·¥ä½œã€‚</p>
<p>äººä¸ºé”™è¯¯ä¸€èˆ¬æ˜¯æŒ‡æ‰‹è¯¯å‚æ•°ä¼ é”™è¿™ç§ï¼Œå¦‚æœæ²¡æœ‰æ‰‹è¯¯ï¼ˆæ¯”å¦‚æ‹¼é”™å•è¯ã€ä¸‹æ ‡è¶Šç•Œç­‰ï¼‰ï¼Œä»é€»è¾‘ä¸Šè¯´ä¸å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="string">"cell"</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">else</span> &#123;</span><br><span class="line">        fataError(<span class="string">"ä¸åº”è¯¥å•Šå…„å¼Ÿ"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cell</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¨‹åºé”™è¯¯æ›´å¤šæ˜¯æŒ‡æ‰€æœ‰å‚æ•°éƒ½æ²¡æœ‰é”™è¯¯ï¼Œä½†è¿˜æ˜¯é‡åˆ°å¼‚å¸¸äº†ï¼Œå¹¶ä¸”ä¸èƒ½å¿½ç•¥ï¼Œæ¯”å¦‚ç£ç›˜æ»¡äº†å¯¼è‡´æ— æ³•å†™å…¥æ–‡ä»¶ã€‚</p>
<blockquote>
<p>æœ€åå€¼å¾—ä¸€æçš„å°±æ˜¯å¤§å¤šæ•°äººåœ¨å†™ ObjC çš„æ—¶å€™éƒ½ä¼šé€‰æ‹©æ€§çš„å¿½ç•¥å¼‚å¸¸ï¼Œç»å…¸çš„åœºæ™¯å°±æ˜¯è®¾è®¡ API çš„æ—¶å€™æ»¥ç”¨ <code>id</code>ï¼Œç„¶åè™½ç„¶åœ¨æ–¹æ³•å†…éƒ¨å¯¹å‚æ•°ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œä½†åœ¨å‡ºç°å‚æ•°ç±»å‹ä¸åˆæ³•çš„æ—¶å€™ï¼Œç›´æ¥é€šè¿‡ <code>return</code> æ¥å¤„ç†ã€‚</p>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://github.com/apple/swift-package-manager/blob/master/Sources/Basic/Result.swift" target="_blank" rel="noopener">Swift Package Manager</a><br><a href="https://onevcat.com/2018/10/swift-result-error/" target="_blank" rel="noopener">Result&lt;T&gt; è¿˜æ˜¯ Result&lt;T, E: Error&gt;</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2018/08/26/logging-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/26/logging-system/" itemprop="url">How to design a lightweight Logging System</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-08-26T20:00:00+08:00">
                2018-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-swift/" itemprop="url" rel="index">
                    <span itemprop="name">advanced swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>ä¹‹å‰é¡¹ç›®ä¸€ç›´éƒ½æ˜¯ä½¿ç”¨ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack" target="_blank" rel="noopener">CocoaLumberjack</a> æ¥å®šåˆ¶ Log ç³»ç»Ÿï¼Œè¿™æ¬¡æ•´ä¸ªå·¥ç¨‹ä½¿ç”¨ Pure-Swift æ¥å¼€å‘ï¼Œè€Œä¸”ä½œä¸ºä¸€ä¸ªåˆåˆ›é¡¹ç›®ï¼Œå¯¹äº Log ç³»ç»Ÿçš„éœ€æ±‚å¹¶æ²¡æœ‰é‚£ä¹ˆé«˜ï¼Œè™½ç„¶ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack" target="_blank" rel="noopener">CocoaLumberjack</a> åœ¨ Swift é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨ä¹Ÿæ¯”è¾ƒå‹å¥½ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯ <del>å¤ªé‡äº†</del> ã€‚æ‰€ä»¥ä¸ºä½•ä¸ç›´æ¥è®¾è®¡ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ—¥å¿—ç³»ç»Ÿå‘¢ï¼Ÿ</p>
</blockquote>
<h2 id="Logging-System"><a href="#Logging-System" class="headerlink" title="Logging System"></a>Logging System</h2><p>åœ¨ iOS ä¸­ï¼Œå¯ä»¥ç”¨ Swift ä¸­çš„ <code>print()</code> å’Œ <code>debugPrint()</code> å‡½æ•°æ¥å‘ Xcode Console æ¥æ‰“å°ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Foundation ä¸­çš„ <code>NSLog()</code> æ¥æ‰“å°ï¼Œæ›´æ–°çš„å°±æ˜¯ <a href="https://developer.apple.com/documentation/os/logging" target="_blank" rel="noopener">os_log</a> äº†ã€‚è¿™ä¸‰ç§ä¸åŒçš„æ–¹å¼æœ‰ä¸åŒçš„ç‰¹ç‚¹ã€‚</p>
<ul>
<li><strong>print</strong>/<strong>debugPrint</strong>: Swift è¯­è¨€å±‚é¢æä¾›çš„å®ç°ï¼Œå¯ä»¥è¾“å‡ºåˆ° Xcode Consoleï¼Œä½†ä¸èƒ½è¾“å‡ºåˆ° Apple System Logsï¼ˆMac Console.appï¼‰ã€‚</li>
<li><strong>NSLog</strong>: Foundation ä¸­çš„å®ç°ï¼Œé™¤äº†èƒ½åœ¨ Xcode Console ä¸­è¾“å‡ºå¤–ï¼Œè¿˜ä¼šå¾€ Console.app å‘ï¼Œå¹¶ä¸”æœ‰è¾ƒå¤§çš„æ€§èƒ½æŸå®³ã€‚</li>
<li><strong>os_log</strong>: å¾…è¡¥å…… <a href="https://developer.apple.com/videos/play/wwdc2016/721/" target="_blank" rel="noopener">Unified Logging and Activity Tracing - WWDC 2016 - Videos - Apple Developer</a> <a href="https://developer.apple.com/videos/play/wwdc2018/405/" target="_blank" rel="noopener">Measuring Performance Using Logging - WWDC 2018 - Videos - Apple Developer</a></li>
</ul>
<p>Xcode Console å’Œ Apple System Logs éƒ½æ˜¯éœ€è¦ç‰©ç†æ¥è§¦è®¾å¤‡æ‰èƒ½çœ‹åˆ° logã€‚ä½†æ˜¯åœ¨é¡¹ç›®ä¸­ï¼Œå¦‚æœæƒ³è¦çœ‹åˆ°çº¿ä¸Šç”¨æˆ·çš„ log ä¿¡æ¯ï¼Œå¿…é¡»è¦æŠŠè¿™äº› log å†™åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œæˆ–è€…å®æ—¶/å®šæ—¶å‘åˆ°è¿œç«¯æœåŠ¡å™¨ä¸Šã€‚è¿™æ—¶å€™ç›´æ¥ä½¿ç”¨å†…ç½®çš„ API æ˜¯æ— æ³•æ»¡è¶³éœ€æ±‚çš„ã€‚</p>
<p>å¯¹äºä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒåˆç†çš„æ—¥å¿—ç³»ç»Ÿï¼Œä¸€èˆ¬æœ‰å‡ ç‚¹è¦æ±‚ï¼š</p>
<ul>
<li>åœ¨ release ä¸‹ç¦æ­¢è¾“å‡ºæ—¥å¿—åˆ° Xcode Console</li>
<li><del>åœ¨ release ä¸‹</del> ç¦æ­¢è¾“å‡ºæ—¥å¿—åˆ° Apple System Logs</li>
<li>æä¾›è¾“å‡ºæ—¥å¿—åˆ°æœ¬åœ°æ–‡ä»¶ä¸­çš„èƒ½åŠ›</li>
<li>èƒ½å¤Ÿæ–¹ä¾¿çš„æ‰©å±•ï¼Œå¦‚ç›´æ¥è¾“å‡ºåˆ° Web</li>
<li>å¯¹äºæ—¥å¿—æ ¹æ®é‡è¦æ€§åˆ’åˆ†ä¸ºä¸åŒçš„ç­‰çº§</li>
<li>å¯ä»¥æ ¹æ®æ—¥å¿—ç­‰çº§ï¼Œè¿‡æ»¤æ—¥å¿—</li>
</ul>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><h3 id="Level"><a href="#Level" class="headerlink" title="Level"></a>Level</h3><p>Level æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>å®šä¹‰ä¸€æ¡æ—¥å¿—çš„é‡è¦æ€§</li>
<li>å¯¹æ—¥å¿—è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚è¿‡æ»¤æ‰æŸä¸ªç­‰çº§ä»¥ä¸‹çš„æ—¥å¿—ï¼ˆå®é™…æ˜¯æœ‰åŒ…å«çš„å…³ç³»</li>
</ul>
<p>è¿™é‡Œé€šè¿‡ä¸¤ä¸ªç±»å‹æ¥å®ç° level çš„ä½œç”¨ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Level</span>: <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> off = <span class="number">0</span></span><br><span class="line">    <span class="keyword">case</span> error = <span class="number">1</span> <span class="comment">// Flag.error | Level.off</span></span><br><span class="line">    <span class="keyword">case</span> warning = <span class="number">3</span> <span class="comment">// Flag.warning | Level.error</span></span><br><span class="line">    <span class="keyword">case</span> info = <span class="number">7</span> <span class="comment">// Flag.info | Level.warning</span></span><br><span class="line">    <span class="keyword">case</span> debug = <span class="number">15</span> <span class="comment">// Flag.debug | Level.info</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Flag</span>: <span class="title">OptionSet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> rawValue: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> error = <span class="type">Flag</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">0</span>) <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> warning = <span class="type">Flag</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">1</span>) <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> info = <span class="type">Flag</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">2</span>) <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> debug = <span class="type">Flag</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">3</span>) <span class="comment">// 8</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(rawValue: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.rawValue = rawValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Message-amp-Formatter"><a href="#Message-amp-Formatter" class="headerlink" title="Message &amp; Formatter"></a>Message &amp; Formatter</h3><p>ä¸€æ¡æ—¥å¿—å¦‚æœåªæœ‰æ­£æ–‡éƒ¨åˆ†ï¼Œå¾ˆéš¾å¸®åŠ©å®šä½å…·ä½“çš„ä½ç½®å’Œå‘ç”Ÿçš„æ—¶é—´ç‚¹ï¼Œæ‰€ä»¥ä¸€æ¡æ›´åŠ æœ‰æ„ä¹‰çš„æ—¥å¿—ï¼Œä¼šå¸¦ä¸Šæ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°ã€è¡Œæ•°ä»¥åŠæ—¶é—´æˆ³ç­‰ä¿¡æ¯ã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ª <code>Message</code> çš„æ•°æ®ç»“æ„æ¥å®šä¹‰ä¸€æ¡æ—¥å¿—ï¼Œè¿™äº›ä¿¡æ¯æœ€ç»ˆå…·ä½“å¦‚ä½• format æˆä¸€æ¡å­—ç¬¦ä¸²ï¼Œéœ€è¦æä¾›ä¸€ä¸ª <code>Formatter</code> æ¥å®ç°ã€‚</p>
<p>æ—¢ç„¶æ˜¯ Pure-Swiftï¼Œæ‰€ä»¥è¿™é‡Œ <code>Message</code> ä½¿ç”¨ <code>struct</code> ï¼ˆValue Typeï¼‰ï¼Œè€Œä¸æ˜¯ <code>class</code> ï¼ˆReference Typeï¼‰ã€‚ï¼ˆ<code>Codable</code>, <code>CustomStringConvertible</code>, <code>Equatable</code> ä»€ä¹ˆçš„æš‚æ—¶ä¸éœ€è¦è€ƒè™‘ã€‚</p>
<p>å¯¹äº <code>Formatter</code>ï¼Œå¯èƒ½ä¸åŒçš„ logger éœ€è¦ä¸åŒçš„ formatï¼Œæ¯”å¦‚è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶çš„ logger éœ€è¦æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ—¶é—´æˆ³ï¼Œæ‰å¥½å¸®åŠ©æ—¥åè¿˜åŸ app å½“æ—¶è¿è¡Œçš„æƒ…å†µï¼Œè€Œè¾“å‡ºåˆ° Xcode Console çš„æ—¥å¿—ä¸€èˆ¬æ˜¯åœ¨å¼€å‘çš„æ—¶å€™çœ‹çš„ï¼Œæ‰€ä»¥æ—¶é—´æˆ³å¯èƒ½å°±æ²¡é‚£ä¹ˆé‡è¦ã€‚ï¼ˆä¸ºä»€ä¹ˆ <code>Formatter</code> ä½¿ç”¨ <code>protocol</code>ï¼Ÿå¯ä»¥å…ˆæƒ³æƒ³ï¼Œåé¢å†è§£é‡Šã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> message: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> level: <span class="type">Level</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> flag: <span class="type">Flag</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> context: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> file: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> function: <span class="type">StaticString</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> line: <span class="type">UInt</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> timestamp: <span class="type">Date</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">format</span><span class="params">(message: Message)</span></span> -&gt; <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h3><p>æ ¹æ®æ—¥å¿—è¾“å‡ºçš„ç›®æ ‡ä¸åŒï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä¸åŒç±»å‹çš„ loggerï¼Œæ¯”å¦‚ <code>ConsoleLogger</code>ã€<code>FileLogger</code> ä»¥åŠ <code>WebLogger</code> ç­‰ã€‚æ¯ä¸€ç§ä¸åŒçš„ logger éƒ½æœ‰ä¸€äº›åŒæ ·çš„æ¥å£ï¼Œæ‰€ä»¥ç¬¬ä¸€ååº”æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°ç±»å‹çš„åˆ’åˆ†ä»¥åŠç›¸åŒæ¥å£ï¼ˆè¡Œä¸ºï¼‰çš„çº¦æŸã€‚</p>
<p>ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œé€šè¿‡ç»§æ‰¿æ¥å®ç°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> console</span><br><span class="line">        <span class="keyword">case</span> file</span><br><span class="line">        <span class="keyword">case</span> web</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> type: <span class="type">Type</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .console</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: String)</span></span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"must override this method in subclass."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsoleLogger</span>: <span class="title">Logging</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">open</span> <span class="keyword">var</span> type: <span class="type">Type</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .console</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: String)</span></span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">FileLogger</span>: <span class="title">Logging</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">open</span> <span class="keyword">var</span> type: <span class="type">Type</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .file</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: String)</span></span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨é¢å‘åè®®çš„æ€æƒ³ï¼Œé€šè¿‡åè®®æ¥çº¦æŸè¡Œä¸ºã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">Type</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: String)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ConsoleLogger</span>: <span class="title">Logging</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">Type</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .console</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: String)</span></span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileLogger</span>: <span class="title">Logging</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">Type</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .file</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: String)</span></span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸¤ç§ä¸åŒçš„å®ç°ï¼Œä½“ç°çš„æ˜¯ä¸¤ç§ä¸åŒçš„æ€æƒ³ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œé€šè¿‡ä¸€ä¸ªåŸºç±»æ¥æä¾›ç›¸åŒçš„æ¥å£ï¼Œç„¶åå­ç±»é‡å†™è¿™äº›æ¥å£æ¥æä¾›ä¸åŒçš„èƒ½åŠ›ï¼›</li>
<li>å¦ä¸€ç§æ˜¯ä½¿ç”¨é¢å‘åè®®çš„æ€æƒ³ï¼Œé€šè¿‡ä¸€ä¸ªåè®®æ¥å¯¹æ¥å£è¿›è¡Œçº¦æŸï¼Œæ¯ä¸€ä¸ªå…·ä½“çš„å®ç°éƒ½å¿…é¡»å®ç°è¿™äº›æ¥å£æ¥æä¾›ä¸åŒéƒ½èƒ½åŠ›ã€‚</li>
</ul>
<p>è€Œå¯¹äºä¸åŒç±»å‹çš„ logger éƒ½å…±æœ‰çš„è¡Œä¸ºï¼Œå‰ä¸€ç§æ–¹å¼å¯ä»¥ç›´æ¥åœ¨åŸºç±»ä¸­å®ç°ï¼Œåä¸€ç§æ–¹å¼å¯ä»¥é€šè¿‡ <code>protocol extension</code> æ¥æä¾›é»˜è®¤å®ç°ã€‚</p>
<p>ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œå¦‚æœä½ ä¹Ÿä¸å–œæ¬¢å‰ä¸€ç§ <strong>éœ€è¦è¿è¡Œæ—¶æ‰èƒ½çŸ¥é“å­ç±»å¿…é¡»é‡å†™çˆ¶ç±»çš„æŸä¸ªæ–¹æ³•</strong>ï¼Œå®Œå…¨ä¸èƒ½ä½“ç°å‡º Swift ä½œä¸ºä¸€é—¨æœ‰ç€å¼ºå¤§ç±»å‹å®‰å…¨çš„é™æ€è¯­è¨€çš„ä¼˜åŠ¿ï¼Œé‚£ä¹ˆè¿™é‡Œæ¯«ä¸çŠ¹è±«çš„é€‰æ‹©åä¸€ç§æ–¹å¼ã€‚ï¼ˆä¸è§£é‡Š</p>
<p>å¯¹äºè¿™é‡Œçš„ <code>Type</code>ï¼Œè™½ç„¶ä½¿ç”¨ <code>enum</code> æœ‰ç€å¾ˆå¥½çš„å¼ºç±»å‹ä¿¡æ¯ï¼Œä½†è¿™æ ·å†™æœ‰ç€å¾ˆå¤§çš„çº¦æŸï¼Œå°±æ˜¯ä¸€å¼€å§‹å°±å¿…é¡»å®šä¹‰å¥½æ‰€æœ‰çš„ Typeï¼Œå¯¹äºæ‰©å±•æ€§æ¥è¯´ï¼Œéå¸¸ä¸å‹å¥½ã€‚</p>
<p>æ‰€ä»¥ç»¼åˆå¯æ‰©å±•æ€§å’Œ <code>Type</code> çš„ä½œç”¨è€ƒè™‘ï¼Œè¿™é‡Œé€šè¿‡æ·»åŠ ä¸€ä¸ª <code>String</code> ç±»å‹çš„å±æ€§ <code>name</code> æ¥ç®€å•çš„åŒºåˆ†ã€‚ï¼ˆå¾ˆæ–¹ä¾¿äº debug</p>
<h3 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h3><p>æœ€ç»ˆå¾—åˆ°ä¸€æ•´ä¸ª Logging ç›¸å…³çš„æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> formatter: <span class="type">Formatter</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> level: <span class="type">Level</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(message: Message)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">flush</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">teardown</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Unified"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">flush</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">teardown</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Logger"><a href="#Logger" class="headerlink" title="Logger"></a>Logger</h3><p>å‰é¢å®šä¹‰äº†æ¯ä¸ªä¸åŒ <code>logger</code> çš„æ¥å£ï¼ˆè¡Œä¸ºï¼‰ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœéœ€è¦æ‰‹åŠ¨è°ƒç”¨æ¯ä¸ª <code>logger</code> çš„ <code>log(message:)</code> æ–¹æ³•ï¼Œé‚£å°±å¤ªæ²¡æœ‰æ„ä¹‰äº†ã€‚æ‰€ä»¥éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œæ¥ç®¡ç†æ‰€æœ‰çš„ <code>logger</code>ï¼Œå¹¶ä¸”å°†æ¶ˆæ¯è½¬å‘åˆ°æ¯ä¸€ä¸ª <code>logger</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">Logger</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> queue = <span class="type">DispatchQueue</span>(label: <span class="string">"com.xspyhack.logger.queue"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> loggers: <span class="type">Set</span>&lt;<span class="type">AnyLogger</span>&gt; = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        loggers.forEach &#123;</span><br><span class="line">            $<span class="number">0</span>.teardown()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loggers = []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> logger: Logging)</span></span> &#123;</span><br><span class="line">        loggers.update(with: logger)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(message: Message, asynchronous: Bool)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> work = <span class="type">DispatchWorkItem</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.loggers.forEach &#123; logger <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">guard</span> message.flag.rawValue &amp; logger.level.rawValue != <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                logger.log(message: message)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> asynchronous &#123;</span><br><span class="line">            queue.async(execute: work)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            queue.sync(execute: work)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        loggers.forEach &#123;</span><br><span class="line">            $<span class="number">0</span>.start()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">flush</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> work = <span class="type">DispatchWorkItem</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.loggers.forEach &#123; logger <span class="keyword">in</span></span><br><span class="line">                logger.flush()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        queue.sync(execute: work)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåªæ˜¯æ¯”è¾ƒç²—ç³™çš„å®ç°ï¼Œå¾ˆå¤šç»†èŠ‚è¿˜æ²¡æœ‰å¤„ç†ï¼Œæ¯”å¦‚ <code>loggers</code> çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€ä»¥åŠ <code>logger</code> çš„åˆ é™¤ç­‰ç­‰ã€‚</p>
<h3 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h3><p>æœ‰äº† <code>Logging</code> æ¥å®šä¹‰æ¯ä¸€ç§ä¸åŒä½œç”¨çš„ <code>logger</code>ï¼Œä»¥åŠä¸€ä¸ªç®¡ç†æ‰€æœ‰ <code>logger</code> çš„ç®¡ç†å™¨ <code>Logger</code>ï¼ˆè‡³äºè¿™ä¸ªè®©äººæ‡µé€¼çš„å‘½åï¼Œå®é™…æ˜¯å› ä¸ºæ‡’ï¼Œå–ä¸€ä¸ªåˆ«çš„åå­—æ¯”è¾ƒé€‚åˆï¼Œæ¯”å¦‚ <del>Charmander</del>ï¼‰ï¼Œè¿˜éœ€è¦è€ƒè™‘æœ€ç»ˆå¦‚ä½•ç®€å•çš„ä½¿ç”¨è¿™ä¸ª Logging Systemã€‚</p>
<p>ç°åœ¨å¦‚æœè¦ä½¿ç”¨è¿™ä¸ªç³»ç»Ÿï¼Œé¦–å…ˆéœ€è¦å®ç°è‡ªå·±çš„å¤šç§ <code>loggers</code> å’Œå¯¹åº”çš„ <code>Formatter</code>ï¼Œç„¶åæ·»åŠ åˆ° <code>Logger</code> é‡Œé¢ï¼Œç„¶ååœ¨éœ€è¦æ‰“ log çš„åœ°æ–¹ï¼Œåˆå§‹åŒ– ä¸€ä¸ª <code>Message</code>ï¼Œè°ƒç”¨ <code>Logger.shared.log(message:)</code> æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œæ¯æ¬¡åˆå§‹åŒ–ä¸€ä¸ª <code>Message</code> å¤ªéº»çƒ¦äº†ã€‚å¦‚ä½•ç®€åŒ–ï¼Ÿé»˜è®¤å‚æ•°å•Šã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">(<span class="number">_</span> message: @autoclosure <span class="params">()</span></span></span> -&gt; <span class="type">String</span>, level: <span class="type">Level</span>, flag: <span class="type">Flag</span>, context: <span class="type">Int</span> = <span class="number">0</span>, file: <span class="type">String</span> = #file, function: <span class="type">StaticString</span> = #function, line: <span class="type">UInt</span> = #line, asynchronous: <span class="type">Bool</span> = <span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> message = <span class="type">Message</span>(message: message(), level: level, flag: flag, context: context, file: file, function: function, line: line, timestamp: <span class="type">Date</span>())</span><br><span class="line"></span><br><span class="line">    <span class="type">Logger</span>.shared.log(message: message, asynchronous: asynchronous)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº <code>level</code> å’Œ <code>flag</code> å¦‚æœèƒ½æä¾›é»˜è®¤å‚æ•°ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥åƒ <code>print</code> ä¸€æ ·ï¼Œç›´æ¥åªå…³æ³¨è¦ log çš„å†…å®¹å°±å¥½äº†ã€‚ä¸€ä¸ªæ¯”è¾ƒç®€å•ç›´æ¥çš„æ–¹æ³•ï¼Œå°±æ˜¯é’ˆå¯¹è¿™å‡ ç§ <code>level</code> æš´éœ²å¤šä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Log</span>.d(<span class="string">"This is a debug level log"</span>)</span><br><span class="line"><span class="type">Log</span>.i(<span class="string">"This is an info level log"</span>)</span><br><span class="line"><span class="type">Log</span>.w(<span class="string">"This is a warning level log"</span>)</span><br><span class="line"><span class="type">Log</span>.e(<span class="string">"This is an error level log"</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸€ä¸ªæ€è€ƒï¼Œä¸Šé¢çš„ <code>log</code> å‡½æ•°ä¸­å‚æ•° message çš„ç±»å‹ä¸ºä»€ä¹ˆä½¿ç”¨ <code>@autoclosure</code>ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>ç¬¬äºŒä¸ªæ€è€ƒï¼Œ<code>Swift.print</code> å‡½æ•°çš„å®šä¹‰ä½ çŸ¥é“å—ï¼Ÿ</p>
</blockquote>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p><a href="https://github.com/xspyhack/Keldeo" target="_blank" rel="noopener">GitHub - xspyhack/Keldeo: A lightweight logging library written in Swift.</a></p>
<h3 id="Why-AnyLogger"><a href="#Why-AnyLogger" class="headerlink" title="Why AnyLogger"></a>Why AnyLogger</h3><p>å¯¹äºå¼•å…¥ <code>AnyLogger</code>ï¼Œæ˜¯å› ä¸ºæˆ‘å¸Œæœ›èƒ½å¤Ÿæä¾›ç§»é™¤ä¸€ä¸ª <code>logger</code> çš„èƒ½åŠ›ï¼Œç”¨å¤„å°±æ˜¯å½“æˆ‘åœ¨è„±ç¦» Xcode çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ä¸€ç§å¯ä»¥è¾“å‡ºåˆ°æµè§ˆå™¨çš„ <code>logger</code> æ¥å®æ—¶çœ‹åˆ°æ—¥å¿—è¾“å‡ºã€‚è€Œè¿™ä¸ªåä¸º <code>WebLogger</code> çš„ <code>logger</code> å¹³æ—¶å¹¶ä¸ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥å®ƒæ˜¯éœ€è¦çš„æ—¶å€™æ‰æ·»åŠ è¿›å»ï¼Œç”¨å®Œä¹‹åä¾¿ç§»é™¤ï¼Œæ‰€ä»¥å°±æ¶‰åŠåˆ° <code>logger</code> å¿…é¡»å®ç° <code>Equatable</code>ï¼Œå®ç°ä» <code>loggers</code> é‡Œé¢ç§»é™¤å®ƒã€‚</p>
<blockquote>
<p>Why <code>protocol Logging: Equatable {}</code> needs <code>AnyLogger</code>ï¼Ÿè§å¦ä¸€ç¯‡ <a href="http://blessingsoft.com/2018/08/26/pats/">PATs</a></p>
</blockquote>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li><a href="https://github.com/CocoaLumberjack/CocoaLumberjack" target="_blank" rel="noopener">GitHub - CocoaLumberjack/CocoaLumberjack: A fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS</a></li>
<li><a href="https://github.com/onevcat/Kingfisher/blob/master/Sources/ImageCache.swift" target="_blank" rel="noopener">Kingfisher/ImageCache.swift at master Â· onevcat/Kingfisher Â· GitHub</a></li>
<li><a href="https://github.com/apple/swift/blob/swift-3.0-branch/stdlib/public/core/AnyHashable.swift" target="_blank" rel="noopener">swift/AnyHashable.swift at swift-3.0-branch Â· apple/swift Â· GitHub</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2018/08/26/pats/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/26/pats/" itemprop="url">PATs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-08-26T20:00:00+08:00">
                2018-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/advanced-swift/" itemprop="url" rel="index">
                    <span itemprop="name">advanced swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>æ›´æ–°ï¼šéšç€ Swift ä¸­ä¸€äº›æ–°çš„ææ¡ˆï¼ˆå¦‚ <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0309-unlock-existential-types-for-all-protocols.md" target="_blank" rel="noopener">SE-0309</a> å’Œ <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0335-existential-any.md" target="_blank" rel="noopener">SE-0335</a>ï¼‰çš„æå‡ºï¼Œå¤§å¤§çš„ç®€åŒ–äº† Swift ä¸­çš„ Protocol çš„ä½¿ç”¨ï¼Œæ–‡ä¸­çš„ä¸€äº›æ¦‚å¿µæˆ–è€…è§‚ç‚¹æŠ‘æˆ–æ˜¯å†™æ³•å·²ç»æ˜¾å¾—è½åè€Œä¸é€‚ç”¨ã€‚â€“2022.01.01</p>
</blockquote>
<blockquote>
<p>å¾ˆä¹…æ²¡æœ‰å†™ Swift äº†ï¼Œé—²ç€å†™å‡ è¡Œç©ç©çš„æ—¶å€™ï¼Œé‡åˆ°äº†ä¸€ä¸ªä¹‹å‰æ²¡æœ‰æ¥è§¦è¿‡çš„é—®é¢˜â€”â€”Protocol with Associated Types</p>
</blockquote>
<h2 id="Protocol-Oriented-Programming"><a href="#Protocol-Oriented-Programming" class="headerlink" title="Protocol-Oriented Programming"></a>Protocol-Oriented Programming</h2><p>é¦–å…ˆ Swift æ˜¯ä¸€ä¸ª <strong>æ”¯æŒ</strong> é¢å‘åè®®ç¼–ç¨‹æ€æƒ³çš„è¯­è¨€ï¼Œå¹¶ä¸” <a href="https://github.com/apple/swift" target="_blank" rel="noopener">Standard Library</a> ä¹Ÿæ˜¯å¤§é‡ä½¿ç”¨è¿™ç§æ€æƒ³æ¥å®ç°å¾ˆå¤šçš„ç‰¹æ€§ã€‚ï¼ˆè¿™é‡Œåˆ æ‰ä»‹ç» POP ä»¥åŠå¯¹åº”ä¼˜ç¼ºç‚¹çš„å‡ åƒå­—</p>
<p>å…ˆçœ‹çœ‹ç”¨ POP çš„æ€æƒ³ï¼Œæ¥å®ç°ä¸€ä¸ª Cacheï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Caching</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryCache</span>: <span class="title">Caching</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Memory Cache"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DiskCache</span>: <span class="title">Caching</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Disk Cache"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> memory: <span class="type">Caching</span> = <span class="type">MemoryCache</span>() <span class="comment">// ğŸ™‚ï¸</span></span><br><span class="line"><span class="keyword">let</span> disk: <span class="type">Caching</span> = <span class="type">DiskCache</span>() <span class="comment">// ğŸ™‚ï¸</span></span><br><span class="line"><span class="keyword">let</span> caches: [<span class="type">Caching</span>] = [memory, disk] <span class="comment">// ğŸ™‚ï¸</span></span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œä¸€åˆ‡éƒ½æ˜¯å¾ˆç†Ÿæ‚‰çš„æ ·å­ï¼Œä¹Ÿèƒ½æ­£å¸¸çš„ workï¼Œç±»ä¼¼è¿™æ ·çš„<strong>ç”¨ä¸€ä¸ª <em>protocol</em> æ¥è¿›è¡Œæ¥å£ï¼ˆè¡Œä¸ºï¼‰çº¦æŸ</strong>çš„ä»£ç ä¼°è®¡å†™çš„ä¹Ÿä¸å°‘ã€‚</p>
<h2 id="Generics"><a href="#Generics" class="headerlink" title="Generics"></a>Generics</h2><blockquote>
<p>ä½œä¸ºä¸€ä¸ªç°ä»£è¯­è¨€ï¼Œæ³›å‹æ˜¯å¿…é¡»æ”¯æŒçš„ã€‚ä½œä¸ºä¸€ä¸ªç°ä»£ç¨‹åºå‘˜ï¼Œæ³›å‹ä¹Ÿæ˜¯å¿…é¡»ä¼šä½¿ç”¨çš„ã€‚</p>
</blockquote>
<p>Cache  æ˜¯ç”¨æ¥ç¼“å­˜æ•°æ®çš„ï¼Œä½†æœ‰å¾ˆå¤šæ•°æ®ç±»å‹éƒ½é€‚åˆè¢«ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€å¼ å›¾ç‰‡ï¼Œä¸€ä¸ªè§†é¢‘ç­‰ç­‰ã€‚å¦‚æœå¸Œæœ›ä¸åŒç±»å‹çš„æ•°æ®æœ‰ä¸åŒçš„ç¼“å­˜ç­–ç•¥ï¼Œä½¿ç”¨çš„æ—¶å€™ä¹Ÿèƒ½ç›´æ¥è·å–æŸä¸€ç§ç±»å‹çš„ç¼“å­˜ï¼Œä¸éœ€è¦å„ç§ <code>as? XXX</code>ï¼Œç«‹é©¬æƒ³åˆ°çš„å°±æ˜¯æ³›å‹ã€‚</p>
<p>æ³›å‹è¿˜ä¸ç®€å•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Caching</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Object</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">store</span><span class="params">(<span class="number">_</span> object: Object, forKey key: String)</span></span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">retrieve</span><span class="params">(forKey key: String)</span></span> -&gt; <span class="type">Object?</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryCache</span>: <span class="title">Caching</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Object</span> = <span class="type">UIImage</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">store</span><span class="params">(<span class="number">_</span> object: Object, forKey key: String)</span></span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">retrieve</span><span class="params">(forKey key: String)</span></span> -&gt; <span class="type">Object?</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DiskCache</span>: <span class="title">Caching</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Object</span> = <span class="type">UIImage</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">store</span><span class="params">(<span class="number">_</span> object: Object, forKey key: String)</span></span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">retrieve</span><span class="params">(forKey key: String)</span></span> -&gt; <span class="type">Object?</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> memory: <span class="type">Caching</span> = <span class="type">MemoryCache</span>() <span class="comment">// ğŸ™ƒ</span></span><br><span class="line"><span class="keyword">let</span> disk: <span class="type">Caching</span> = <span class="type">DiskCache</span>() <span class="comment">// ğŸ™ƒ</span></span><br><span class="line"><span class="keyword">let</span> caches: [<span class="type">Caching</span>] = [memory, disk] <span class="comment">// ğŸ™ƒ</span></span><br></pre></td></tr></table></figure>
<p>ç„¶å Xcode å°±å¥½å¾ˆæ— æƒ…çš„æç¤ºä½ ï¼š</p>
<blockquote>
<p>â—ï¸Protocol â€˜Cachingâ€™ can only be used as generic constraint because it has Self or associated type requirements</p>
</blockquote>
<p>WTF?</p>
<h2 id="What-is-Protocol-with-Associated-Types"><a href="#What-is-Protocol-with-Associated-Types" class="headerlink" title="What is Protocol with Associated Types?"></a>What is Protocol with Associated Types?</h2><p>çœ‹åˆ°è¿™ä¸ªé”™è¯¯æç¤ºï¼Œæœ‰ç»éªŒçš„ Swift  ç¨‹åºå‘˜ä¸€èˆ¬ä¼šæƒ³åˆ°ï¼Œ<code>Caching</code> é‡Œé¢å…³è”äº†ä¸€ä¸ªç±»å‹ï¼Œå¦‚æœä¸æŒ‡å®šè¿™ä¸ªå…³è”çš„ç±»å‹çš„å…·ä½“ç±»å‹æ˜¯ä»€ä¹ˆï¼Œä½œä¸ºä¸€é—¨é™æ€è¯­è¨€ï¼Œé‚£å¯èƒ½å°±æ— æ³•çŸ¥é“å†…å­˜æ˜¯æ€ä¹ˆå¸ƒå±€çš„ã€‚</p>
<p>æ—¢ç„¶éœ€è¦æŒ‡å®šç±»å‹ï¼Œé©¬ä¸Šæƒ³åˆ°çš„å°±æ˜¯ <em>æ³›å‹å‚æ•°</em>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cache: <span class="type">Caching</span>&lt;<span class="type">UIImage</span>&gt; =  ...</span><br><span class="line"><span class="comment">// â—ï¸Protocol 'Caching' can only be used as generic constraint because it has Self or associated type requirements</span></span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Caching</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// â—ï¸Protocols do not allow generic parameters; use associated types instead</span></span><br></pre></td></tr></table></figure>
<p>WTFï¼Ÿ</p>
<h2 id="Protocol-as-Types"><a href="#Protocol-as-Types" class="headerlink" title="Protocol as Types"></a>Protocol as Types</h2><p>çªç„¶å‘ç°è‡ªå·±å¥½åƒä¸€ç‚¹éƒ½ä¸äº†è§£ protocolï¼Œçœ‹çœ‹æ–‡æ¡£ä»‹ç»<a href="https://docs.swift.org/swift-book/LanguageGuide/Protocols.html" target="_blank" rel="noopener">Protocols â€” The Swift Programming Language (Swift 4.2)</a>ã€‚é‡Œé¢ Protocol as Types ä¸€èŠ‚æœ‰ä¸€æ®µè¯ï¼š</p>
<blockquote>
<p>Protocols donâ€™t actually implement any functionality themselves. Nonetheless, any protocol you create will become a fully-fledged type for use in your code.<br>Because itâ€™s a type, you can use a protocol in many places where other types are allowed, including:</p>
<ul>
<li>As a parameter type or return type in a function, method, or initializer</li>
<li>As the type of a constant, variable, or property</li>
<li>As the type of items in an array, dictionary, or other container</li>
</ul>
</blockquote>
<p>ä¸ºä»€ä¹ˆ protocol + generic å°±è¿™ä¹ˆéš¾ç”¨ï¼Ÿåº”è¯¥æ€ä¹ˆç”¨ï¼Ÿ</p>
<h2 id="PATs-in-Swift-Standard-Library"><a href="#PATs-in-Swift-Standard-Library" class="headerlink" title="PATs in Swift Standard Library"></a>PATs in Swift Standard Library</h2><p>æ—¢ç„¶ä¸ä¼šç”¨ï¼Œé‚£ä¹ˆçœ‹çœ‹ Standard Library é‡Œé¢æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// The type of element traversed by the iterator.</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// - Returns: The next element in the underlying sequence, if a next element</span></span><br><span class="line">    <span class="comment">///   exists; otherwise, `nil`.</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Element?</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// A type representing the sequence's elements.</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A type that provides the sequence's iteration interface and</span></span><br><span class="line">    <span class="comment">/// encapsulates its iteration state.</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Iterator</span> : <span class="type">IteratorProtocol</span> <span class="keyword">where</span> <span class="type">Iterator</span>.<span class="type">Element</span> == <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns an iterator over the elements of this sequence.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">Iterator</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååˆå‘ç°æœ‰ä¸€ä¸ªå« <code>AnyIterator</code> å’Œ <code>AnySequence</code> çš„ä¸œè¥¿ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">AnyIterator</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">let</span> _box: _AnyIteratorBoxBase&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>&lt;<span class="type">I</span> : <span class="type">IteratorProtocol</span>&gt;(<span class="number">_</span> base: <span class="type">I</span>) <span class="keyword">where</span> <span class="type">I</span>.<span class="type">Element</span> == <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _IteratorBox(base)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> body: @escaping () -&gt; <span class="type">Element?</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _IteratorBox(_ClosureBasedIterator(body))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">init</span>(_box: _AnyIteratorBoxBase&lt;<span class="type">Element</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _box</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AnyIterator</span>: <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Element?</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _box.next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">AnySequence</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">let</span> _box: _AnySequenceBox&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>&lt;<span class="type">I</span> : <span class="type">IteratorProtocol</span>&gt;(<span class="number">_</span> makeUnderlyingIterator: @escaping () -&gt; <span class="type">I</span>) <span class="keyword">where</span> <span class="type">I</span>.<span class="type">Element</span> == <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(_ClosureBasedSequence(makeUnderlyingIterator))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">init</span>(_box: _AnySequenceBox&lt;<span class="type">Element</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _box</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AnySequence</span>: <span class="title">Sequence</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Iterator</span> = <span class="type">AnyIterator</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>&lt;<span class="type">S</span> : <span class="type">Sequence</span>&gt;(<span class="number">_</span> base: <span class="type">S</span>) <span class="keyword">where</span> <span class="type">S</span>.<span class="type">Element</span> == <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _SequenceBox(_base: base)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Œå…ˆçœ‹çœ‹æ–‡æ¡£ï¼š</p>
<blockquote>
<p>This iterator forwards its next() method to an arbitrary underlying iterator having the same Element type, hiding the specifics of the underlying IteratorProtocol. â€”<a href="https://developer.apple.com/documentation/swift/anyiterator" target="_blank" rel="noopener">AnyIterator - Swift Standard Library | Apple Developer Documentation</a></p>
</blockquote>
<blockquote>
<p>An instance of AnySequence forwards its operations to an underlying base sequence having the same Element type, hiding the specifics of the underlying sequence.â€Šâ€”<a href="https://developer.apple.com/documentation/swift/anysequence" target="_blank" rel="noopener">AnySequence - Swift Standard Library | Apple Developer Documentation</a></p>
</blockquote>
<p>è¯´ç™½äº†å°±æ˜¯åŒ…è£…ä¸€å±‚ï¼Œè½¬å‘ä¸€ä¸‹ï¼Œå®ƒæœ‰ä¸ªæœ¯è¯­å«åš <strong>Type Erasure</strong></p>
<h2 id="What-is-Type-Erasure"><a href="#What-is-Type-Erasure" class="headerlink" title="What is Type Erasure?"></a>What is Type Erasure?</h2><p>é¦–å…ˆ Swift çš„ç±»å‹ç³»ç»Ÿé‡Œé¢ï¼Œæœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>Concrete Type: Int, Boolâ€¦</li>
<li>Abstract Type: associatedType, <t></t></li>
</ul>
<p>å¯¹äºæŠ½è±¡ç±»å‹æ¥è¯´ï¼Œç¼–è¯‘å™¨æ— æ³•çŸ¥é“è¿™ä¸ªç±»å‹çš„ç¡®åˆ‡åŠŸèƒ½ã€‚å½“ç¼–è¯‘å™¨å¤„ç†æŠ½è±¡ç±»å‹çš„æ—¶å€™ï¼Œå®ƒæ— æ³•çŸ¥æ™“å…¶æ‰€å çš„ç©ºé—´å¤§å°ï¼›ç”šè‡³å¯èƒ½ä¼šè®¤ä¸ºè¿™ä¸ªç±»å‹æ˜¯ä¸å­˜åœ¨çš„ã€‚Swift æ˜¯é™æ€è¯­è¨€ã€‚</p>
<blockquote>
<p>Type erasure is a process in code that makes abstract types concrete.</p>
</blockquote>
<p>å…·ä½“çœ‹çœ‹ Swift Standard Library é‡Œé¢ï¼Œæ˜¯æ€ä¹ˆåšåˆ°çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. abstract base</span></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">_AnyIteratorBoxBase</span>&lt;<span class="title">Element</span>&gt; : <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Element?</span> &#123; _abstract() &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. private box</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">_IteratorBox</span>&lt;<span class="title">Base</span> : <span class="title">IteratorProtocol</span>&gt; : <span class="title">_AnyIteratorBoxBase</span>&lt;<span class="title">Base</span>.<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>) &#123; <span class="keyword">self</span>._base = base &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Base</span>.<span class="type">Element?</span> &#123; <span class="keyword">return</span> _base.next() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> _base: <span class="type">Base</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. public wrapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">AnyIterator</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">let</span> _box: _AnyIteratorBoxBase&lt;<span class="type">Element</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>&lt;<span class="type">I</span> : <span class="type">IteratorProtocol</span>&gt;(<span class="number">_</span> base: <span class="type">I</span>) <span class="keyword">where</span> <span class="type">I</span>.<span class="type">Element</span> == <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _IteratorBox(base)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> body: @escaping () -&gt; <span class="type">Element?</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _IteratorBox(_ClosureBasedIterator(body))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">init</span>(_box: _AnyIteratorBoxBase&lt;<span class="type">Element</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>._box = _box</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¨¡å¼æ¦‚æ‹¬èµ·æ¥å°±æ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>an abstract base class</li>
<li>a private box class</li>
<li>a public wrapper class</li>
</ul>
<p>ï¼ˆæƒ³äº†è§£æ›´å¤šç›¸å…³çš„ç†è®ºçŸ¥è¯†ï¼Ÿ<em>Existential</em> äº†è§£ä¸€ä¸‹</p>
<h2 id="One-more-thing"><a href="#One-more-thing" class="headerlink" title="One more thing"></a>One more thing</h2><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¥ä¸ºæˆ‘å·²ç»æŒæ¡äº†å¦‚ä½•ç”¨ PATs äº†ï¼Œç„¶åæœ‰ä¸€å¤©ï¼Œæˆ‘å¼€å§‹å†™ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—ç³»ç»Ÿã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Logging</span>: <span class="title">Hashtable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> loggers: <span class="type">Set</span>&lt;<span class="type">Logging</span>&gt; = []</span><br><span class="line"><span class="comment">// â—ï¸Using 'Logging' as a concrete type conforming to protocol 'Hashable' is no supported</span></span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> logger: Logging)</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// â—ï¸Protocol 'Logging' can only be used as generic constraint because it has Self or associated type requirements</span></span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™ç†Ÿæ‚‰çš„é”™è¯¯ï¼Œé©¬ä¸Šå°±æƒ³åˆ° <code>Hashable</code> å…¶å®æ˜¯ç»§æ‰¿ <code>Equatable</code> çš„ï¼Œç„¶åè¿™ä¸ª <code>Equatable</code> çš„å‡ ä¸ªæ–¹æ³•é‡Œé¢ï¼Œç”¨äº† <code>Self</code> æ¥å ä½ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ PATs çš„ä¸€ç§ã€‚æ„ä¸æ„å¤–ï¼ŒæƒŠä¸æƒŠå–œã€‚ï¼ˆå…¶å®ä¸€ç‚¹éƒ½ä¸æ„å¤–</p>
<p>ç„¶åå°±æ˜¯ type erasure äº†ï¼ŒçœŸæ­£æ ¹æ®ä¸Šé¢çš„ä¸‰ä¸ªæ­¥éª¤æ¥å†™çš„æ—¶å€™ï¼Œå‘ç°å¥½åƒè·Ÿä¹‹å‰çš„åˆæœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å…³è”åˆ«çš„ç±»å‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. abstract baes</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AnyLoggerBoxBase</span>&lt;<span class="title">T</span>&gt; : <span class="title">Logging</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. private box</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_LoggerBox</span>&lt;<span class="title">Base</span> : <span class="title">Logging</span>&gt; : <span class="title">_AnyLoggerBoxBase</span> &lt;<span class="title">Base</span>.<span class="title">Self</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. public wrapper</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AnyLogger</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">init</span>&lt;<span class="type">L</span> : <span class="type">Logging</span>&gt;(<span class="number">_</span> base: <span class="type">L</span>) <span class="keyword">where</span> <span class="type">L</span>.<span class="type">Self</span> == <span class="type">Self</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸‰æ­¥é‡Œé¢çš„æ³›å‹å‚æ•°åƒæ˜¯å¤šå‡ºæ¥çš„ï¼Œæ ¹æœ¬æ— ä»ä¸‹æ‰‹ã€‚</p>
<blockquote>
<p>é‡åˆ°ä¸æ‡‚ï¼Œé¦–å…ˆçœ‹æºç æ€»æ˜¯ä¸ä¼šæœ‰é”™ã€‚â€” åœ£äºº</p>
</blockquote>
<p>äº†è§£ Swift çš„éƒ½çŸ¥é“ï¼Œæœ‰ä¸€ä¸ªå«åš <code>AnyHashable</code> çš„ä¸œè¥¿ã€‚ï¼ˆä¸€é¡¿æŠ„ï¼Œå®Œäº‹</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li><a href="https://www.youtube.com/watch?v=XWoNjiSPqI8&amp;t=2391s" target="_blank" rel="noopener">Alexis Gallagher - Protocols with Associated Types - YouTube</a></li>
<li><a href="https://academy.realm.io/posts/tryswift-gwendolyn-weston-type-erasure/" target="_blank" rel="noopener">Keep Calm and Type Erase On</a></li>
<li><a href="https://developer.apple.com/documentation/swift/anysequence" target="_blank" rel="noopener">AnySequence - Swift Standard Library | Apple Developer Documentation</a></li>
<li><a href="https://github.com/apple/swift/blob/master/stdlib/public/core/ExistentialCollection.swift.gyb" target="_blank" rel="noopener">swift/ExistentialCollection.swift.gyb at master Â· apple/swift Â· GitHub</a></li>
<li><a href="https://github.com/apple/swift/blob/master/stdlib/public/core/AnyHashable.swift" target="_blank" rel="noopener">swift/AnyHashable.swift at master Â· apple/swift Â· GitHub</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2017/08/10/plist-parser/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/10/plist-parser/" itemprop="url">Plist Parser</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-08-10T20:00:00+08:00">
                2017-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/functional-programming/" itemprop="url" rel="index">
                    <span itemprop="name">functional programming</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Plist æ˜¯ Apple å®¶å¹³å°ä¸Šä¸€ç§å¾ˆå¸¸è§çš„é…ç½®æ–‡ä»¶ï¼Œå¸¸è§çš„å­˜å‚¨æ ¼å¼æ˜¯å¸¸è§çš„ XML æ ¼å¼ï¼ˆè¿˜æœ‰ Binary æ ¼å¼ï¼‰ï¼Œä¸åŒäº HTML çš„å¤æ‚ï¼ŒPlist åªåŒ…å«äº†æ¯”è¾ƒå°‘çš„å‡ ç§æ ‡ç­¾ï¼ˆtagï¼‰ï¼Œæ‰€ä»¥å®ç°ä½¿ç”¨ functional çš„ parser combinator æ¥å®ç°ä¸€ä¸ªç®€å•çš„ plist parser ä¹Ÿæ˜¯ä¸€ä»¶å¾ˆæœ‰æ„æ€çš„äº‹æƒ…ã€‚</p>
<h2 id="Plist"><a href="#Plist" class="headerlink" title="Plist"></a>Plist</h2><p>ä¸€ä¸ª Plist æ–‡ä»¶å†…å®¹é•¿è¿™ä¸ªæ ·å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;number&lt;/key&gt;</span><br><span class="line">    &lt;integer&gt;0&lt;/integer&gt;</span><br><span class="line">    &lt;key&gt;date&lt;/key&gt;</span><br><span class="line">    &lt;date&gt;2017-08-05T14:25:14Z&lt;/date&gt;</span><br><span class="line">    &lt;key&gt;data&lt;/key&gt;</span><br><span class="line">    &lt;data&gt;VGVzdFZhbHVl&lt;/data&gt;</span><br><span class="line">    &lt;key&gt;boolean&lt;/key&gt;</span><br><span class="line">    &lt;true/&gt;</span><br><span class="line">    &lt;key&gt;array&lt;/key&gt;</span><br><span class="line">    &lt;array&gt;</span><br><span class="line">        &lt;string&gt;string&lt;/string&gt;</span><br><span class="line">        &lt;false/&gt;</span><br><span class="line">        &lt;integer&gt;0&lt;/integer&gt;</span><br><span class="line">    &lt;/array&gt;</span><br><span class="line"> &lt;/dict&gt;</span><br></pre></td></tr></table></figure>
<p><a href="https://zh.wikipedia.org/zh-hans/å±æ€§åˆ—è¡¨" target="_blank" rel="noopener">wikipedia</a> ä¸Šåˆ—å‡ºäº†ä¸€ä¸ªè¯¦ç»†çš„ <code>XML</code> æ ‡ç­¾å’Œ macOS/iOS ä¸­çš„ç±»å‹å…³ç³»ä»¥åŠå­˜å‚¨æ ¼å¼ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">Foundation ç±»</th>
<th style="text-align:left">Core Foundation ç±»å‹</th>
<th style="text-align:left">XML æ ‡ç­¾</th>
<th style="text-align:left">å‚¨å­˜æ ¼å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">NSString</td>
<td style="text-align:left">CFString</td>
<td style="text-align:left">&lt;string&gt;</td>
<td style="text-align:left">UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td style="text-align:left">NSNumber</td>
<td style="text-align:left">CFNumber</td>
<td style="text-align:left">&lt;real&gt;, &lt;integer&gt;</td>
<td style="text-align:left">åè¿›åˆ¶æ•°å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td style="text-align:left">NSNumber</td>
<td style="text-align:left">CFBoolean</td>
<td style="text-align:left">&lt;true/&gt;, or &lt;false/&gt;</td>
<td style="text-align:left">æ— æ•°æ®ï¼ˆåªæœ‰æ ‡ç­¾ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">NSDate</td>
<td style="text-align:left">CFDate</td>
<td style="text-align:left">&lt;date&gt;</td>
<td style="text-align:left">ISO 8601 æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²</td>
</tr>
<tr>
<td style="text-align:left">NSData</td>
<td style="text-align:left">CFData</td>
<td style="text-align:left">&lt;data&gt;</td>
<td style="text-align:left">Base64 ç¼–ç çš„æ•°æ®</td>
</tr>
<tr>
<td style="text-align:left">NSArray</td>
<td style="text-align:left">CFArray</td>
<td style="text-align:left">&lt;array&gt;</td>
<td style="text-align:left">å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„å­å…ƒç´ </td>
</tr>
<tr>
<td style="text-align:left">NSDictionary</td>
<td style="text-align:left">CFDictionary</td>
<td style="text-align:left">&lt;dict&gt;</td>
<td style="text-align:left">äº¤æ›¿åŒ…å« &lt;key&gt; æ ‡ç­¾å’Œ plist å…ƒç´ æ ‡ç­¾</td>
</tr>
</tbody>
</table>
<p>æ ¹æ®è¿™ä¸ªè¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å‡º Plist çš„æ•°æ®ç»“æ„ã€‚</p>
<h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The plist data model</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">PLIST</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// &lt;true/&gt; or &lt;false/&gt;</span></span><br><span class="line">    <span class="keyword">case</span> bool(<span class="type">Bool</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 2017-08-05T14:25:14Z</span></span><br><span class="line">    <span class="keyword">case</span> date(<span class="type">Date</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// &lt;data&gt;VGVzdFZhbHVl&lt;/data&gt; (&lt;54657374 56616c75 65&gt;</span></span><br><span class="line">    <span class="keyword">case</span> data(<span class="type">Data</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// &lt;integer&gt;233&lt;/integer&gt; or &lt;real&gt;2.33&lt;/real&gt;</span></span><br><span class="line">    <span class="keyword">case</span> number(<span class="type">Int</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// &lt;string&gt;string&lt;/string&gt;</span></span><br><span class="line">    <span class="keyword">case</span> string(<span class="type">String</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// &lt;array&gt;&lt;string&gt;The String&lt;/string&gt;&lt;/array&gt;</span></span><br><span class="line">    <span class="keyword">indirect</span> <span class="keyword">case</span> array([<span class="type">PLIST</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// &lt;dict&gt;&lt;key&gt;The Key&lt;/key&gt;&lt;string&gt;The String&lt;/string&gt;&lt;/dict&gt;</span></span><br><span class="line">    <span class="keyword">indirect</span> <span class="keyword">case</span> dict([<span class="type">String</span>: <span class="type">PLIST</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h2><p>æ ¹æ® Plist data modelï¼Œæƒ³è¦è§£æä¸€ä¸ª Plist å­—ç¬¦ä¸² å¾—åˆ° <code>PLIST</code> ç±»å‹ï¼Œåªéœ€è¦ä¸€ä¸ª <code>parser</code>ã€‚</p>
<p>æ²¡é”™ï¼Œåªéœ€è¦ä¸€ä¸ª parserï¼Œè¿™ä¸ª parser å¤§æ¦‚é•¿è¿™æ ·ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> parser: <span class="type">Parser</span>&lt;<span class="type">PLIST</span>&gt;</span><br><span class="line"><span class="keyword">let</span> result = parser.parse(<span class="string">"plist"</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª <code>let parser: Parser&lt;PLIST&gt;</code> çš„å®ç°æ‰æ˜¯æœ€å…³é”®çš„ã€‚ä¸€ä¸ª <code>PLIST</code> æ˜¯ç”± <code>Bool</code> <code>Date</code> <code>Data</code> <code>Number</code> <code>String</code> 5 ç§ç®€å•çš„ç±»å‹å’Œ <code>Array&lt;PLIST&gt;</code> <code>Dictionary&lt;PLIST&gt;</code> 2 ç§å®¹å™¨ï¼ˆnestedï¼‰ç±»å‹ç»„æˆï¼Œæ‰€ä»¥ä¸€ä¸ª <code>Parser&lt;PLIST&gt;</code> ä¹Ÿæ˜¯ç”±å¯¹åº”çš„ <code>Parser&lt;Bool&gt;</code> <code>Parser&lt;Date&gt;</code> <code>Parser&lt;Data&gt;</code> <code>Parser&lt;Number&gt;</code> <code>Parser&lt;String&gt;</code> 5 ä¸­ç®€å•çš„ parser å’Œ <code>Parser&lt;Array&gt;</code> <code>Parser&lt;Dictionary&gt;</code> 2 ç§å®¹å™¨ç±»å‹ parser ç»„æˆã€‚</p>
<h3 id="Bool-Parser"><a href="#Bool-Parser" class="headerlink" title="Bool Parser"></a>Bool Parser</h3><p>åœ¨ Plist ä¸­ï¼ŒBool ç±»å‹ç”±ä¸¤ç§å½¢å¼ <code>&lt;true/&gt;</code> å’Œ <code>&lt;false/&gt;</code>ï¼Œæ‰€ä»¥ä¸€ä¸ª Bool ç±»å‹çš„ parser ä¹Ÿå°±æ˜¯èƒ½å¤Ÿè§£æå­—ç¬¦ä¸² <code>&lt;true/&gt;</code> å’Œ <code>&lt;false/&gt;</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _true = string(<span class="string">"&lt;true/&gt;"</span>) &lt;&amp;&gt; const(<span class="type">PLIST</span>.bool(<span class="literal">true</span>))</span><br><span class="line"><span class="keyword">let</span> _false = string(<span class="string">"&lt;false/&gt;"</span>) &lt;&amp;&gt; const(<span class="type">PLIST</span>.bool(<span class="literal">false</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _bool = _true &lt;|&gt; _false</span><br><span class="line">_bool.parse(<span class="string">"&lt;false/&gt;"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Date-Parser"><a href="#Date-Parser" class="headerlink" title="Date Parser"></a>Date Parser</h3><p>Plist ä¸­çš„ Date ç±»å‹å­˜å‚¨çš„æ˜¯ UTC å­—ç¬¦ä¸²ï¼Œå¦‚ <code>&lt;date&gt;2017-08-05T14:25:14Z&lt;/date&gt;</code>ã€‚å­—ç¬¦ä¸²ä¸­çš„å¼€å§‹æ ‡ç­¾ <code>&lt;date&gt;</code> å’Œç»“æŸæ ‡ç­¾ <code>&lt;/date&gt;</code> å¯¹äºè§£æçš„ç»“æœæ¥è¯´æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œæ‰€ä»¥ä¸€ä¸ª Date ç±»å‹çš„ parser æ˜¯è¦å°†è¿™ä¸ªå­—ç¬¦ä¸²è§£ææˆ <code>PLIST.date(date)</code>, date ä¸º 2017-08-05T14:25:14Z é€šè¿‡ format å¾—åˆ°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _date = string(<span class="string">"&lt;date&gt;"</span>) *&gt; manyTill(_any, string(<span class="string">"&lt;/date&gt;"</span>)) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.date(<span class="type">String</span>($<span class="number">0</span>).date!) &#125;</span><br><span class="line">_date.parse(<span class="string">"&lt;date&gt;2017-08-05T14:25:14Z&lt;/date&gt;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/// UTC Date</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> date: <span class="type">Date?</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> formatter = <span class="type">DateFormatter</span>()</span><br><span class="line">        formatter.dateFormat = <span class="string">"yyyy-MM-dd'T'HH:mm:ss'Z'"</span></span><br><span class="line">        <span class="keyword">return</span> formatter.date(from: <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Data-Parser"><a href="#Data-Parser" class="headerlink" title="Data Parser"></a>Data Parser</h3><p>Plist ä¸­çš„ Data ç±»å‹å­˜å‚¨çš„æ˜¯ Base64 ç¼–ç åçš„æ•°æ®ï¼Œæ‰€ä»¥å®ç°ä¸€ä¸ª Data Parser å’Œ Date Parser å·®ä¸å¤šï¼ŒåŒºåˆ«æ˜¯ tag å’Œ Data ç±»å‹åˆå§‹åŒ–ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _data = string(<span class="string">"&lt;data&gt;"</span>) *&gt; manyTill(_any, string(<span class="string">"&lt;/data&gt;"</span>)) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.data(<span class="type">Data</span>(base64Encoded: <span class="type">String</span>($<span class="number">0</span>))!) &#125;</span><br><span class="line"><span class="keyword">let</span> dataString = _data.parse(<span class="string">"&lt;data&gt;VGVzdFZhbHVl&lt;/data&gt;"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Number-Parser"><a href="#Number-Parser" class="headerlink" title="Number Parser"></a>Number Parser</h3><p>Plist ä¸­çš„ Number çš„å­˜å‚¨å®é™…ä¸Šåˆ†ä¸¤ç§ã€‚ä¸€ç§æ˜¯æ•´å‹ï¼Œä¸€ç§æ˜¯æµ®ç‚¹å‹ã€‚æ•´å‹çš„ <code>tag</code> æ˜¯ <code>integer</code>ï¼Œæµ®ç‚¹å‹æ˜¯ <code>real</code>ã€‚</p>
<p>å…ˆçœ‹ Integer Parserï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _integer = string(<span class="string">"&lt;integer&gt;"</span>) *&gt; manyTill(_digit, string(<span class="string">"&lt;/integer&gt;"</span>)) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.number(<span class="type">Int</span>(<span class="type">String</span>($<span class="number">0</span>))!) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="String-Parser"><a href="#String-Parser" class="headerlink" title="String Parser"></a>String Parser</h3><p>String Parser å’Œ Date Parser ä»¥åŠ Data Parser å¯¹æ¯”èµ·æ¥æ›´ç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯å»æ‰äº†æœ€åè½¬æ¢çš„é‚£ä¸€æ­¥ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _string = string(<span class="string">"&lt;string&gt;"</span>) *&gt; manyTill(_any, string(<span class="string">"&lt;/string&gt;"</span>)) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.string(<span class="type">String</span>($<span class="number">0</span>)) &#125;</span><br><span class="line">_string.parse(<span class="string">"&lt;string&gt;The String&lt;/string&gt;"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Tag-Parser"><a href="#Tag-Parser" class="headerlink" title="Tag Parser"></a>Tag Parser</h3><p>é€šè¿‡å¯¹æ¯”ä¸Šé¢å‡ ç§é™¤äº† Bool Parser ä¹‹å¤–ä¸åŒç±»å‹çš„ Parserï¼Œå¯ä»¥å‘ç°å®ç°çš„æ–¹å¼å¾ˆç›¸ä¼¼ã€‚</p>
<ul>
<li>closed tagï¼Œæˆå¯¹å­˜åœ¨ã€‚</li>
<li>ä¸­é—´å­˜å‚¨çš„éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œæœ€åæŠŠå­—ç¬¦ä¸²è½¬ä¸ºå…·ä½“ç±»å‹ã€‚</li>
</ul>
<p>æŠŠè¿™äº›ç›¸ä¼¼çš„ Parser è¿›è¡ŒæŠ½è±¡ï¼Œå°†ç›¸åŒéƒ¨åˆ†å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œä¸åŒçš„éƒ¨åˆ†ç”¨ä¼ å‚çš„å½¢å¼æ¥å®ç°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tag</span>&lt;A&gt;<span class="params">(<span class="number">_</span> tag: String, <span class="number">_</span> p: Parser&lt;A&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;[<span class="type">A</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> string(<span class="string">"&lt;\(tag)&gt;"</span>) *&gt; manyTill(p, string(<span class="string">"&lt;/\(tag)&gt;"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _date1 = tag(<span class="string">"&lt;date&gt;"</span>, _any) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.date(<span class="type">String</span>($<span class="number">0</span>).date!) &#125;</span><br><span class="line">_date1.parse(<span class="string">"&lt;date&gt;2017-08-05T14:25:14Z&lt;/date&gt;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _string1 = tag(<span class="string">"string"</span>, _any) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.string(<span class="type">String</span>($<span class="number">0</span>)) &#125;</span><br><span class="line">_string1.parse(<span class="string">"&lt;string&gt;The String&lt;/string&gt;"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Array-Parser"><a href="#Array-Parser" class="headerlink" title="Array Parser"></a>Array Parser</h3><p>Array Parser å’Œ Dictionary Parser ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å®¹å™¨ç±»å‹ï¼Œé‡Œé¢å¯ä»¥æ˜¯ä»»æ„çš„ PLIST ç±»å‹ï¼ŒåŒ…æ‹¬å®ƒä»¬æœ¬èº«ã€‚å¯¹äº Enum PLIST æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨ <code>indirect</code> å…³é”®å­—æ¥è¡¨ç¤ºè¿™ç§æƒ…å†µï¼Œä½†æ˜¯åœ¨å®šä¹‰ parser çš„æ—¶å€™ï¼Œç¡®æ²¡æœ‰è¿™äº›é­”æ³•ã€‚</p>
<p>ä½†æ˜¯é€šè¿‡åˆ©ç”¨ Swift çš„ä¸€äº›ç‰¹æ€§ï¼Œè¿˜æ˜¯å¾ˆå®¹æ˜“è§£å†³è¿™ä¸ªé€’å½’çš„é—®é¢˜ã€‚å…ˆå¿½ç•¥ Dictionary ç±»å‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _plist = plist()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">plist</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">PLIST</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> _bool &lt;|&gt; _string &lt;|&gt; _integer &lt;|&gt; _date &lt;|&gt; _data &lt;|&gt; _array</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _array = tag(<span class="string">"array"</span>, _plist) &lt;&amp;&gt; &#123;</span><br><span class="line">    <span class="type">PLIST</span>.array($<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Dictionary-Parser"><a href="#Dictionary-Parser" class="headerlink" title="Dictionary Parser"></a>Dictionary Parser</h3><p>Dictionary Parser çš„é€’å½’é—®é¢˜å’Œ Array Parser ä¸€æ ·ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _plist = plist()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">plist</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">PLIST</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> _bool &lt;|&gt; _string &lt;|&gt; _integer &lt;|&gt; _date &lt;|&gt; _data &lt;|&gt; _array &lt;|&gt; _dict</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _dict = tag(<span class="string">"dict"</span>, ?) &lt;&amp;&gt; &#123;</span><br><span class="line">   <span class="comment">/// è½¬æ¢ä¸º PLIST.dict</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½† Dictionary å’Œ Array ä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºï¼ŒArray é‡Œé¢æ˜¯å¤šä¸ª Plist çš„å…ƒç´ ï¼Œè€Œ Dictionary æ˜¯ key-value å¯¹ï¼Œä¸”å¿…é¡»æ˜¯ key-value å¯¹ï¼Œä¹Ÿå°±æ˜¯ <code>tag(&quot;dict&quot;, _keyValue)</code>ã€‚</p>
<p>å…ˆå®ç°ä¸€ä¸ª Key-Value Parserï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _key = string(<span class="string">"&lt;key&gt;"</span>) *&gt; manyTill(_any, string(<span class="string">"&lt;/key&gt;"</span>)) &lt;&amp;&gt; &#123; <span class="type">String</span>($<span class="number">0</span>) &#125;</span><br><span class="line"><span class="keyword">let</span> _keyValue = (&#123; a <span class="keyword">in</span> &#123; b <span class="keyword">in</span> (a, b) &#125;&#125; &lt;^&gt; _key &lt;*&gt; (value))</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°±å¯ä»¥å¾—åˆ° Dictionary Parserï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _dict = tag(<span class="string">"dict"</span>, _keyValue) &lt;&amp;&gt; &#123; <span class="type">PLIST</span>.dict(atod($<span class="number">0</span>)) &#125;</span><br><span class="line"><span class="comment">/// Tuple Array to Dictionary</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">atod</span>&lt;Key: Hashable, Value&gt;<span class="params">(<span class="number">_</span> tuples: [<span class="params">(Key, Value)</span></span></span>]) -&gt; [<span class="type">Key</span>: <span class="type">Value</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> dict: [<span class="type">Key</span>: <span class="type">Value</span>] = [:]</span><br><span class="line">    <span class="keyword">for</span> (key, value) <span class="keyword">in</span> tuples &#123;</span><br><span class="line">        dict[key] = value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dict</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…æ¢ä¸€ç§å†™æ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _kv = _keyValue &lt;&amp;&gt; &#123; ttod($<span class="number">0</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _dict1 = tag(<span class="string">"dict"</span>, _kv) &lt;&amp;&gt; &#123;</span><br><span class="line">    <span class="type">PLIST</span>.dict(</span><br><span class="line">    		$<span class="number">0</span>.flatMap &#123; $<span class="number">0</span> &#125;</span><br><span class="line">        .<span class="built_in">reduce</span>([<span class="type">String</span>: <span class="type">PLIST</span>]()) &#123; d, kv <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">var</span> dict = d</span><br><span class="line">            dict.updateValue(kv.value, forKey: kv.key)</span><br><span class="line">            <span class="keyword">return</span> dict</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">ttod</span>&lt;Key: Hashable, Value&gt;<span class="params">(<span class="number">_</span> tuple: <span class="params">(Key, Value)</span></span></span>) -&gt; [<span class="type">Key</span>: <span class="type">Value</span>] &#123;</span><br><span class="line">    <span class="keyword">return</span> [tuple.<span class="number">0</span>: tuple.<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Plist-Parser"><a href="#Plist-Parser" class="headerlink" title="Plist Parser"></a>Plist Parser</h3><p>æœ€å</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _plist = _bool &lt;|&gt; _string &lt;|&gt; _integer &lt;|&gt; _date &lt;|&gt; _data &lt;|&gt; _array &lt;|&gt; _dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result = _plist.parse(plist)</span><br><span class="line"><span class="built_in">dump</span>(result)</span><br></pre></td></tr></table></figure>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://zh.wikipedia.org/zh-hans/å±æ€§åˆ—è¡¨" target="_blank" rel="noopener">å±æ€§åˆ—è¡¨</a><br><a href="http://blessingsoft.com/2017/05/28/parser-combinator/">Parser Combinator</a><br><a href="https://github.com/nixzhu/dev-blog/blob/master/2017-04-12-json-parser.md" target="_blank" rel="noopener">è§£æç»„åˆå­</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2017/06/12/group-theory-and-category-theory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/12/group-theory-and-category-theory/" itemprop="url">Group Theory and Category Theory</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-06-12T20:00:00+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/functional-programming/" itemprop="url" rel="index">
                    <span itemprop="name">functional programming</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æƒ³ç†è§£å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¸€äº›é«˜å¤§ä¸Šçš„æ¦‚å¿µï¼Œæ¯”å¦‚ Functor, Monad ç­‰ï¼Œå¿…é¡»è¦å…ˆç†è§£èŒƒç•´è®ºã€‚</p>
<h2 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h2><blockquote>
<p>ç¾¤ï¼Œæ˜¯ä¸€ç§ä»£æ•°ç»“æ„ï¼Œç”±ä¸€ä¸ªé›†åˆï¼ˆGï¼‰ä»¥åŠä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼ˆÂ·ï¼‰æ‰€ç»„æˆã€‚<a href="https://zh.wikipedia.org/wiki/ç¾¤" target="_blank" rel="noopener">wikipedia</a></p>
</blockquote>
<p>ä¸€ä¸ªç¾¤å¿…é¡»æ»¡è¶³ä¸€äº›ç§°ä¸º <em>ç¾¤å…¬ç†</em> çš„æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯ <strong>å°é—­æ€§</strong>ã€<strong>ç»“åˆå¾‹</strong>ã€<strong>å•ä½å…ƒ</strong> å’Œ <strong>é€†å…ƒ</strong>ã€‚å¦‚æ•´æ•°é…å¤‡ä¸ŠåŠ æ³•è¿ç®—å°±å½¢æˆä¸€ä¸ªç¾¤ã€‚</p>
<ul>
<li>å°é—­æ€§ï¼ˆClosureï¼‰ï¼šå¯¹äºä»»æ„ a,bâˆˆGï¼ŒaÂ·bâˆˆGã€‚</li>
<li>ç»“åˆå¾‹ï¼ˆAssociativityï¼‰ï¼šå¯¹äºä»»æ„ a,b,câˆˆGï¼Œ(aÂ·b)Â·c = aÂ·(bÂ·c)ã€‚</li>
<li>å•ä½å…ƒï¼ˆIdentityï¼‰ï¼šG ä¸­å­˜åœ¨ä¸€ä¸ªå…ƒç´  eï¼Œä½¿å¾—ä»»æ„ aâˆˆGï¼ŒaÂ·e = eÂ·a = aã€‚</li>
<li>é€†å…ƒï¼šå¯¹äºä»»æ„ aâˆˆGï¼Œå­˜åœ¨ bâˆˆGï¼Œä½¿å¾— aÂ·b = bÂ·a = eã€‚</li>
</ul>
<p>ç¾¤å¹¶ä¸è¦æ±‚è¿™ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼ˆÂ·ï¼‰å…·ä½“åšä»€ä¹ˆï¼Œå®ƒåªè¦æ±‚è¿™ä¸ªäºŒå…ƒè¿ç®—ç¬¦å­˜åœ¨ï¼Œæ‰€ä»¥å¾ˆå¤šæ•°å­¦ç»“æ„éƒ½æ˜¯ç¾¤ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŠŠæ•´æ•°å½“ä½œä¸€ä¸ªç¾¤ï¼ŒæŠŠ <code>+</code> ä½œä¸ºäºŒå…ƒè¿ç®—ç¬¦ã€‚</p>
<ul>
<li>å°é—­æ€§ï¼šå¯¹äºä»»æ„ä¸¤ä¸ªæ•´æ•° a,bï¼Œa+b ä¾ç„¶æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚</li>
<li>ç»“åˆå¾‹ï¼šå¯¹äºä»»æ„æ•´æ•° a,b,cï¼Œ(a+b)+c = a+(b+c)ã€‚</li>
<li>å•ä½å…ƒï¼šå­˜åœ¨å…ƒç´  0ï¼Œä½¿å¾— a+0 = 0+a = aã€‚</li>
<li>é€†å…ƒï¼šå¯¹äºä»»æ„æ•´æ•° aï¼Œå½“ b=-a æ—¶ï¼Œa+b = b+a = eã€‚</li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´ <code>(æ•´æ•°, +)</code> æ˜¯ä¸€ä¸ªç¾¤ã€‚å¦‚æœæŠŠ <code>*</code> å½“ä½œäºŒå…ƒè¿ç®—ç¬¦ï¼ŒæŠŠ <code>1</code> ä½œä¸ºå•ä½å…ƒçš„æ—¶å€™ï¼Œæ•´æ•°å°±å½¢æˆäº†å¦ä¸€ä¸ªç¾¤ã€‚</p>
<p>é™¤äº†æ•´æ•°ï¼Œè¿˜æœ‰å¾ˆå¤šæ•°å­¦ç»“æ„æ˜¯ç¾¤ã€‚</p>
<h3 id="Semigroup"><a href="#Semigroup" class="headerlink" title="Semigroup"></a>Semigroup</h3><p>æ»¡è¶³å°é—­æ€§å’Œç»“åˆå¾‹çš„ç¾¤ï¼Œç§°ä¸ºåŠç¾¤ï¼ˆsemigroupï¼‰ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">infix</span> <span class="keyword">operator</span> &lt;&gt;: <span class="type">AdditionPrecedence</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Semigroup</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> &lt;&gt;<span class="params">(lhs: <span class="keyword">Self</span>, rhs: <span class="keyword">Self</span>)</span></span> -&gt; <span class="type">Self</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span>: <span class="title">Semigroup</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> &lt;&gt;<span class="params">(lhs: Int, rhs: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lhs + rhs</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span>: <span class="title">Semigroup</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> &lt;&gt;<span class="params">(lhs: Array, rhs: Array)</span></span> -&gt; <span class="type">Array</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lhs + rhs</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ˜å  fold</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span>&lt;S: Semigroup&gt;<span class="params">(<span class="number">_</span> xs: [S], <span class="number">_</span> initial: S)</span></span> -&gt; <span class="type">S</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> xs.<span class="built_in">reduce</span>(initial, &lt;&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŠç¾¤çš„ç»“åˆå¾‹ç‰¹æ€§ä½¿å¾—æˆ‘ä»¬å¯ä»¥è¿›è¡Œå¹¶è¡Œè¿ç®—ï¼Œ<code>1 &lt;&gt; 2 &lt;&gt; 3 &lt;&gt; 4</code>ã€‚</p>
<h3 id="Monoid"><a href="#Monoid" class="headerlink" title="Monoid"></a>Monoid</h3><p>åœ¨æŠ½è±¡ä»£æ•°ä¸­ï¼Œæœ‰ä¸€ç±»ç®€å•çš„æŠ½è±¡ç»“æ„è¢«ç§°ä¸º Monoidï¼ˆå¹ºåŠç¾¤ï¼‰ã€‚è®¸å¤šæ•°å­¦ç»“æ„éƒ½æ˜¯å¹ºåŠç¾¤ï¼Œå› ä¸ºæˆä¸ºå¹ºåŠç¾¤çš„è¦æ±‚éå¸¸ä½ã€‚</p>
<p>å­˜åœ¨å•ä½å…ƒçš„åŠç¾¤ï¼Œç§°ä¸ºå«å¹ºåŠç¾¤ï¼Œæˆ–è€…å¹ºåŠç¾¤ï¼Œæˆ–è€…å•ç¾¤ï¼Œæˆ–è€…ç‹¬å¼‚ç‚¹ï¼ˆmonoidï¼‰ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Monoid</span>: <span class="title">Semigroup</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> e: <span class="type">Self</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span>: <span class="title">Monoid</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> e = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span>: <span class="title">Monoid</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> e: <span class="type">Array</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span>&lt;M: Monoid&gt;<span class="params">(<span class="number">_</span> xs: [M])</span></span> -&gt; <span class="type">M</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> xs.<span class="built_in">reduce</span>(<span class="type">M</span>.e, &lt;&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>concat</code> æ˜¯å¯¹ Monoid çš„ä¸€ç§åº”ç”¨ï¼Œå®ƒå¯ä»¥åˆ©ç”¨ Monoid çš„å®šä¹‰ï¼ˆ äºŒå…ƒæ“ä½œ <code>&lt;&gt;</code> å’Œ å•ä½å…ƒ <code>e</code> ï¼‰è¿›è¡ŒæŠ˜å æ“ä½œã€‚</p>
<h2 id="Category-Theory"><a href="#Category-Theory" class="headerlink" title="Category Theory"></a>Category Theory</h2><blockquote>
<p>èŒƒç•´è®ºæ˜¯æ•°å­¦çš„ä¸€é—¨å­¦ç§‘ï¼Œä»¥æŠ½è±¡çš„æ–¹æ³•æ¥å¤„ç†æ•°å­¦æ¦‚å¿µï¼Œå°†è¿™äº›æ¦‚å¿µå½¢å¼åŒ–æˆä¸€ç»„ç»„çš„â€œç‰©ä»¶â€åŠâ€œæ€å°„â€ã€‚<a href="https://zh.wikipedia.org/wiki/èŒƒç•´è®º" target="_blank" rel="noopener">wikipedia</a></p>
</blockquote>
<h3 id="Category"><a href="#Category" class="headerlink" title="Category"></a>Category</h3><p>ä¸€ä¸ªèŒƒç•´ C åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸€ä¸ªç”±å¯¹è±¡ï¼ˆobjectï¼‰ç»„æˆçš„ç±» ob(C)ã€‚ï¼ˆæ³¨ï¼šè¿™é‡ŒæŠŠâ€œç‰©ä»¶â€æˆä¸ºâ€œå¯¹è±¡â€œæ›´æœ‰åŠ©äºä»è®¡ç®—æœºçš„è§’åº¦ç†è§£</li>
<li>å¯¹è±¡é—´æ€å°„ï¼ˆmorphismï¼Œ-&gt;ï¼‰ç»„æˆçš„ç±» hom(C)ï¼šæ¯ä¸ªæ€å°„ f éƒ½åªæœ‰ä¸€ä¸ªã€Œæºå¯¹è±¡ã€a ä»¥åŠä¸€ä¸ªã€Œç›®æ ‡å¯¹è±¡ã€bï¼ˆå…¶ä¸­ a,b éƒ½åœ¨ ob(C) å†…ï¼‰ï¼Œç§°ä¹‹ä¸º <strong>ä» a åˆ° b çš„æ€å°„</strong>ï¼Œè®°ä¸º f: a-&gt;bã€‚ï¼ˆæ³¨ï¼šidentity æ€å°„å³è‡ªå·±æ˜ å°„åˆ°è‡ªå·±çš„ç‰¹æ®Šæ€å°„ï¼Œf: a-&gt;aï¼Œç®€å•è®°ä¸º id[a]ï¼‰</li>
<li>ä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼ˆÂ·ï¼‰ï¼Œç”¨äºæ€å°„ç»„åˆï¼Œå¦‚ h=gÂ·fã€‚</li>
</ul>
<p>æ»¡è¶³å…¬ç†ï¼š</p>
<ul>
<li>ç»“åˆå¾‹ï¼šf: a-&gt;b, g: b-&gt;c, h: c-&gt;dï¼ŒhÂ·(gÂ·f) = (hÂ·g)Â·fã€‚</li>
<li>å•ä½å…ƒï¼šid[a]Â·f = id[b]Â·f = fã€‚</li>
<li>å°é—­æ€§ï¼šf: a-&gt;b, g: b-&gt;c, h: a-&gt;c, h = fÂ·gã€‚</li>
</ul>
<p>èŒƒç•´ä¸¾ä¾‹ï¼š</p>
<ul>
<li>èŒƒç•´ C æœ‰ Int ç±»å‹å’Œ String ç±»å‹å¯¹è±¡ã€‚</li>
<li>å­˜åœ¨æ€å°„ f: Int-&gt;Stringã€‚</li>
</ul>
<p>åˆ’é‡ç‚¹ï¼šå¹ºåŠç¾¤å¯ä»¥è§†ä¸ºä¸€ç±»ç‰¹æ®Šçš„èŒƒç•´ã€‚å¹ºåŠç¾¤è¿ç®—æ»¡è¶³çš„å…¬ç†åŒäºèŒƒç•´ä¸­ <strong>ä»ä¸€ä¸ªå¯¹è±¡åˆ°è‡ªèº«çš„æ€å°„</strong>ã€‚æ¢è¨€ä¹‹ï¼š<br>å¹ºåŠç¾¤å®è´¨ä¸Šæ˜¯åªæœ‰å•ä¸ªå¯¹è±¡çš„èŒƒç•´ã€‚</p>
<h3 id="Functor"><a href="#Functor" class="headerlink" title="Functor"></a>Functor</h3><blockquote>
<p>åœ¨èŒƒç•´è®ºä¸­ï¼Œå‡½å­æ˜¯èŒƒç•´é—´çš„ä¸€ç±»æ˜ å°„ã€‚å‡½å­ä¹Ÿå¯ä»¥è§£é‡Šä¸ºå°èŒƒç•´ä¸ºæˆå‘˜çš„èŒƒç•´å†…çš„æ€å°„ã€‚ <a href="https://zh.wikipedia.org/wiki/å‡½å­" target="_blank" rel="noopener">wikipedia</a></p>
</blockquote>
<p>åœ¨å½“ä»£æ•°å­¦ä¸­ï¼Œå‡½å­è¢«ç”¨æ¥æè¿°å„ç§èŒƒç•´é—´çš„å…³ç³»ã€‚å¯¹èŒƒç•´è®ºè€…æ¥è¯´ï¼Œå‡½å­åˆ™æ˜¯ä¸ªç‰¹åˆ«ç±»å‹çš„å‡½æ•°ã€‚</p>
<p>è®¾ C å’Œ D ä¸ºèŒƒç•´ï¼Œä» C è‡³ D çš„å‡½å­ä¸ºä¸€æ˜ å°„ F:</p>
<ul>
<li>å°†æ¯ä¸ªå¯¹è±¡ xâˆˆC æ˜ å°„è‡³ä¸€å¯¹è±¡ F(x)âˆˆD ä¸Šã€‚</li>
<li>å°†æ¯ä¸ªæ€å°„ f: x-&gt;yâˆˆC æ˜ å°„è‡³ä¸€æ€å°„ F(f): F(x)-&gt;F(y)âˆˆD ä¸Šï¼Œ</li>
</ul>
<p>ä½¿ä¹‹æ»¡è¶³ï¼š</p>
<ul>
<li>å¯¹ä»»ä½•å¯¹è±¡ xâˆˆCï¼Œæ’æœ‰ F(id[x]) = id[F(x)]ã€‚</li>
<li>å¯¹ä»»ä½•æ€å°„ f: x-&gt;y, g: y-&gt;zï¼Œæ’æœ‰ F(fÂ·g) = F(f)Â·F(g)ã€‚</li>
</ul>
<p>æ¢è¨€ä¹‹ï¼Œå‡½å­ä¼šä¿æŒå•ä½æ€å°„ä¸æ€å°„çš„å¤åˆã€‚<br>ä¸€ä¸ªç”±ä¸€èŒƒç•´æ˜ å°„è‡³å…¶è‡ªèº«çš„å‡½å­ç§°ä¹‹ä¸º <strong>è‡ªå‡½å­ï¼ˆEndofunctorï¼‰</strong>ã€‚</p>
<h4 id="å¯ä»¥æŠŠèŒƒç•´å½“ä½œä¸€ç»„ç±»å‹çš„é›†åˆ"><a href="#å¯ä»¥æŠŠèŒƒç•´å½“ä½œä¸€ç»„ç±»å‹çš„é›†åˆ" class="headerlink" title="å¯ä»¥æŠŠèŒƒç•´å½“ä½œä¸€ç»„ç±»å‹çš„é›†åˆ"></a>å¯ä»¥æŠŠèŒƒç•´å½“ä½œä¸€ç»„ç±»å‹çš„é›†åˆ</h4><p>å¦‚èŒƒç•´ C æœ‰ <code>Int</code> ç±»å‹å’Œ <code>String</code> ç±»å‹å¯¹è±¡ï¼Œä»¥åŠ <code>Int -&gt; String</code> çš„æ€å°„ï¼›èŒƒç•´ D æœ‰ <code>Array&lt;Int&gt;</code> ç±»å‹å’Œ <code>Array&lt;String&gt;</code> ç±»å‹å¯¹è±¡ï¼Œä»¥åŠ <code>Array&lt;Int&gt; -&gt; Array&lt;String&gt;</code> çš„æ€å°„ã€‚ä¸¤ä¸ªèŒƒç•´ä¹‹é—´çš„æ˜ å°„ Fï¼š</p>
<ul>
<li><code>Int</code> æ˜ å°„è‡³ <code>Array&lt;Int&gt;</code> ä¸Šï¼Œ<code>String</code> æ˜ å°„è‡³ <code>Array&lt;String&gt;</code> ä¸Šã€‚</li>
<li>æ€å°„ <code>Int -&gt; String</code> æ˜ å°„è‡³ <code>Array&lt;Int&gt; -&gt; Array&lt;String&gt;</code> ä¸Šã€‚</li>
</ul>
<p>ç¿»è¯‘æˆä»£ç ï¼šC: <code>Int</code>, <code>String</code>, f: <code>Int -&gt; String</code>, D: <code>Array&lt;Int&gt;</code>, <code>Array&lt;String&gt;</code>, f: <code>Array&lt;Int&gt; -&gt; Array&lt;String&gt;</code>ã€‚</p>
<ul>
<li>x: <code>Int</code> -&gt; F(x): <code>Array&lt;Int&gt;</code>ï¼Œ<code>String</code> -&gt; F(x): <code>Array&lt;String&gt;</code></li>
<li>f: <code>(Int -&gt; String)</code> -&gt; F(f): <code>(Array&lt;Int&gt; -&gt; Array&lt;String&gt;)</code></li>
</ul>
<p>èŒƒç•´æ˜¯ä¸æ¶‰åŠå…·ä½“ç±»å‹çš„ï¼Œæ‰€ä»¥ç”¨æ³›å‹è¡¨ç¤ºï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tmap</span>&lt;T&gt;<span class="params">(x: T)</span></span> -&gt; <span class="type">F</span>&lt;<span class="type">T</span>&gt;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fmap</span>&lt;A, B&gt;<span class="params">(f: A -&gt; B)</span></span> -&gt; (<span class="type">F</span>&lt;<span class="type">A</span>&gt; -&gt; <span class="type">F</span>&lt;<span class="type">B</span>&gt;)</span><br></pre></td></tr></table></figure>
<p>ç®€åŒ–ä¸€ä¸‹å˜æˆï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Swift ä¸­æŠŠ Int æ˜ å°„åˆ° Array&lt;Int&gt; ç”± Array çš„åˆå§‹åŒ–æ–¹æ³•æä¾›ï¼Œ</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥å¯ä»¥ä¸å†™ã€‚</span></span><br><span class="line"><span class="comment">// ç”±äº fmap å®é™…ä¸Šæ˜¯ (F&lt;A&gt;, A -&gt; B) -&gt; F&lt;B&gt; çš„ currying ç‰ˆæœ¬ï¼Œ</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">map</span>&lt;A, B&gt;<span class="params">(x: F&lt;A&gt;, f: A -&gt; B)</span></span> -&gt; <span class="type">F</span>&lt;<span class="type">B</span>&gt;</span><br></pre></td></tr></table></figure>
<p>å†æ¥çœ‹çœ‹ Swift ä¸­çš„ <code>Array</code> å’Œ <code>Optional</code>ã€‚å¦‚æœæŠŠ Swift ä¸­æ‰€æœ‰çš„ç±»å‹ <code>A, B</code> å½“ä½œå¯¹è±¡ï¼Œä»¥åŠ Swift ä¸­æ‰€æœ‰çš„å‡½æ•°å½“ä½œæ€å°„ <code>A -&gt; B</code>ï¼Œé‚£ä¹ˆè¿™äº›ç±»å‹å’Œå‡½æ•°å°±ç»„æˆä¸€ä¸ªèŒƒç•´ Aã€‚æŠŠ <code>Array</code> ç±»å‹å½“ä½œå¯¹è±¡ <code>Array&lt;A&gt;, Array&lt;B&gt;</code>ï¼Œ<code>Array</code> ä¸Šæ‰€æœ‰çš„å‡½æ•°å½“ä½œæ€å°„ <code>Array&lt;A&gt; -&gt; Array&lt;B&gt;</code>ï¼Œé‚£ä¹ˆä¹Ÿç»„æˆä¸€ä¸ªèŒƒç•´ Bã€‚è€Œ A åˆ° B ä¹‹é—´çš„å‡½å­æ˜¯ <code>Array</code>ï¼Œå› ä¸ºå‡½å­ <code>Array</code> èƒ½å°†ä»»æ„ç±»å‹ <code>T</code> è½¬æ¢ä¸º <code>Array&lt;T&gt;</code>ã€‚<code>Optional</code> åŒç†ã€‚</p>
<p>å¾ˆå¤šåº“å¯¹ <code>Functor</code> çš„æ”¯æŒç›´æ¥åœ¨ç±»å‹æ„é€ å™¨ï¼ˆType Constructorï¼‰çš„å®šä¹‰ä¸­å®ç° <code>map</code> æ–¹æ³•ï¼Œæ¯”å¦‚ Swift ä¸­çš„ <code>Array</code> å’Œ <code>Optional</code> å°±æ˜¯éœ€è¦ä¸€ä¸ªæ³›å‹ä½œä¸ºå‚æ•°æ¥æ„å»ºå…·ä½“ç±»å‹çš„ç±»å‹æ„é€ å™¨ï¼Œå®ƒåœ¨å®šä¹‰ä¸­å®ç°äº† <code>map</code> æ–¹æ³•ã€‚è¿™äº›ç±»å‹æ„é€ å™¨ç›¸å½“äºåŒæ—¶å…·å¤‡äº†ç±»å‹å’Œå‡½æ•°çš„æ˜ å°„ã€‚åœ¨ Haskell é‡ŒæŠŠè¿™ä¸ªè¡Œä¸ºç§°ä¸º <code>Lift</code>ï¼Œç›¸å½“äºæŠŠç±»å‹å’Œå‡½æ•°æ”¾åˆ°å®¹å™¨é‡Œé¢ã€‚æ‰€ä»¥ä¸€ä¸ªå¸¦æœ‰ <code>map</code> æ–¹æ³•çš„ç±»å‹æ„é€ å™¨å°±æ˜¯ä¸€ä¸ªå‡½å­ã€‚</p>
<p>èŒƒç•´ä¸é«˜é˜¶ç±»å‹ï¼šå¦‚æœå¿½ç•¥èŒƒç•´ä¸­çš„æ€å°„ï¼ŒèŒƒç•´å…¶å®å°±æ˜¯å¯¹ç‰¹å®šç±»å‹çš„æŠ½è±¡ï¼Œå³é«˜é˜¶ç±»å‹ï¼ˆç±»å‹æ„é€ å™¨ï¼‰ã€‚å¯¹äºèŒƒç•´ Dï¼Œå®ƒçš„æ‰€æœ‰ç±»å‹éƒ½æ˜¯ <code>Array&lt;T&gt;</code> çš„ç‰¹å®šç±»å‹ã€‚è€Œå¯¹äºèŒƒç•´ Cï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª Identity ç±»å‹çš„æ„é€ å™¨ï¼ˆid[T] = Tï¼‰ã€‚</p>
<p>æ³¨æ„âš ï¸ï¼šå‡½å­ä¸æ˜¯å®¹å™¨ï¼Œå‡½å­ä¸æ˜¯å®¹å™¨ï¼Œå‡½å­ä¸æ˜¯å®¹å™¨ã€‚<br>å¦‚ <code>typealias Parser&lt;A&gt; = (String) -&gt; (A, String)?</code> æˆ‘ä»¬å¯ä»¥å®ç° <code>func map&lt;A, B&gt;(x: Parser&lt;A&gt;, f: (A) -&gt; B) -&gt; Parser&lt;B&gt;</code> å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´ <code>Parser&lt;A&gt;</code> æ˜¯ä¸€ä¸ªå‡½å­ï¼Œä½†å®ƒä¸æ˜¯å®¹å™¨ã€‚</p>
<h3 id="Endofunctor"><a href="#Endofunctor" class="headerlink" title="Endofunctor"></a>Endofunctor</h3><blockquote>
<p>A functor that maps a category to itselfã€‚ä¸€ä¸ªç”±ä¸€èŒƒç•´æ˜ å°„è‡³å…¶è‡ªèº«çš„å‡½å­ç§°ä¹‹ä¸º <strong>è‡ªå‡½å­ï¼ˆEndofunctorï¼‰</strong>ã€‚</p>
</blockquote>
<p>å…ˆçœ‹è‡ªå‡½æ•°çš„æ¦‚å¿µï¼šå°†ä¸€ä¸ªç±»å‹æ˜ å°„åˆ°è‡ªèº«ç±»å‹ï¼Œå¦‚ <code>Int -&gt; Int</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(x: Int)</span></span> -&gt; <span class="type">Int</span> &#123; <span class="keyword">return</span> x + <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>
<p>å•ä½å‡½æ•°ï¼ˆIdentity Functionï¼‰çš„æ¦‚å¿µï¼šä»€ä¹ˆéƒ½ä¸åšï¼Œä¼ å…¥ä»€ä¹ˆå°±è¿”å›ä»€ä¹ˆã€‚å±äºè‡ªå‡½æ•°çš„ç‰¹ä¾‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">id</span><span class="params">(x: Int)</span></span> -&gt; <span class="type">Int</span> &#123; <span class="keyword">return</span> x &#125;</span><br></pre></td></tr></table></figure>
<p><strong>è‡ªå‡½å­ä¸æ˜¯å•ä½å‡½å­ï¼ˆIdentity Functorï¼‰</strong>ã€‚è¿˜æ˜¯ä¸Šé¢çš„èŒƒç•´ Cï¼Œä¸ºäº†åŒºåˆ†è‡ªå‡½å­å’Œå•ä½å‡½å­ï¼Œå¤šåŠ ä¸€ç§æ€å°„ g: <code>String -&gt; Int</code>ï¼Œé‚£ä¹ˆï¼š</p>
<p>è‡ªå‡½å­ï¼šå¯¹äºå‡½å­ Fï¼Œå¯¹äº <code>F(Int)</code> ç»“æœæ˜¯ <code>String</code>ï¼Œ<code>F(String)</code> ç»“æœæ˜¯ <code>Int</code>ï¼Œå¯¹äº <code>F(f: Int -&gt; String)</code> ç»“æœæ˜¯ g: <code>String -&gt; Int</code>ã€‚é‚£ä¹ˆè¿™ä¸ªå‡½å­å°±æ˜¯è‡ªå‡½å­ã€‚</p>
<p>å•ä½å‡½å­ï¼ˆIdentity Functorï¼‰ï¼šå¯¹äºå‡½å­ Fï¼Œå¯¹äº <code>F(Int)</code> ç»“æœè¿˜æ˜¯ <code>Int</code>ï¼Œå¯¹äº <code>F(String)</code> ç»“æœè¿˜æ˜¯ <code>String</code>ï¼Œå¯¹äº <code>F(f: Int -&gt; String)</code> ç»“æœè¿˜æ˜¯ <code>f: Int -&gt; String</code>ï¼Œå¯¹äº <code>F(g: String -&gt; Int)</code> ç»“æœè¿˜æ˜¯ g: <code>String -&gt; Int</code>ã€‚é‚£ä¹ˆè¿™ä¸ªå‡½å­å°±æ˜¯å•ä½å‡½å­ã€‚ </p>
<h2 id="Applicative"><a href="#Applicative" class="headerlink" title="Applicative"></a>Applicative</h2><blockquote>
<p>An applicative is a monoid in the category of endofunctors, whatâ€™s the problem?</p>
</blockquote>
<p>è™½ç„¶åœ¨ Haskell ä¸­ Monad æ˜¯ Applicative çš„ä¸€ç§ï¼Œä½†æ˜¯ Applicative çš„å‡ºç°å´åœ¨ Monad ä¹‹åã€‚</p>
<p><a href="https://www.reddit.com/r/haskell/comments/2lompe/where_do_the_applicative_laws_come_from/" target="_blank" rel="noopener">Applicative</a></p>
<h2 id="Monad"><a href="#Monad" class="headerlink" title="Monad"></a>Monad</h2><blockquote>
<p>A monad is a monoid in the category of endofunctors â€“ Philip Wadler</p>
</blockquote>
<p>è‡ªå‡½å­è¯´ç©¿äº†å°±æ˜¯æŠŠä¸€ä¸ªèŒƒç•´æ˜ å°„åˆ°è‡ªèº«çš„å‡½å­ï¼Œè‡ªå‡½å­èŒƒç•´è¯´ç©¿äº†å°±æ˜¯ä»å°èŒƒç•´æ˜ å°„åˆ°è‡ªèº«çš„å‡½å­æ‰€æ„æˆçš„ä»¥è‡ªå‡½å­ä¸ºå¯¹è±¡ä»¥è‡ªç„¶å˜æ¢ä¸ºæ€å°„çš„èŒƒç•´ï¼Œå¹ºåŠç¾¤è¯´ç©¿äº†å°±æ˜¯åªæœ‰å•ä¸ªå¯¹è±¡çš„èŒƒç•´ï¼Œç»™å®šäº†ä¸€ä¸ªå¹ºåŠç¾¤åˆ™å¯æ„é€ å‡ºä¸€ä¸ªä»…æœ‰å•ä¸ªå¯¹è±¡çš„å°èŒƒç•´ä½¿å…¶æ€å°„ç”±å¹ºåŠç¾¤çš„å…ƒç´ ç»™å‡ºè€Œåˆæˆç”±å¹ºåŠç¾¤çš„è¿ç®—ç»™å‡ºï¼Œè€Œå•å­è¯´ç©¿äº†å°±æ˜¯è‡ªå‡½å­èŒƒç•´ä¸Šçš„è¿™æ ·ä¸€ä¸ªå¹ºåŠç¾¤ã€‚ï¼ˆè¿™éƒ½ä¸ç†è§£ä¹ˆäº²è¿è¿™ç§æœ€åŸºæœ¬çš„æ¦‚å¿µéƒ½ä¸ç†è§£è¿˜å­¦ä»€ä¹ˆç¼–ç¨‹ï¼</p>
<p>ä¸€ç³»åˆ— Endofunctor ç»„æˆçš„èŒƒç•´ï¼Œæˆä¸º <strong>è‡ªå‡½å­èŒƒç•´</strong>ã€‚</p>
<ul>
<li>X ä¸Šçš„è‡ªå‡½å­ï¼šFï¼š<code>X -&gt; X</code></li>
<li>å•ä½è‡ªå‡½å­ id[X] åˆ°å‡½å­ F çš„è‡ªç„¶è½¬æ¢ï¼š<code>id[X] -&gt; F</code> (pure</li>
<li>å‡½å­ F çš„å¼ é‡ç§¯ FâŠ—F åˆ°å‡½å­ F çš„è‡ªç„¶è½¬æ¢ï¼š<code>FâŠ—F -&gt; F</code> (join</li>
</ul>
<p>ä»£ç è¡¨ç¤ºï¼š</p>
<ul>
<li><code>func unit&lt;T&gt;(x: T) -&gt; F&lt;T&gt; // x = id[x]</code> </li>
<li><code>func join&lt;T&gt;(a: F&lt;F&lt;T&gt;&gt;) -&gt; F&lt;T&gt;</code></li>
</ul>
<p>æ­¤å¤„å‡½å­çš„å¼ é‡ç§¯ âŠ— å¯ä»¥çœ‹ä½œä¸ºç»„åˆï¼ˆCompositionï¼‰ï¼›<br>æ³¨æ„ç»“åˆ Monoidal Category ç†è§£ï¼Œ<code>unit</code> å’Œ <code>join</code> æ»¡è¶³ Monoid çš„å®šå¾‹ï¼Œæ‰€æœ‰å½¢æˆäº† Monoidã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼šå•å­ï¼ˆMonadï¼‰æ˜¯è‡ªå‡½å­çš„ Monoidal èŒƒç•´ä¸Šçš„ä¸€ä¸ªå¹ºåŠç¾¤ï¼Œè¯¥ Monoidal èŒƒç•´çš„å¼ é‡ç§¯ï¼ˆTensor Productï¼ŒâŠ—ï¼šFÃ—F -&gt; Fï¼‰æ˜¯è‡ªå‡½å­çš„å¤åˆï¼ˆCompositionï¼‰ï¼Œå•ä½å…ƒæ˜¯ Id Functorã€‚</p>
<p><code>bind</code> æˆ–è€…è¯´ <code>flatMap</code> æˆ–è€… <code>&gt;&gt;=</code> å…¶å®ç­‰äº <code>map + join</code>ã€‚ï¼ˆè§ <a href="https://github.com/apple/swift" target="_blank" rel="noopener">apple/swift</a> ä¸­çš„ <code>stdlib/public/core/FlatMap.swift</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> &gt;&gt;=&lt;A, B&gt;<span class="params">(x: F&lt;A&gt;, f: A -&gt; F&lt;B&gt;)</span></span> -&gt; <span class="type">F</span>&lt;<span class="type">B</span>&gt;</span><br><span class="line"><span class="comment">// Currying å‰çš„æ ·å­</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> &gt;&gt;=&lt;A, B&gt;<span class="params">(x: F&lt;A&gt;)</span></span> -&gt; (f: <span class="type">A</span> -&gt; <span class="type">F</span>&lt;<span class="type">B</span>&gt;) -&gt; <span class="type">F</span>&lt;<span class="type">B</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>Too much</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2017/05/28/parser-combinator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/28/parser-combinator/" itemprop="url">Parser Combinator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-05-28T20:00:00+08:00">
                2017-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/functional-programming/" itemprop="url" rel="index">
                    <span itemprop="name">functional programming</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>è§£æç»„åˆå­æ˜¯ç”±å¤šä¸ªè§£æå™¨ä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªè§£æå™¨çš„é«˜é˜¶å‡½æ•°ã€‚</p>
<h2 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h2><p>å°†ä¸€ä¸ªæ•°æ®æµè§£ææˆç»“æ„åŒ–çš„æ•°æ®çš„å·¥å…·ï¼Œæˆ‘ä»¬ç§°ä¸ºè§£æå™¨ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·è¾“å…¥çš„è¡¨è¾¾å¼å­—ç¬¦ä¸²è§£ææˆ ASTï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è§£æå™¨æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚</p>
<p><code>( 4 + 3  )</code> å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼è¯­å¥ï¼Œå®ƒç”±å­—ç¬¦ <code>(</code>  <code>4</code> <code>ç©ºæ ¼</code> <code>+</code> <code>3</code> å’Œ <code>)</code> ç»„æˆã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªè¡¨è¾¾å¼è§£ææˆä¸€ç§ <em>è¡¨è¾¾å¼æ ‘</em> (AST çš„ä¸€ç§)ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„è§£æå™¨ç®€å•çš„ç”¨ä¸€ä¸ªå‡½æ•°æ¥æè¿°å°±æ˜¯ï¼š<br><code>func parser(_ string: String) -&gt; AST</code></p>
<p>æˆ‘ä»¬ä¸æ˜¯ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è§£æè¾“å…¥çš„è¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼Œä¸ºäº†å¾—åˆ°è¡¨è¾¾å¼æ ‘é‡Œé¢çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ­¥æ­¥çš„è§£æï¼Œæ¯æ¬¡è§£æå¾—åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è§£æå™¨çš„å®šä¹‰å˜æˆè§£ææˆåŠŸçš„è¯ï¼Œä¼šè¿”å›ç»“æœå€¼å’Œå‰©ä¸‹çš„å­—ç¬¦ä¸²ã€‚</p>
<p><code>func parser(_ string: String) -&gt; (AST, String)</code></p>
<p>è¡¨è¾¾å¼æ ‘çš„èŠ‚ç‚¹éƒ½æ˜¯ä¸€äº› <code>4</code> <code>+</code> è¿™ç§ä¸åŒç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥ä¸ºäº†è¡¨ç¤ºè§£æ <code>4</code> æˆåŠŸå’Œè§£æ <code>+</code> æˆåŠŸï¼Œæˆ‘ä»¬çš„è¿”å›å€¼å¯ä»¥å®šä¹‰ä¸ºæ³›å‹ã€‚å¹¶ä¸”è¡¨è¾¾å‡ºè§£æå¤±è´¥çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¯é€‰å€¼ã€‚æœ€ç»ˆè§£æå™¨å‡½æ•°å°±å˜æˆäº†ï¼š</p>
<p><code>func parser&lt;T&gt;(_ string: String) -&gt; (T, String)?</code></p>
<p>æ‰€ä»¥è§£æç¬¬ä¸€ä¸ªæ•°å­— 4 çš„è§£æå™¨å‡½æ•°ä¸ºï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parser</span><span class="params">(<span class="number">_</span> string: String)</span></span> -&gt; (<span class="type">Int</span>, <span class="type">String</span>)? &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> head = string.characters.first, head == <span class="string">"4"</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Optional</span>.some((<span class="number">4</span>, <span class="type">String</span>(string.characters.<span class="built_in">dropFirst</span>())))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Combinator"><a href="#Combinator" class="headerlink" title="Combinator"></a>Combinator</h2><blockquote>
<p>One of the distinguishing features of functional programming is the widespread use of combinators to construct programs. <em>A combinator is a function which builds program fragments from program fragments</em>; in a sense the programmer using combinators constructs much of the desired program automatically, rather that writing every detail by hand. â€“ John Hughes</p>
</blockquote>
<p>å…¶å® Combinator å¾ˆå®¹æ˜“ç†è§£ï¼Œå°±åƒå­—é¢æ„æ€é‚£æ · â€”â€” ç»„åˆå­ã€‚é¦–å…ˆå®šä¹‰ä¸€ç³»åˆ—åŸå­æ“ä½œï¼Œç„¶åå®šä¹‰ç»„åˆçš„è§„åˆ™ï¼Œç„¶åæ ¹æ®ç»„åˆçš„è§„åˆ™æŠŠè¿™äº›åŸå­æ“ä½œç»„åˆèµ·æ¥ã€‚</p>
<h2 id="Parser-Combinator"><a href="#Parser-Combinator" class="headerlink" title="Parser Combinator"></a>Parser Combinator</h2><p>å›åˆ°å¼€å¤´çš„è¯ï¼š<em>è§£æç»„åˆå­æ˜¯ç”±å¤šä¸ªè§£æå™¨ä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªè§£æå™¨çš„é«˜é˜¶å‡½æ•°ã€‚</em> æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡æ–°å®šä¹‰ä¸€ä¸‹æˆ‘ä»¬çš„è§£æå™¨ï¼ŒæŠŠå®ƒå˜æˆä¸€ä¸ªè§£æç»„åˆå­ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Parser</span>&lt;<span class="title">A</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> parse: (<span class="type">String</span>) -&gt; (<span class="type">A</span>, <span class="type">String</span>)?</span><br><span class="line">    <span class="comment">// (input) -&gt; (result, remaining)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªè§£æå­—ç¬¦ä¸²çš„è§£æå™¨ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå‡½æ•°æ”¾åˆ°ä¸€ä¸ªç»“æ„ä½“ <code>Parser</code> ä¸­ï¼Œä½œä¸ºä¸€ä¸ª <code>parse</code> å˜é‡ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç±»å‹åˆ«å <code>typealias Parser&lt;Result&gt; = (String) -&gt; (Result, String)?</code>ã€‚</p>
<p>å½“ç„¶è§£æç»„åˆå­ä¸ä»…ä»…èƒ½è§£æå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ³›å‹æ¥æŠŠå®ƒå˜å¾—æ›´é€šç”¨ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Parser</span>&lt;<span class="title">I</span>, <span class="title">O</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> parse: (<span class="type">I</span>) -&gt; (<span class="type">O</span>, <span class="type">I</span>)?</span><br><span class="line">    <span class="comment">// (input) -&gt; (output, remaining input)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è§£ææ•°å­—å­—ç¬¦ <code>4</code> çš„è§£æå™¨å°±å˜æˆäº†ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">character4</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Character</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> head = input.characters.first, head == <span class="string">"4"</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"4"</span>, <span class="type">String</span>(input.characters.<span class="built_in">dropFirst</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æ ¹æ® <code>func character4() -&gt; Parser&lt;Character&gt;</code> å¾ˆå®¹æ˜“å¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿè§£æä»»ä½•å­—ç¬¦çš„è§£æå™¨ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">character</span><span class="params">(<span class="number">_</span> character: Character)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Character</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> head = input.characters.first, head == character <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (head, <span class="type">String</span>(input.characters.<span class="built_in">dropFirst</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® <code>character</code> å’Œ <code>digit</code> çš„åŒºåˆ«ï¼Œå¾ˆå®¹æ˜“åˆå¾—åˆ°èƒ½å¤Ÿè§£æä»»ä½•æ•°å­—çš„è§£æå™¨ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">digit</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Character</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> head = input.characters.first, <span class="string">"0"</span>...<span class="string">"9"</span> ~= head <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (head, <span class="type">String</span>(input.characters.<span class="built_in">dropFirst</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® <code>character</code> å’Œ <code>digit</code> ç›¸åŒå’Œä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡ï¼ŒæŠŠç›¸åŒéƒ¨åˆ†è¿›è¡Œå°è£…ï¼ŒæŠŠä¸åŒéƒ¨åˆ†ä½œä¸ºå‚æ•°ï¼Œå¾—åˆ°æ–°çš„è§£æå™¨ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">satisfy</span><span class="params">(<span class="number">_</span> condition: @escaping <span class="params">(Character)</span></span></span> -&gt; <span class="type">Bool</span>) -&gt; <span class="type">Parser</span>&lt;<span class="type">Character</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> head = input.characters.first, condition(head) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (head, <span class="type">String</span>(input.characters.<span class="built_in">dropFirst</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è§£ææ•°å­—ï¼š</p>
<p><code>(satisfy { &quot;0&quot;...&quot;9&quot; ~= $0 }).parse(&quot;1abc&quot;)</code></p>
<p>è§£æç©ºæ ¼ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isSpace</span><span class="params">(<span class="number">_</span> character: Character)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">String</span>(character).trimmingCharacters(<span class="keyword">in</span>: .whitespacesAndNewlines).isEmpty</span><br><span class="line">&#125;</span><br><span class="line">(satisfy(isSpace)).parse(<span class="string">" abc"</span>)</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç»™ <code>satisfy</code> å‡½æ•°ä¼ å…¥ä¸€ä¸ªæ˜¯å¦å±äº X çš„å‡½æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿè§£æ x çš„è§£æå™¨ã€‚</p>
<h2 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h2><p>æœ€åŸºæœ¬çš„ <code>character</code> æœ‰äº†ï¼Œ<code>digit</code> æœ‰äº†ï¼Œå½“æˆ‘ä»¬éœ€è¦è§£æä¸€ä¸ªå­—ç¬¦ä¸² <code>alex</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ <code>alex</code> çœ‹æˆ <code>a</code> <code>l</code> <code>e</code> <code>x</code> 4 ä¸ªå­—ç¬¦ï¼Œç„¶åä¸æ–­çš„ç”¨ <code>character</code> è¿›è¡Œè§£æï¼Œæœ€åæŠŠæ¯ä¸€æ­¥è¿”å›çš„ç»“æœåˆå¹¶èµ·æ¥å°±è¡Œäº†ã€‚è€ƒè™‘åˆ°è§£æä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ï¼Œä¸ºäº†ä¸ç”¨æ¯æ¬¡å†™é‡å¤çš„ä»£ç ï¼ŒæŠŠå®ƒå°è£…æˆç”¨æ¥è§£æ <code>string</code> çš„è§£æå™¨ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> parsers = str.characters.<span class="built_in">map</span> &#123; character($<span class="number">0</span>) &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">var</span> results: [<span class="type">Character</span>] = []</span><br><span class="line">        <span class="keyword">var</span> stream = input</span><br><span class="line">        <span class="keyword">for</span> parser <span class="keyword">in</span> parsers &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> (result, remainder) = parser.parse(stream) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            results.append(result)</span><br><span class="line">            stream = remainder</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">String</span>(results), stream)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿ parse å‡½æ•°ç±»å‹ <code>(String) -&gt; (A, String)</code>ï¼Œè§£ææˆåŠŸçš„è¿”å›å€¼æ˜¯è§£æç»“æœå’Œ <strong>å‰©ä½™</strong> çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è§£æ <code>alex</code> çš„æ—¶å€™ï¼š</p>
<ol>
<li>â€œalexâ€: â€˜aâ€™ -&gt; (â€˜aâ€™, â€œlexâ€)</li>
<li>â€œlexâ€: â€˜lâ€™ -&gt; (â€˜lâ€™, â€œexâ€)</li>
<li>â€œexâ€: â€˜eâ€™ -&gt; (â€˜eâ€™, â€œxâ€)</li>
<li>â€œxâ€: â€˜xâ€™ -&gt; (â€˜xâ€™, â€œâ€)</li>
<li>Parser&lt;â€alexâ€&gt;</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°è¿™å‡ æ­¥åšçš„äº‹æƒ…é™¤äº†å‚æ•°ä¸ä¸€æ ·ï¼Œå†…éƒ¨é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å¾ˆå®¹æ˜“çœ‹å‡ºæ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œ<strong>æ¯æ¬¡è§£ææˆåŠŸå°± <code>åƒæ‰</code> ç¬¬ä¸€ä¸ªå­—ç¬¦</strong>ï¼ˆç•™æ„è¿™å¥è¯ï¼‰ï¼Œç„¶åè§£æå‰©ä¸‹çš„å­—ç¬¦ä¸²ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å†™ä¸€ä¸ªé€’å½’çš„ç‰ˆæœ¬ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (head, tail) = uncons(str.characters) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 0. æŠŠç©ºå­—ç¬¦è§£æå™¨å»è§£æä»»ä½•å­—ç¬¦ä¸²ï¼Œéƒ½è®¤ä¸ºæ˜¯è§£ææˆåŠŸ</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="string">""</span>, input)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1. å…ˆè§£æç¬¬ä¸€ä¸ªå­—ç¬¦</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder1) = character(head).parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. ç„¶åè§£æå‰©ä¸‹çš„æ‰€æœ‰</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder2) = string1(<span class="type">String</span>(tail)).parse(remainder1) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. è¿”å›("ç»“æœ", "å‰©ä½™çš„å­—ç¬¦ä¸²")</span></span><br><span class="line">        <span class="keyword">return</span> (str, remainder2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">uncons</span>&lt;C: Collection&gt;<span class="params">(<span class="number">_</span> xs: C)</span></span> -&gt; (<span class="type">C</span>.<span class="type">Iterator</span>.<span class="type">Element</span>, <span class="type">C</span>.<span class="type">SubSequence</span>)? &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> head = xs.first <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (head, xs.suffix(from: xs.index(after: xs.startIndex)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿ 1 å’Œ 2ï¼Œåœ¨è¿™ä¸¤æ­¥ä¸­ï¼Œæˆ‘ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨è§£æçš„ <strong>ç»“æœ</strong>ï¼Œè¿™ä¸¤æ­¥å®ç°çš„ä»…ä»…æ˜¯ <strong>æ¯æ¬¡è§£ææˆåŠŸå°± <code>åƒæ‰</code> ç»“æœ</strong>ï¼æœ€ååœ¨ç¬¬ 3 æ­¥ä¸€æ¬¡å°†ç»“æœè¿”å›ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ 1 å’Œ 2 è¿™ä¸¤æœ¬å¹¶ä¸å…³å¿ƒç»“æœï¼Œåªå…³å¿ƒè¿™äº›è¦è§£æé“å­—ç¬¦å­˜åœ¨å°±è¡Œäº†ã€‚</p>
<p>æˆ‘ä»¬æŠŠè§£ææˆåŠŸåƒæ‰ç»“æœè¿™ä¸€æ­¥å°è£…ä¸€ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">discarding</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> y: Parser&lt;B&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder1) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result2, remainder2) = y.parse(remainder1) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åªä¿ç•™å³è¾¹çš„è§£æå™¨çš„ç»“æœ result2ï¼Œæ²¡æœ‰ result1</span></span><br><span class="line">        <span class="keyword">return</span> (result2, remainder2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>discarding</code> å‡½æ•°ä¼š <strong>åƒæ‰</strong> å·¦è¾¹ç¬¬ä¸€ä¸ªå‚æ•° <code>x</code> çš„è§£æç»“æœï¼Œè¿”å›å€¼ä¸­åªä¿ç•™å³è¾¹ <code>y</code> çš„è§£æç»“æœã€‚ç”¨ <code>discarding</code> å‡½æ•°é‡å†™ä¸€ä¸‹ä¸Šé¢çš„ <code>string</code> å‡½æ•°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (head, tail) = uncons(str.characters) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æŠŠç©ºå­—ç¬¦è§£æå™¨å»è§£æä»»ä½•å­—ç¬¦ä¸²ï¼Œéƒ½è®¤ä¸ºæ˜¯è§£ææˆåŠŸ</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="string">""</span>, input)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1 åƒæ‰ character(head) çš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder) = discarding(character(head), string2(<span class="type">String</span>(tail))).parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2 è¿”å› ("ç»“æœ", "å‰©ä½™çš„å­—ç¬¦ä¸²")</span></span><br><span class="line">        <span class="keyword">return</span> (str, remainder)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ¬¡æ”¹ç‰ˆçš„ <code>string</code> é‡Œé¢ç¬¬ 1 æ­¥ä¸­çš„è§£æç»“æœè¿˜æ˜¯è¢«å¿½ç•¥äº†ï¼Œæ‰€ä»¥æ˜¯å¦å¯ä»¥ç»§ç»­ç”¨ <code>discarding</code> æ¥ç®€åŒ–ï¼Ÿä½†æ˜¯ <code>discarding</code> å‡½æ•°éœ€è¦ä¸¤ä¸ªè§£æå™¨ï¼Œä½†å‡½æ•°å†…åªæœ‰ <code>lift</code> è¿”å›çš„ä¸€ä¸ªè§£æå™¨ï¼Œæ‰€ä»¥æ²¡åŠæ³•ç»§ç»­ç®€åŒ–äº†ï¼Ÿ</p>
<p>ä»”ç»†çœ‹ <code>string</code> å‡½æ•°ä½“çš„ç¬¬ä¸€è¡Œ <code>return Parser {}</code> å°±æ˜¯ä¸€ä¸ªè§£æå™¨ï¼Œèƒ½å¦æŠŠè¿™ä¸ªè§£æå™¨åˆ©ç”¨ä¸Šå‘¢ï¼Ÿ<code>discarding</code> æ˜¯åœ¨ <code>Parser {}</code> é‡Œé¢çš„ï¼Œæ‰€ä»¥åªè¦èƒ½æƒ³åŠæ³•æŠŠå®ƒå±•å¹³ï¼Œé‚£ä¹ˆå°±èƒ½å†æ¬¡åˆ©ç”¨ä¸Š <code>lift</code>ï¼Œè€Œä¸”å±•å¹³åçš„è§£æå™¨éœ€è¦åšä¸º <code>string</code> å‡½æ•°çš„è¿”å›å€¼ï¼Œæ‰€ä»¥å®ƒè‚¯å®šæ˜¯åšä¸º <code>discarding</code> çš„å³è¾¹çš„å‚æ•°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> lhs = <span class="type">Parser</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">let</span> rhs = <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> lift(x, y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ç¬¬ 2 æ­¥çš„ <code>return (str, remainder)</code> å¯ä»¥çŸ¥é“ï¼Œæœ€ç»ˆçš„è¿”å›ç»“æœæ˜¯ <code>(è¾“å…¥çš„ï¼Œlhs åƒå‰©çš„)</code>ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å¾—åˆ° <code>let rhs = Parser&lt;String&gt; { (str, $0) }</code>ã€‚æ‰€ä»¥å¯ä»¥æ¨å‡º lhs è¦åšçš„åªæ˜¯è´Ÿè´£åƒæ‰ä¸€éƒ¨åˆ†ã€‚ä¹Ÿå°±æ˜¯ä¸Šé¢çš„ç¬¬ 1 æ­¥æ‰€åšçš„ã€‚æ‰€ä»¥ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> (head, tail) = uncons(str.characters) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1 æŠŠç©ºå­—ç¬¦è§£æå™¨å»è§£æä»»ä½•å­—ç¬¦ä¸²ï¼Œéƒ½è®¤ä¸ºæ˜¯è§£ææˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="string">""</span>, input)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2 åƒæ‰</span></span><br><span class="line">    <span class="keyword">let</span> lhs = discarding(character(head), string2(<span class="type">String</span>(tail)))</span><br><span class="line">    <span class="comment">// 3 ç»“æœå’Œå‰©ä¸‹çš„</span></span><br><span class="line">    <span class="keyword">let</span> rhs = <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123; (str, $<span class="number">0</span>) &#125;</span><br><span class="line">    <span class="comment">// 4 è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> discarding(lhs, rhs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°çš„è¿”å›å€¼æ˜¯ <code>Parser</code>ï¼Œç”±äºå¤–é¢æ²¡æœ‰ Parser {} ï¼Œå±•å¼€å 1 é‚£é‡Œéœ€è¦è¿”å›ä¸€ä¸ª <code>Parser</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> (head, tail) = uncons(str.characters) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1 æŠŠç©ºå­—ç¬¦è§£æå™¨å»è§£æä»»ä½•å­—ç¬¦ä¸²ï¼Œéƒ½è®¤ä¸ºæ˜¯è§£ææˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123; (<span class="string">""</span>, $<span class="number">0</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">let</span> lhs = discarding(character(head), string2(<span class="type">String</span>(tail)))</span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">let</span> rhs = <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123; (str, $<span class="number">0</span>) &#125;</span><br><span class="line">    <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">return</span> discarding(lhs, rhs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜çœ¼äººå¯ä»¥çœ‹åˆ° 1 å’Œ 3 åªæœ‰ <code>&quot;&quot;</code> å’Œ <code>str</code> ä¸ä¸€æ ·ï¼Œå‰©ä¸‹çš„ä¸€æ¨¡ä¸€æ ·ï¼Œè™½ç„¶ä»£ç ä¸é•¿ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯æŠŠå®ƒç›¸åŒéƒ¨åˆ†å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œç„¶åæŠŠä¸åŒçš„éƒ¨åˆ†åšä¸ºå‚èµ›ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> (head, tail) = uncons(str.characters) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1 æŠŠç©ºå­—ç¬¦è§£æå™¨å»è§£æä»»ä½•å­—ç¬¦ä¸²ï¼Œéƒ½è®¤ä¸ºæ˜¯è§£ææˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> pure(<span class="string">""</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">let</span> lhs = discarding(character(head), string2(<span class="type">String</span>(tail)))</span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">let</span> rhs = pure(str)</span><br><span class="line">    <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">return</span> discarding(lhs, rhs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lift a value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pure</span>&lt;A&gt;<span class="params">(<span class="number">_</span> x: A)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123; (x, $<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å°è£…ä¸€ä¸ªç®€æ´çš„ <code>string</code> è§£æå™¨ï¼ŒèŠ±äº†å¾ˆå¤šåŠŸå¤«ï¼Œä½†æŠ›å¼€æ€§èƒ½ï¼Œå®ƒæ¯”è¿­ä»£çš„ç‰ˆæœ¬æ›´ç®€æ´æ˜“æ‡‚ã€‚</p>
<h2 id="Combine"><a href="#Combine" class="headerlink" title="Combine"></a>Combine</h2><p>è§‚å¯Ÿè¡¨è¾¾å¼ <code>( 4 + 3  )</code>ï¼Œé‡Œé¢ <code>(</code> å’Œ <code>4</code> ä¹‹é—´æœ‰ 1 ä¸ªç©ºæ ¼ï¼Œæ•°å­— <code>3</code> å’Œ <code>)</code> ä¸­é—´æ˜¯æœ‰ 2 ä¸ªç©ºæ ¼ï¼Œåœ¨åšåŠ æ³•è¿ç®—çš„æ—¶å€™ï¼Œè¿™äº› <em>many</em> ä¸ªç©ºæ ¼æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥éœ€è¦ <em>skip</em> æ‰ã€‚</p>
<h4 id="Many"><a href="#Many" class="headerlink" title="Many"></a>Many</h4><p>é¦–å…ˆéœ€è¦è§£æç©ºæ ¼çš„è§£æå™¨ï¼Œå‰é¢å·²ç»æœ‰å®ç°è¿‡ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">space</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Character</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> satisfy(isSpace)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºç©ºæ ¼æ•°é‡æœªçŸ¥ï¼Œå¯èƒ½æœ‰ <em>many</em> ä¸ªï¼Œå‡å¦‚æœ‰ä¸€ä¸ªè§£æå™¨ï¼Œèƒ½å¤Ÿè§£æ <em>many</em> ä¸ª parserã€‚ç”¨ä¸€ä¸ª loop ä¸æ–­å»è§£æå°±èƒ½å®ç°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">many</span>&lt;A&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;[<span class="type">A</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">var</span> results: [<span class="type">A</span>] = []</span><br><span class="line">        <span class="keyword">var</span> stream = input</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> (result, remainder) = x.parse(stream) &#123;</span><br><span class="line">            results.append(result)</span><br><span class="line">            stream = remainder</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (results, stream)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»»æ„ä¸ªç©ºæ ¼å°±æ˜¯ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">spaces</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;[<span class="type">Character</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> many(space())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>spaces</code> å¾—åˆ°çš„æ˜¯ä¸€ä¸ª <code>Parser&lt;[Character]&gt;</code> ç±»å‹çš„ parserï¼Œä½†æ˜¯æŒ‰ç…§ç†è§£æ›´å¸Œæœ›å¾—åˆ°ä¸€ä¸ª <code>Parser&lt;String&gt;</code> ç±»å‹çš„ parserã€‚åœ¨ Swift ä¸­ï¼Œ<code>String([Character])</code> å°±èƒ½å¤Ÿå°† <code>[Character]</code> æ‹æ‰æˆ <code>String</code> ç±»å‹ã€‚æ‰€ä»¥æŠŠ <code>many</code> ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">many</span>&lt;Character&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;Character&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">var</span> results: [<span class="type">Character</span>] = []</span><br><span class="line">        <span class="keyword">var</span> stream = input</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> (result, remainder) = x.parse(stream) &#123;</span><br><span class="line">            results.append(result)</span><br><span class="line">            stream = remainder</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">String</span>(results), stream)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä¸æ˜¯ä»»ä½•æ³›å‹ A ç±»å‹ï¼Œéƒ½èƒ½ç”¨ String æ‹æ‰ï¼Œä¹Ÿä¸ä¸€å®šèƒ½é€šè¿‡å…¶ä»–ç±»å‹è¿›è¡Œæ‹æ‰ï¼Œæ‰€ä»¥è¿™é‡ŒæŠŠæ³›å‹ A å»æ‰ï¼Œç›´æ¥ç”¨ Character ä»£æ›¿ã€‚ä½†æ˜¯è¿™æ ·åšå¹¶ä¸ç†æƒ³ï¼Œå› ä¸º <code>many</code> è§£æå™¨ä»ä¸€ä¸ªæ³›å‹è§£æå™¨ï¼Œå˜æˆäº†ä¸€ä¸ªåªèƒ½è§£æ Character ç±»å‹çš„è§£æå™¨ï¼Œå˜æˆäº† <code>manyCharacter</code>ã€‚åé¢è€ƒè™‘è§£æè¿™ä¸ªé—®é¢˜ï¼Œé‡æ–°æŠŠ <code>many</code> å˜æˆé€šç”¨çš„è§£æå™¨ã€‚</p>
<h4 id="Skip"><a href="#Skip" class="headerlink" title="Skip"></a>Skip</h4><p>æ¥ç€å®ç°ä¸€ä¸ªé€šç”¨çš„ <code>skip</code> è§£æå™¨ï¼Œå®ƒè¦åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œè¾“å…¥ä»€ä¹ˆåƒæ‰ä»€ä¹ˆï¼Œè¿”å›å‰©ä¸‹çš„ï¼Œå’Œä¸Šé¢åƒæ‰å·¦è¾¹çš„ <code>discarding</code> å¾ˆåƒï¼Œä¸ä¸€æ ·çš„æ˜¯ <code>skip</code> åªæœ‰ä¸€ä¸ªå‚æ•°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">skip</span>&lt;A&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((), input)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ((), remainder)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŠŠ <code>skip</code> å’Œ <code>spaces</code> è¿›è¡Œç»„åˆï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">skipSpaces</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> skip(spaces)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Many1"><a href="#Many1" class="headerlink" title="Many1"></a>Many1</h4><p>å‰é¢å®ç°çš„ <code>digit</code> è§£æå™¨ï¼Œå®ƒåªèƒ½è§£æä¸ªä½æ•°ï¼Œè¿™æ˜¯æ²¡æœ‰ä»€ä¹ˆåµç”¨çš„ã€‚ç›¸æ¯” <code>digit</code>ï¼Œæ›´åŠ éœ€è¦çš„æ˜¯ä¸€ä¸ª <code>number</code> è§£æå™¨ã€‚ä¸€ä¸ª <em>number</em> å®é™…ä¸Šä¹Ÿæ˜¯ç”± <em>many</em> ä¸ª <em>digit</em> ç»„æˆã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">number</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;[<span class="type">Character</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> many(digit())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">number().parse(<span class="string">"123abc"</span>) <span class="comment">// (["1", "2", "3"], "abc")</span></span><br><span class="line">number().parse(<span class="string">"abc"</span>) <span class="comment">// ([], "abc")</span></span><br></pre></td></tr></table></figure>
<p>ç­‰ç­‰ï¼<code>number().parse(&quot;abc&quot;)</code> ä¹Ÿè§£ææˆåŠŸäº†ï¼Œç»“æœæ˜¯ç©ºæ•°ç»„ã€‚è¿™å¹¶ä¸æ˜¯æƒ³è¦çš„ç»“æœï¼Œä¸€ä¸ª <em>string</em> å¯ä»¥æ˜¯ç©ºçš„ï¼Œ<em>space</em> ç”šè‡³ä¹Ÿå¯ä»¥æ˜¯ç©ºçš„ï¼Œä½†ä¸€ä¸ª <em>number</em> ä¸èƒ½æ˜¯ç©ºçš„ã€‚æ‰€ä»¥éœ€è¦å¦å¤–ä¸€ä¸ªåªæ˜¯æœ‰ä¸€ä¸ªçš„ <code>many</code>ã€‚è¿™å…¶å®å¾ˆå¸¸è§ï¼Œæ¯”å¦‚æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ‰ <code>*</code> å’Œ <code>+</code>ï¼Œä¸€ä¸ª {0, +} ä¸€ä¸ªæ˜¯ {1, +}ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">many1</span>&lt;A&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;[<span class="type">A</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="comment">// å¤šåŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œç¬¬ä¸€ä¸ªå€¼å¿…é¡»æ»¡è¶³æ¡ä»¶</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, <span class="number">_</span>) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> results: [<span class="type">A</span>] = []</span><br><span class="line">        <span class="keyword">var</span> stream = input</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> (result, remainder) = x.parse(stream) &#123;</span><br><span class="line">            results.append(result)</span><br><span class="line">            stream = remainder</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (results, stream)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æ­£ç¡®çš„ <code>number</code> è§£æå™¨å°±å˜æˆï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">number</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;[<span class="type">Character</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> many1(digit())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ <code>number</code> è§£æå™¨å’Œ <code>spaces</code> è§£æå™¨é‡åˆ°äº†åŒæ ·çš„é—®é¢˜ï¼Œ<code>number</code> è§£æå™¨çš„ç»“æœåº”è¯¥æ˜¯ <code>Int</code>ï¼ˆæš‚ä¸è€ƒè™‘æµ®ç‚¹æ•°ï¼‰ï¼Œè€Œä¸æ˜¯ <code>[Character]</code>ã€‚è§£å†³æ–¹æ³•å¯ä»¥ç±»ä¼¼ <code>manyCharacter</code>ï¼Œä½†æ˜¯è¿™æ˜¾ç¤ºæ˜¯å¾ˆæœ‰é—®é¢˜çš„ï¼ŒæŠ½è±¡æŠ½è±¡æŠ½è±¡ï¼</p>
<p>ç¨‹åºå‘˜è¦æœ‰æŠ½è±¡æ€ç»´ï¼Œè¦å­¦ä¼šç”¨æ›´é«˜çš„å±‚æ¬¡çš„æ€ç»´å»çœ‹å¾…é—®é¢˜ï¼Œå‘ç°ä¸åŒé—®é¢˜çš„å…±åŒç‚¹ã€‚<code>[Character]</code> å¯ä»¥ç”¨ <code>String([Character])</code> å˜æˆä¸€ä¸ª <code>String</code>ã€‚å¯¹äº <code>digit</code> characterï¼ŒåŒæ ·çš„ä¹Ÿæ˜¯ç”¨ <code>String([Character])</code> æ‹æ‰ï¼Œç„¶åç”¨ <code>Int(String)</code> å¾—åˆ°ä¸€ä¸ª <code>number</code>ã€‚</p>
<p>ç»“åˆ Swift çš„ OOPï¼ˆé¢å‘åè®®ç¼–ç¨‹ï¼‰ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªåè®®ï¼Œæš‚ä¸”å«åš <code>Combinable</code> :D</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Combinable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">combine</span><span class="params">(<span class="number">_</span> xs: [Character])</span></span> -&gt; <span class="type">Self</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span>: <span class="title">Combinable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">combine</span><span class="params">(<span class="number">_</span> xs: [Character])</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Int</span>(<span class="type">String</span>(describing: xs))!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">String</span>: <span class="title">Combinable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">combine</span><span class="params">(<span class="number">_</span> xs: [Character])</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(describing: xs)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">many1</span>&lt;A: Combinable&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;Character&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, <span class="number">_</span>) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> results: [<span class="type">Character</span>] = []</span><br><span class="line">        <span class="keyword">var</span> stream = input</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> (result, remainder) = x.parse(stream) &#123;</span><br><span class="line">            results.append(result)</span><br><span class="line">            stream = remainder</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">A</span>.combine(results), stream)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°±å¯ä»¥å¾—åˆ°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">number</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> many1(digit())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">spaces</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> many1(space()) <span class="comment">// å¿½ç•¥ spaces å¯ä»¥ä¸ºç©ºçš„æƒ…å†µ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Š <code>skipSpaces</code> è¿˜å¯ä»¥ç”¨å¦å¤–ä¸€ä¸ªè§’åº¦æ¥æ‹†åˆ†ï¼Œä¸Šé¢å…ˆè§£æ <em>many</em> ä¸ªç©ºæ ¼ï¼Œç„¶åä¸€æ¬¡ <em>skip</em> æ‰ã€‚è¿˜å¯ä»¥æ¯æ¬¡ <em>skip</em> ä¸€ä¸ªç©ºæ ¼ï¼Œç„¶åè¿›è¡Œ <em>many</em> æ¬¡ã€‚ä¸åŒçš„åœ°æ–¹æ˜¯ <code>skip</code> å’Œ <code>many</code> ä¸¤ä¸ª parser çš„è°ƒç”¨æ¬¡åºä¸ä¸€æ ·ï¼Œç”šè‡³è¿˜å¯ä»¥å®šä¹‰ä¸€ä¸ªå«åš <code>skipMany</code> çš„è§£æå™¨ï¼Œè¿™ä¹Ÿè¯´æ˜äº† <strong>Combinator</strong> çš„å¼ºå¤§ã€‚é€šè¿‡å®šä¹‰ä¸€ç³»åˆ—åŸºç¡€çš„ parserï¼Œè¿›è¡Œä¸åŒçš„æ’åˆ—ç»„åˆæ“ä½œï¼Œæœ€åè¦†ç›–æ‰€æœ‰çš„ caseã€‚ï¼ˆç†æƒ³çŠ¶æ€</p>
<h4 id="Zip"><a href="#Zip" class="headerlink" title="Zip"></a>Zip</h4><p>åˆå¹¶ä¸¤ä¸ª parser çš„è§£æå™¨ <code>zip</code> çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">zip</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> y: Parser&lt;B&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;(<span class="type">A</span>, <span class="type">B</span>)&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result1, remainder1) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result2, remainder2) = y.parse(remainder1) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ((result1, result2), remainder2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Choice"><a href="#Choice" class="headerlink" title="Choice"></a>Choice</h4><p>æ¥ä¸‹æ¥è¿˜éœ€è¦è§£æå‡ ä¸ªç®€å•çš„ä¸€å…ƒè¿ç®—ç¬¦ <code>+</code> <code>-</code> <code>*</code> <code>/</code>ã€‚å»æ‰ç©ºæ ¼åï¼Œä¸¤ä¸ªæ•°ä¸­é—´å¿…é¡»æ˜¯å…¶ä¸­ä¸€ä¸ªè¿ç®—ç¬¦é‚£ä¹ˆè¡¨è¾¾å¼å°±æ˜¯åˆæ³•çš„ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">opt</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Character</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> opts = [<span class="string">"+"</span>, <span class="string">"-"</span>, <span class="string">"*"</span>, <span class="string">"/"</span>].<span class="built_in">map</span> &#123; character($<span class="number">0</span>.characters.first!) &#125;</span><br><span class="line">    <span class="keyword">return</span> choice(opts)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¹Ÿå¯ä»¥å« one(of:)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">choice</span>&lt;A, S: Sequence&gt;<span class="params">(<span class="number">_</span> xs: S)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; <span class="keyword">where</span> <span class="type">S</span>.<span class="type">Iterator</span>.<span class="type">Element</span> == <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> xs.<span class="built_in">reduce</span>(empty(), &#123; $<span class="number">0</span> &lt;|&gt; $<span class="number">1</span> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">empty</span>&lt;A&gt;<span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="literal">nil</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h2><p>ä¸Šé¢åˆ©ç”¨ Protocol å®ç°çš„ <code>number</code> å’Œ <code>space</code> è§£æå™¨å…¶å®å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè´¹äº†å¾ˆå¤§åŠ²æŠŠ <code>many</code> å˜å¾— <del>é€šç”¨</del>ï¼Œç»“æœå´å¹¶ä¸æ˜¯å¾ˆ <strong>é€šç”¨</strong>ï¼Œå› ä¸ºè¦æ±‚ç»“æœçš„ç±»å‹å¿…é¡»å®ç° <code>Combinable</code> åè®®ã€‚ä½†å®ƒåšçš„å·¥ä½œå´å¾ˆå°‘ï¼Œåªæ˜¯æŠŠä¼ å…¥çš„ <code>Parser&lt;A&gt;</code> å¾ªç¯è§£æå¾—åˆ°çš„ç»“æœ <code>[A]</code> åœ¨ <code>many</code> <strong>å†…éƒ¨</strong> ç»„åˆæˆæœ€ç»ˆçš„ç±»å‹ï¼Œå®ç°æŠŠ <code>Parser&lt;[A]</code> è½¬æ¢ä¸º <code>Parser&lt;B&gt;</code>ã€‚æ­£ç”±äºå®ƒæ˜¯åœ¨ <code>many</code> å†…éƒ¨åšçš„æ“ä½œï¼Œæ‰€ä»¥ä¾èµ–äºä¼ å…¥çš„ç±»å‹ï¼Œä½¿å¾— <code>many</code> ä¸å†é‚£ä¹ˆé€šç”¨ã€‚</p>
<p>å†çœ‹ <code>func character(_ character: Character) -&gt; Parser&lt;Character&gt;</code> çš„å®šä¹‰ï¼Œå‡å¦‚è°ƒç”¨ <code>character(&quot;4&quot;)</code>ï¼Œé‚£ä¹ˆè¿”å›çš„æ˜¯ä¸€ä¸ª <code>Parser&lt;Character&gt;</code> ç±»å‹çš„è§£æå™¨ï¼Œè¿™ä¸ªè§£æå™¨è°ƒç”¨ <code>parse</code> æ–¹æ³•ï¼Œè¿”å›çš„ç»“æœæ˜¯ <code>Character</code> ç±»å‹çš„å€¼ã€‚åœ¨è§£æè¡¨è¾¾å¼ <code>4 + 3</code> çš„æ—¶å€™ï¼Œéœ€è¦å°†è§£æåˆ°çš„ <code>4</code> å’Œ <code>3</code> å½“ä½œä¸€ä¸ªæ•´æ•°ç„¶åç›¸åŠ ï¼Œæ‰èƒ½å¾—åˆ°æœ€ç»ˆçš„ç»“æœï¼Œæ‰€ä»¥ä¸æƒ³è¦ <code>Character</code> ç±»å‹çš„å€¼ï¼Œè€Œæ˜¯æƒ³è¦ <code>Int</code> ç±»å‹çš„å€¼ï¼Œé‚£ä¹ˆéœ€è¦å°† <code>Parser&lt;Character&gt;</code> è½¬æ¢ä¸º <code>Parser&lt;Int&gt;</code> è§£æå™¨ã€‚</p>
<p>æ‰€ä»¥ï¼Œå‡å¦‚èƒ½å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å°†ä»»æ„ <code>Parser&lt;A&gt;</code> è½¬æ¢ä¸º <code>Parser&lt;B&gt;</code> è§£æå™¨ï¼Œå°±å®Œç¾äº†ã€‚<code>many</code> åªè´Ÿè´£å°† <code>Parser&lt;A&gt;</code> è§£æå¾—åˆ° <code>Parser&lt;[A]&gt;</code>ï¼Œç„¶åç”± <code>number</code> è‡ªå·±å°† <code>Parser&lt;[A]&gt;</code> è½¬æ¢ä¸º <code>Parser&lt;Int&gt;</code>ã€‚</p>
<h3 id="Functor"><a href="#Functor" class="headerlink" title="Functor"></a>Functor</h3><p>å›å¿† Swift ä¸­ Optional ç±»å‹ä¸­çš„ map æ–¹æ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a: <span class="type">Optional</span>&lt;<span class="type">Int</span>&gt; = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> b: <span class="type">Optional</span>&lt;<span class="type">String</span>&gt; = a.<span class="built_in">map</span> &#123; <span class="type">String</span>($<span class="number">0</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒå°†ä¸€ä¸ª <code>Optional&lt;Int&gt;</code> è½¬æ¢ä¸º <code>Optional&lt;String&gt;</code>ï¼Œä»”ç»†ä¸€çœ‹ï¼ŒæŠŠ <code>Optional</code> æ¢æˆ <code>Parser</code>ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„è½¬æ¢è§£æå™¨çš„æ–¹æ³•ã€‚</p>
<p><code>Optional</code> çš„å‡½æ•°ç­¾åæ˜¯ <code>func map&lt;U&gt;(_ transform: (Wrapped) -&gt; U) -&gt; U?</code>ï¼Œæ‰€ä»¥ä¾è‘«èŠ¦ç”»ç“¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Parser</span>&lt;<span class="title">A</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">map</span>&lt;B&gt;<span class="params">(<span class="number">_</span> transform: <span class="params">(A)</span></span></span> -&gt; <span class="type">B</span>) -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> (result, remainder) = <span class="keyword">self</span>.parse(input) <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">            <span class="keyword">return</span> (transform(result), remainder)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åƒä¸Šé¢çš„ <code>satisfy</code> å’Œå…¶ä»–å‡½æ•°ä¸€æ ·ï¼ŒæŠŠ <code>map</code> æ–¹æ³•ä»ç»“æ„å›¾å†…ç§»å‡ºæ¥ï¼Œåˆ™å¾—åˆ°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">map</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> f: @escaping <span class="params">(A)</span></span></span> -&gt; <span class="type">B</span>) -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result, remainder) = x.parse(input)<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (f(result), remainder)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºå€¼æ˜¯åœ¨ <code>Parser</code> ä¸­åŒ…è£¹ç€çš„ï¼Œæƒ³æŠŠè¿”å›çš„ <code>Parser&lt;Character</code> å˜æˆ <code>Parser&lt;Int&gt;</code>ï¼Œéœ€è¦æŠŠ <code>Parser&lt;Character&gt;</code> è§£å¼€å–å‡ºé‡Œé¢<character>çš„å€¼ï¼Œç„¶åæŠŠå®ƒå˜æˆ<int>ç±»å‹ï¼Œç„¶åé‡ç°åŒ…è£…èµ·æ¥ã€‚å¯¹äºä¸åŒçš„ç±»å‹è½¬æ¢ï¼Œè§£åŒ…é‡æ–°åŒ…è£…çš„æ­¥éª¤æ˜¯ä¸€æ ·çš„ï¼Œä¸åŒçš„åœ°æ–¹æ˜¯æŠŠç»“æœä»ä¸€ç§ç±»å‹å˜æˆå¦ä¸€ç§ç±»å‹ï¼Œå‡½æ•°çš„ä½œç”¨å°±æ˜¯æŠŠç›¸åŒçš„å°è£…èµ·æ¥ï¼ŒæŠŠä¸åŒåšä¸ºå‚èµ›ä¼ è¿›å»ï¼Œæ‰€ä»¥åœ¨ <code>map</code> å‡½æ•°çš„å®ç°ä¸­ï¼Œåªéœ€è¦åœ¨è¿”å›å‰ï¼Œç»™å¤–éƒ¨å°†è¿™ä¸ªç»“æœè¿›è¡Œä¸€æ¬¡è½¬æ¢æœºä¼šï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå‚èµ›ï¼Œèƒ½å¤Ÿå°†è§£å¼€åå¾—åˆ°çš„å€¼å˜æˆå¦ä¸€ç§ç±»å‹çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æä¾›ä¸€ä¸ªå‡½æ•° <code>(Character) -&gt; Int</code>ã€‚</int></character></p>
<p>é‡æ–°å®ç° <code>number</code> å’Œ <code>spaces</code>ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">number</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">map</span>(many1(digit()), &#123; <span class="type">Int</span>(<span class="type">String</span>($<span class="number">0</span>))! &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">spaces</span><span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">map</span>(many(space()), &#123; <span class="type">String</span>($<span class="number">0</span>) &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸¤ç§ä¸åŒçš„ç»“æ„ä½“ <code>Optional&lt;T&gt;</code> å’Œ <code>Parser&lt;A&gt;</code>ï¼Œéƒ½å¯ä»¥ç»™å®ƒå®ç°ä¸€ä¸ª <code>map</code> æ–¹æ³•ï¼Œä½¿å¾—å®ƒå˜æˆä¸€ä¸ªä¸åŒç±»å‹çš„ç»“æ„ä½“ã€‚è€Œæ”¯æŒè¿™ç§ <code>map</code> æ–¹æ³•çš„ç»“æ„ä½“ï¼Œæˆ‘ä»¬ç§°æŠŠå®ƒä¸º <code>Functor</code>ã€‚</p>
<blockquote>
<p>ç®€å•æ¥è¯´ï¼Œæ‰€è°“çš„ <code>Functor</code> å°±æ˜¯å¯ä»¥æŠŠä¸€ä¸ªå‡½æ•°åº”ç”¨äºä¸€ä¸ª <strong>å°è£…è¿‡çš„å€¼</strong> ä¸Šï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ <strong>å°è£…è¿‡çš„å€¼</strong></p>
</blockquote>
<p><code>Functor</code> æœ€æ—©å‡ºè‡ªäºä»£æ•°æ‹“æ‰‘ï¼Œè¿™é‡Œè¯´çš„ <code>Functor</code> ä¸€èˆ¬æ˜¯æŒ‡èŒƒç•´è®ºï¼ˆCategory Theoryï¼‰ä¸­çš„ <code>Functor</code>ï¼Œå®ƒè¢«ç”¨æ¥æè¿°å„ç§èŒƒç•´é—´çš„å…³ç³»ã€‚æ›´å¤š Functor çš„ç†è§£ <a href="http://blessingsoft.com/2017/06/12/group-theory-and-category-theory/">Group Theory and Category Theory</a>ã€‚</p>
<h3 id="Applicative"><a href="#Applicative" class="headerlink" title="Applicative"></a>Applicative</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pure</span>&lt;A&gt;<span class="params">(<span class="number">_</span> x: A)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123; (x, $<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå‰é¢çš„ <code>pure</code> å’Œ <code>discarding</code> å‡½æ•°å°±æ˜¯ä¸€ç§ Applicativeã€‚åƒ <code>discarding</code> ä¸€æ ·æœ‰æ—¶å€™åªå…³å¿ƒè¿™äº›è¦è§£æé“å­—ç¬¦å­˜åœ¨å°±è¡Œäº†ï¼Œä¸Šé¢å®šä¹‰çš„ <code>discarding</code> è§£æå™¨ä½œç”¨æ˜¯å¿½ç•¥ç¬¬ä¸€ä¸ª parser å‚æ•°çš„è§£æç»“æœï¼ŒåŒæ ·åœ°ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªå¿½ç•¥ç¬¬äºŒä¸ª parser å‚æ•°çš„è§£æå™¨ã€‚æ¯”å¦‚å½“è§£æå‡ºç°åœ¨å³è¾¹çš„ symbol çš„æ—¶å€™å°±å¾ˆæœ‰ç”¨ï¼Œ<code>discarding2(parser, string(&quot;)&quot;))</code> çš„ä½œç”¨å°±æ˜¯ç¡®ä¿å­˜åœ¨é—­åˆçš„å³æ‹¬å· â€œ)â€ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// åƒæ‰å³è¾¹çš„ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">discarding2</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> y: Parser&lt;B&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result1, remainder1) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder2) = y.parse(remainder1) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åªä¿ç•™å·¦è¾¹çš„è§£æå™¨çš„ç»“æœ result1ï¼Œæ²¡æœ‰ result2</span></span><br><span class="line">        <span class="keyword">return</span> (result1, remainder2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// åƒæ‰å·¦è¾¹çš„ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">discarding1</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> y: Parser&lt;B&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (<span class="number">_</span>, remainder1) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result2, remainder2) = y.parse(remainder1) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åªä¿ç•™å³è¾¹çš„è§£æå™¨çš„ç»“æœ result2ï¼Œæ²¡æœ‰ result1</span></span><br><span class="line">        <span class="keyword">return</span> (result2, remainder2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ª <code>discarding</code> å‡½æ•°é•¿çš„å¾ˆåƒï¼Œå¦‚æœæœ‰åŠæ³•æŠŠå®ƒä»¬æŠ½è±¡ä¸€ä¸‹ï¼ŒæŠŠç›¸ä¼¼çš„åœ°æ–¹æå–å‡ºæ¥å°±å¥½äº†ã€‚</p>
<p>å¯¹äºä¸¤ä¸ªç»“æœï¼Œå¿½ç•¥å…¶ä¸­ä¸€ä¸ªï¼Œå®é™…ä¸Šå¾ˆç®€å•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// å¿½ç•¥ B</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> a: A, <span class="number">_</span> b: B)</span></span> -&gt; <span class="type">A</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// å¿½ç•¥ A</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> a: A, <span class="number">_</span> b: B)</span></span> -&gt; <span class="type">B</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// åƒæ‰å·¦è¾¹çš„ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">left</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> y: Parser&lt;B&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">discarding</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> a: A, <span class="number">_</span> b: B)</span></span> -&gt; <span class="type">A</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> b</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result1, remainder1) = x.parse(input) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result2, remainder2) = y.parse(remainder1) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (discarding(result1, result2), remainder2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åè¿™ä¸ªå‡½æ•°å¹¶æ²¡æœ‰åµç”¨ã€‚</p>
<h3 id="Monad"><a href="#Monad" class="headerlink" title="Monad"></a>Monad</h3><p>è§‚çœ‹ <code>map</code> å‡½æ•° <code>func map&lt;A, B&gt;(_ x: Parser&lt;A&gt;, _ f: (A) -&gt; B) -&gt; Parser&lt;B&gt;</code></p>
<p>å®ƒè¦æ±‚ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ <code>Parser&lt;A&gt;</code>ï¼Œä¸€ä¸ªæ˜¯å‡½æ•° <code>A -&gt; B</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯¹æ ‡é¢˜ä¸­çš„ <strong>Combinator</strong> å¹¶ä¸æ˜¯å¾ˆå‹å¥½ï¼Œ<strong>Parser Combinator</strong> çš„æ€æƒ³æ˜¯ç»„åˆä¸€ç³»åˆ—çš„ <code>Parser</code> å¾—åˆ°ç»“æœã€‚ä¸Šé¢å®šä¹‰äº†æœ‰å¾ˆå¤šå°çš„ parserï¼Œæ¯”å¦‚ <code>func string(_ str: String) -&gt; Parser&lt;String&gt;</code>ï¼Œå‡½æ•°ç­¾åæ˜¯ <code>(String) -&gt; Parser&lt;String&gt;</code>ï¼Œç”±äº <code>map</code> å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°çš„ç­¾åæ˜¯ <code>(A) -&gt; B</code>ï¼Œè€Œé <code>(A) -&gt; Parser&lt;B&gt;</code>ï¼Œæ‰€ä»¥å‡å¦‚å­˜åœ¨ä¸€ä¸ªä¸ <code>map</code> åŠŸèƒ½ç›¸ä¼¼ï¼Œä½†ç¬¬äºŒä¸ªå‚æ•°çš„ç­¾åæ˜¯ <code>(A) -&gt; Parser&lt;B&gt;</code>ï¼Œåˆ™èƒ½å¤Ÿä½¿å¾—ä¹‹å‰å®šä¹‰çš„å¾ˆå¤šå°çš„ <code>parser</code> èƒ½å¤Ÿç›´æ¥ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œç›´æ¥å¾—åˆ°ä¸€ä¸ªæ–°ç±»å‹çš„ <code>Parser</code>ï¼Œå¤§æ¦‚è¿™æ ·ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">flatMap</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> f: <span class="params">(A)</span></span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt;) -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨çš„æ—¶å€™ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> parser = flatMap(stringParser, string(<span class="string">"alex"</span>))</span><br></pre></td></tr></table></figure>
<p>å…·ä½“å®ç°ä¸ <code>map</code> ä¹Ÿå¾ˆåƒï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">flatMap</span>&lt;A, B&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> f: @escaping <span class="params">(A)</span></span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt;) -&gt; <span class="type">Parser</span>&lt;<span class="type">B</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> (result, remainder) = x.parse(input)<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> f(result).parse(remainder)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://blessingsoft.com/2017/06/12/group-theory-and-category-theory/">Group Theory and Category Theory</a></p>
<h3 id="Alternative"><a href="#Alternative" class="headerlink" title="Alternative"></a>Alternative</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">empty</span>&lt;A&gt;<span class="params">()</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="literal">nil</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">choice</span>&lt;A&gt;<span class="params">(<span class="number">_</span> x: Parser&lt;A&gt;, <span class="number">_</span> y: Parser&lt;A&gt;)</span></span> -&gt; <span class="type">Parser</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Parser</span> &#123; input <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> x.parse(input) ?? y.parse(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Alternative ç±»ä¼¼äº <code>Swift Standard Library</code> ä¸­å®šä¹‰çš„è¿ç®—ç¬¦ <code>??</code>ï¼Œå®ƒæœ‰ä¸¤ä¸ªåŒç±»å‹çš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åçˆ±çš„ <code>parser</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é»˜è®¤çš„ <code>parser</code>ã€‚å®ƒé¦–å…ˆå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ª <code>parser</code> æ¥è¿›è¡Œè§£æï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¿”å›ã€‚å¦‚æœä¸æˆåŠŸï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ <code>parser</code> è¿›è¡Œè§£æã€‚å®ƒçš„è¿”å›å€¼ç±»å‹ä¹Ÿæ˜¯åŒç±»å‹çš„ <code>Parser</code>ã€‚</p>
<p>ä½œç”¨æ˜¯å‡å¦‚æœ‰ Int, String, Bool ä¸‰ä¸ªç±»å‹çš„ <code>parser</code>ï¼Œè€Œä¸€ä¸ª scalar ç±»å‹çš„ <code>parser</code> åªè¦èƒ½å¤Ÿè§£æ Int, String, Bool ä»»æ„ä¸€ç§ç±»å‹ï¼Œåˆ™ç®—è§£ææˆåŠŸã€‚æ¢å¥è¯è¯´å°±æ˜¯ scalar æ˜¯ Int, String, Bool çš„çˆ¶é›†ã€‚ä¸€ç§ç®€å•çš„ä» <code>Parser&lt;Int&gt;</code>, <code>Parser&lt;String&gt;</code>, <code>Parser&lt;Bool&gt;</code> ä¸‰ç§å·²æœ‰å®ç°çš„ parser å¾—åˆ° <code>Parser&lt;Scalar&gt;</code> çš„æ–¹æ³•æ˜¯é€ä¸ªè¿›è¡Œ parseï¼Œå¦‚æœæˆåŠŸåˆ™é©¬ä¸Šè¿”å›ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> scalar = parserInt &lt;|&gt; parserString &lt;|&gt; parserBool</span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªä¾‹å­çœ‹æœ‰ç‚¹ one of çš„æ„æ€ï¼Œä½†å®é™…ä¸Šæ›´åŠ å‡†ç¡®çš„è¯´æ³•æ˜¯ choiceã€‚</p>
<h3 id="Applicative-amp-Monad"><a href="#Applicative-amp-Monad" class="headerlink" title="Applicative &amp; Monad"></a>Applicative &amp; Monad</h3><p>Applicative å’Œ Monad çš„åŒºåˆ«åœ¨äºï¼š</p>
<p>Applicative çš„ä¸¤ä¸ª parser æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œç»„åˆåçš„æ–° parser æ˜¯å¯ä»¥é™æ€åˆ†æå…¶è¡Œä¸ºçš„ã€‚è€Œå¯¹äº Monadï¼Œåœ¨ä¸çŸ¥é“è¾“å…¥çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸èƒ½ç¡®å®šå…¶è¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯è¯´ Monad æ˜¯ä¾èµ–äºè®¡ç®—ç»“æœã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alex</span><span class="params">(<span class="number">_</span> x: Parser&lt;String&gt;)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> (<span class="number">_</span>, <span class="number">_</span>) = x.parse(<span class="string">"alex.huo"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> af: <span class="type">Parser</span>&lt;(<span class="type">String</span>) -&gt; <span class="type">String</span>&gt; = pure(id)</span><br><span class="line"><span class="keyword">let</span> ax = string(<span class="string">"alex"</span>)</span><br><span class="line">alex(af &lt;*&gt; ax) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mf: (<span class="type">String</span>) -&gt; <span class="type">Parser</span>&lt;<span class="type">String</span>&gt; = &#123; string($<span class="number">0</span>) &#125;</span><br><span class="line"><span class="keyword">let</span> mx = string(<span class="string">"alex"</span>)</span><br><span class="line">alex(mx &gt;&gt;- mf) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://github.com/hlian/jiffy" target="_blank" rel="noopener">Jiffy</a><br><a href="https://news.realm.io/news/tryswift-yasuhiro-inami-parser-combinator/" target="_blank" rel="noopener">Parser combinators</a><br><a href="http://www.cs.nott.ac.uk/~pszgmh/monparsing.pdf" target="_blank" rel="noopener">Monadic Parser Combinators</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://blessingsoft.com/2017/05/20/cherry-blessing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xspyhack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cherry Blessing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/20/cherry-blessing/" itemprop="url">Cherry Blessing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-05-20T20:00:00+08:00">
                2017-05-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to Cherry Blessing.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Xspyhack">
          <p class="site-author-name" itemprop="name">Xspyhack</p>
           
              <p class="site-description motion-element" itemprop="description">Why join the navy if you can be a pirate?</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xspyhack</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
